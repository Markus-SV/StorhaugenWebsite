@using MudBlazor
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@inject IActivityFeedService FeedService
@inject IUserColorService UserColorService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<div class="activity-feed">
    <XFade IsLoading="@_isLoading" FirstLoadOnly="true" FadeMs="220">
        <Skeleton>
            <RecipeSkeleton Amount="5" Height="84px" DisableImage LineAmount="0" />
        </Skeleton>
        <ChildContent>

            @if (!_feedItems.Any())
            {
                <div class="empty-state">
                    <MudIcon Icon="@Icons.Material.Rounded.RssFeed" Size="Size.Large" Color="Color.Default" />
                    <MudText Typo="Typo.h6" Class="mt-2">Ingen aktivitet ennå</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Legg til venner for å se hva de lager!
                    </MudText>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="friends" Class="mt-3">
                        Finn venner
                    </MudButton>
                </div>
            }
            else
            {
                <div class="d-flex flex-column gap-3">
                    @foreach (var item in _feedItems)
                    {
                        <MudPaper Class="@(IsItemClickable(item) ? "activity-card" : "activity-card non-clickable")"
                                  Elevation="0"
                                  @onclick="() => NavigateToRecipe(item)">

                            @if (!string.IsNullOrEmpty(item.RecipeImageUrl))
                            {
                                <div class="activity-image-layer">
                                    <img src="@item.RecipeImageUrl" alt="@item.RecipeName" loading="lazy" />
                                </div>
                            }

                            <div class="activity-content-layer">
                                <div class="d-flex gap-3 align-start">
                                    <MudAvatar Size="Size.Medium" Variant="Variant.Filled" Class="flex-shrink-0"
                                               Style="@($"background-color: {UserColorService.GetUserColor(item.UserDisplayName)}; color: white;")">
                                        @(item.UserDisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>

                                    <div class="activity-text-container">
                                        <div class="d-flex align-center gap-2 flex-wrap mb-0">
                                            <MudText Typo="Typo.body2" Class="font-weight-bold user-name-text">
                                                @item.UserDisplayName
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="time-text">
                                                @GetTimeAgo(item.CreatedAt)
                                            </MudText>
                                        </div>

                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="action-text mb-1 d-block">
                                            @GetActivityDescription(item)
                                        </MudText>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(item.RecipeName))
                                {
                                    <div class="recipe-row">
                                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" Class="recipe-icon" />
                                        <span class="recipe-name text-truncate">@item.RecipeName</span>
                                        @if (item.RatingScore.HasValue)
                                        {
                                            <span class="rating-dot" style="background-color: @GetRatingColorHex(item.RatingScore.Value)"></span>
                                            <span class="rating-val">@item.RatingScore.Value.ToString("0.0")</span>
                                        }
                                    </div>
                                }
                            </div>
                        </MudPaper>
                    }
                </div>

                @if (_hasMorePages)
                {
                    <div class="d-flex justify-center mt-4">
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="LoadMore" Disabled="_isLoadingMore">
                            @if (_isLoadingMore)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Last inn mer
                        </MudButton>
                    </div>
                }
            }
        </ChildContent>
    </XFade>
</div>

<style>
    .user-name-text { font-size: 0.95rem; line-height: 1.2; }
    .time-text { font-size: 0.75rem; opacity: 0.8; }
    .action-text { font-size: 0.8rem; line-height: 1.2; }

    .recipe-row { display:flex; align-items:center; gap:6px; margin-top:8px; color: var(--mud-palette-text-primary); }
    .recipe-icon { font-size:14px; opacity:0.7; flex-shrink:0; }
    .recipe-name { font-weight:600; font-size:0.9rem; }
    .text-truncate { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .rating-dot { width:6px; height:6px; border-radius:50%; margin-left:2px; flex-shrink:0; }
    .rating-val { font-weight:700; font-size:0.8rem; flex-shrink:0; }

    .activity-text-container { flex:1; min-width:0; }
    .activity-content-layer { position:relative; padding:12px 16px; background: linear-gradient(to right, var(--mud-palette-surface) 60%, transparent 100%); }
</style>

@code {
    [Parameter] public bool ShowOnlyMyActivity { get; set; } = false;
    [Parameter] public int PageSize { get; set; } = 20;

    private readonly List<ActivityFeedItemDto> _feedItems = new();
    private bool _isLoading = true;

    private bool _isLoadingMore;
    private bool _hasMorePages;
    private int _currentPage = 1;

    private int _loadVersion;

    protected override Task OnInitializedAsync() => ReloadFeed(resetPage: true);

    private async Task ReloadFeed(bool resetPage)
    {
        var v = ++_loadVersion;

        if (resetPage)
            _currentPage = 1;

        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            ActivityFeedPagedResult result =
                ShowOnlyMyActivity
                    ? await FeedService.GetMyActivityAsync(_currentPage, PageSize)
                    : await FeedService.GetFeedAsync(new ActivityFeedQuery { Page = _currentPage, PageSize = PageSize });

            if (v != _loadVersion) return;

            _feedItems.Clear();
            _feedItems.AddRange(DeduplicateRatings(result.Items));
            _hasMorePages = result.HasMore;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke laste aktivitetsfeed: {ex.Message}", Severity.Error);
        }
        finally
        {
            if (v == _loadVersion)
            {
                _isLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task LoadMore()
    {
        if (_isLoadingMore) return;

        _isLoadingMore = true;
        _currentPage++;
        StateHasChanged();

        try
        {
            ActivityFeedPagedResult result =
                ShowOnlyMyActivity
                    ? await FeedService.GetMyActivityAsync(_currentPage, PageSize)
                    : await FeedService.GetFeedAsync(new ActivityFeedQuery { Page = _currentPage, PageSize = PageSize });

            _feedItems.AddRange(result.Items);
            var deduped = DeduplicateRatings(_feedItems.ToList());

            _feedItems.Clear();
            _feedItems.AddRange(deduped);

            _hasMorePages = result.HasMore;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke laste mer: {ex.Message}", Severity.Error);
            _currentPage--;
        }
        finally
        {
            _isLoadingMore = false;
            StateHasChanged();
        }
    }

    private bool IsItemClickable(ActivityFeedItemDto item) => item.TargetType == "global_recipe";

    private void NavigateToRecipe(ActivityFeedItemDto item)
    {
        if (item.TargetType == "global_recipe")
            Navigation.NavigateTo($"browse/{item.TargetId}");
        else
            Snackbar.Add("Oppskriften er ikke tilgjengelig for visning", Severity.Info);
    }

    private string GetRatingColorHex(decimal rating) => rating switch
    {
        >= 8m => "#2D5A45",
        >= 5m => "#D4A017",
        _ => "#C44536"
    };

    private string GetActivityDescription(ActivityFeedItemDto item) => item.ActivityType switch
    {
        "rated" => "ga en vurdering",
        "added" => "la til en ny oppskrift",
        "published" => "publiserte en oppskrift",
        "joined_collection" => "ble med i en samling",
        "friend_added" => $"ble venn med {item.UserDisplayName}",
        _ => item.ActivityType
    };

    private string GetTimeAgo(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalMinutes < 1) return "akkurat nå";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}t";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d";
        return dateTime.ToString("dd.MM");
    }

    private List<ActivityFeedItemDto> DeduplicateRatings(List<ActivityFeedItemDto> items)
    {
        var result = new List<ActivityFeedItemDto>();
        var seen = new HashSet<string>();

        foreach (var item in items)
        {
            if (item.ActivityType == "rated")
            {
                var key = $"{item.UserId}_{item.TargetId}";
                if (seen.Add(key)) result.Add(item);
            }
            else
            {
                result.Add(item);
            }
        }

        return result;
    }
}
