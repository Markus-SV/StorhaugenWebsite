@*
    Dialog for inviting members to a collection.
*@
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using System.ComponentModel.DataAnnotations
@inject IApiClient ApiClient
@inject IUserFriendshipService FriendshipService
@inject IUserColorService UserColorService
@inject ISnackbar Snackbar

<MudDialog Class="invite-dialog">
    <DialogContent>
        <MudStack Spacing="2">
            <div>
                <MudText Typo="Typo.h6">Inviter medlem til @CollectionName</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Velg en venn eller søk etter brukere.
                </MudText>
            </div>

            @* Search *@
            <MudTextField @bind-Value="_searchQuery"
                          Placeholder="Søk etter navn, e-post eller ID..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Rounded.Search"
                          Immediate="true"
                          DebounceInterval="400"
                          OnDebounceIntervalElapsed="PerformSearch"
                          Margin="Margin.Dense"
                          Clearable="true"
                          OnClearButtonClick="@ClearSearch" />

            @if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Resultater</MudText>

                @if (_isSearching)
                {
                    <div class="d-flex justify-center py-2">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    </div>
                }
                else if (_searchResults.Any())
                {
                    <MudStack Spacing="1">
                        @foreach (var user in _searchResults)
                        {
                            <MudPaper Class="pa-3 friend-card" Elevation="0" Outlined="true">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Size="Size.Medium"
                                               Style="@($"background-color: {UserColorService.GetUserColor(user.DisplayName)}; color: white;")">
                                        @(user.DisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>

                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body1" Style="font-weight:600;">@user.DisplayName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @user.ShareId</MudText>
                                    </div>

                                    <MudIconButton Icon="@Icons.Material.Rounded.PersonAdd"
                                                   Color="Color.Primary"
                                                   Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   Disabled="@(_isSending || _invitingIds.Contains(user.Id))"
                                                   OnClick="@(() => InviteUser(user.Id, user.DisplayName))" />
                                </div>
                            </MudPaper>
                        }
                    </MudStack>
                }
                else
                {
                    <div class="empty-state">
                        <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" Color="Color.Default" />
                        <MudText Typo="Typo.body1" Class="mt-2">Ingen brukere funnet</MudText>
                    </div>
                }
            }
            else
            {
                @* Friends *@
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Venner</MudText>

                @if (_isLoadingFriends)
                {
                    <div class="d-flex justify-center py-2">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    </div>
                }
                else if (_friends.Any())
                {
                    <MudStack Spacing="1">
                        @foreach (var friend in _friends)
                        {
                            <MudPaper Class="pa-3 friend-card" Elevation="0" Outlined="true">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Size="Size.Medium"
                                               Style="@($"background-color: {UserColorService.GetUserColor(friend.FriendDisplayName)}; color: white;")">
                                        @(friend.FriendDisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>

                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body1" Style="font-weight:600;">@friend.FriendDisplayName</MudText>
                                    </div>

                                    <MudIconButton Icon="@Icons.Material.Rounded.PersonAdd"
                                                   Color="Color.Primary"
                                                   Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   Disabled="@(_isSending || _invitingIds.Contains(friend.FriendUserId))"
                                                   OnClick="@(() => InviteUser(friend.FriendUserId, friend.FriendDisplayName))" />
                                </div>
                            </MudPaper>
                        }
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-2">
                        Du har ingen venner å invitere (eller alle er allerede i samlingen).
                    </MudText>
                }

                <MudDivider Class="my-2" />

                @* Manual entry - no tabs *@
                <MudPaper Class="pa-3" Outlined="true" Elevation="0" Style="border-radius:12px;">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Inviter med e-post eller Dele-ID</MudText>

                    <MudSelect T="InviteMode"
                               Label="Type"
                               Dense="true"
                               Variant="Variant.Outlined"
                               Value="_inviteMode"
                               ValueChanged="OnInviteModeChanged">
                        <MudSelectItem Value="InviteMode.Email">E-post</MudSelectItem>
                        <MudSelectItem Value="InviteMode.ShareId">Dele-ID</MudSelectItem>
                    </MudSelect>

                    <MudTextField Class="mt-2"
                                  @bind-Value="_manualIdentifier"
                                  Label="@(_inviteMode == InviteMode.Email ? "E-postadresse" : "Dele-ID")"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Immediate="true"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@(_inviteMode == InviteMode.Email ? Icons.Material.Rounded.Email : Icons.Material.Rounded.Tag)"
                                  HelperText="@(_inviteMode == InviteMode.Email ? "f.eks. venn@example.com" : "f.eks. ABC123XYZ")"
                                  Style="@(_inviteMode == InviteMode.ShareId ? "text-transform:uppercase; font-family:monospace; letter-spacing:1px;" : null)" />

                    <MudButton Class="mt-3"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Disabled="@(_isSending || string.IsNullOrWhiteSpace(_manualIdentifier))"
                               OnClick="SendManualInvite">
                        @if (_isSending)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Sender...</span>
                        }
                        else
                        {
                            <span>Send invitasjon</span>
                        }
                    </MudButton>
                </MudPaper>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true" ShowCloseIcon="true"
                          CloseIconClicked="@(_ => _errorMessage = null)">
                    @_errorMessage
                </MudAlert>
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <MudAlert Severity="Severity.Success" Dense="true">
                    @_successMessage
                </MudAlert>
            }
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Close">Lukk</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .friend-card {
        border-radius: 12px;
    }

    /* Mobile: make dialog use screen height & allow content scroll */
    @@media (max-width: 600px) {
        .invite-dialog.mud-dialog {
            width: 100vw;
            max-width: 100vw;
            height: 100dvh;
            max-height: 100dvh;
            margin: 0;
            border-radius: 0;

        }

        .invite-dialog .mud-dialog-content {
            overflow-y: auto;
            max-height: calc(100dvh - 72px); /* leaves room for header/actions */
        }
    }
</style>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public Guid CollectionId { get; set; }
    [Parameter] public string CollectionName { get; set; } = "";
    [Parameter] public HashSet<Guid> ExistingMemberIds { get; set; } = new();

    private enum InviteMode { Email, ShareId }
    private InviteMode _inviteMode = InviteMode.Email;
    private string _manualIdentifier = "";

    private bool _didChange;

    private string? _errorMessage;
    private string? _successMessage;

    private string _searchQuery = "";
    private List<UserFriendshipDto> _friends = new();
    private List<UserSearchResultDto> _searchResults = new();
    private bool _isLoadingFriends = true;
    private bool _isSearching;
    private bool _isSending;

    private readonly HashSet<Guid> _invitingIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadFriends();
    }

    private void OnInviteModeChanged(InviteMode mode)
    {
        _inviteMode = mode;
        _manualIdentifier = "";
        _errorMessage = null;
        _successMessage = null;
    }

    private void ClearSearch()
    {
        _searchQuery = "";
        _searchResults.Clear();
        _errorMessage = null;
        _successMessage = null;
    }

    private async Task LoadFriends()
    {
        _isLoadingFriends = true;
        try
        {
            var friendships = await FriendshipService.GetFriendshipsAsync();
            _friends = (friendships.Friends ?? new())
                .Where(f => !ExistingMemberIds.Contains(f.FriendUserId))
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading friends: {ex.Message}");
        }
        finally
        {
            _isLoadingFriends = false;
        }
    }


    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            _searchResults.Clear();
            return;
        }

        _isSearching = true;
        StateHasChanged();

        try
        {
            var results = await FriendshipService.SearchUsersAsync(_searchQuery);

            _searchResults = (results ?? new())
                .Where(u => !ExistingMemberIds.Contains(u.Id))
                .ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Søk feilet: {ex.Message}";
        }
        finally
        {
            _isSearching = false;
            StateHasChanged();
        }
    }


    private async Task InviteUser(Guid userId, string? displayName)
    {
        if (ExistingMemberIds.Contains(userId) || _invitingIds.Contains(userId))
            return;

        _errorMessage = null;
        _successMessage = null;

        _invitingIds.Add(userId);
        _isSending = true;
        StateHasChanged();

        try
        {
            await ApiClient.AddCollectionMemberAsync(CollectionId, new AddCollectionMemberDto
            {
                UserIdentifier = userId.ToString()
            });

            ExistingMemberIds.Add(userId);
            _didChange = true;

            Snackbar.Add("Medlem lagt til!", Severity.Success);

            _friends.RemoveAll(f => f.FriendUserId == userId);
            _searchResults.RemoveAll(s => s.Id == userId);
        }
        catch (HttpRequestException ex)
        {
            _errorMessage =
                ex.StatusCode == System.Net.HttpStatusCode.BadRequest ? "Denne brukeren er allerede medlem av samlingen" :
                ex.StatusCode == System.Net.HttpStatusCode.NotFound ? "Bruker ikke funnet" :
                $"Kunne ikke legge til medlem: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"En uventet feil oppstod: {ex.Message}";
        }
        finally
        {
            _invitingIds.Remove(userId);
            _isSending = false;
            StateHasChanged();
        }
    }

    private async Task SendManualInvite()
    {
        _errorMessage = null;
        _successMessage = null;

        var raw = _manualIdentifier?.Trim();
        if (string.IsNullOrWhiteSpace(raw))
        {
            _errorMessage = "Feltet kan ikke være tomt.";
            return;
        }

        // Basic validation without MudTabs/MudForms
        if (_inviteMode == InviteMode.Email)
        {
            var emailAttr = new EmailAddressAttribute();
            if (!emailAttr.IsValid(raw))
            {
                _errorMessage = "Vennligst skriv inn en gyldig e-postadresse";
                return;
            }
        }
        else
        {
            raw = raw.ToUpperInvariant();
        }

        _isSending = true;
        StateHasChanged();

        try
        {
            await ApiClient.AddCollectionMemberAsync(CollectionId, new AddCollectionMemberDto
            {
                UserIdentifier = raw
            });

            _didChange = true;
            _successMessage = "Medlem lagt til!";
            Snackbar.Add("Medlem lagt til!", Severity.Success);

            _manualIdentifier = "";
        }
        catch (HttpRequestException ex)
        {
            _errorMessage =
                ex.StatusCode == System.Net.HttpStatusCode.BadRequest ? "Denne brukeren er allerede medlem av samlingen" :
                ex.StatusCode == System.Net.HttpStatusCode.NotFound ? (_inviteMode == InviteMode.ShareId ? "Bruker med denne Dele-ID ble ikke funnet" : "Samling ikke funnet") :
                $"Kunne ikke legge til medlem: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"En uventet feil oppstod: {ex.Message}";
        }
        finally
        {
            _isSending = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        MudDialog?.Close(_didChange); // returns bool in result.Data
    }
}
