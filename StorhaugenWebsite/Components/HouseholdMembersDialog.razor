@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.DTOs

@inject IApiClient ApiClient
@inject IAuthService AuthService
@inject IHouseholdStateService HouseholdState
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudDialog>
    <DialogContent>
        <div class="members-dialog">
            <div class="dialog-header">
                <MudText Typo="Typo.h6">@Household?.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @Household?.Members.Count member@(Household?.Members.Count != 1 ? "s" : "")
                </MudText>
            </div>

            @if (Household?.Members.Any() == true)
            {
                <div class="members-list">
                    @foreach (var member in Household.Members.OrderBy(m => m.UserId != Household.CreatedById).ThenBy(m => m.JoinedAt))
                    {
                        var isCreator = member.UserId == Household.CreatedById;
                        var isCurrentUser = member.Email == AuthService.CurrentUser?.Email;

                        <div class="member-card">
                            <div class="member-avatar" style="background: @GetMemberColor(member.DisplayName)">
                                @if (!string.IsNullOrEmpty(member.AvatarUrl))
                                {
                                    <img src="@member.AvatarUrl" alt="@member.DisplayName" />
                                }
                                else
                                {
                                    <span>@member.DisplayName.FirstOrDefault()</span>
                                }
                            </div>

                            <div class="member-info">
                                <div class="d-flex align-center gap-2">
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                        @member.DisplayName
                                    </MudText>
                                    @if (isCreator)
                                    {
                                        <MudChip Size="Size.Small" T=string Color="Color.Primary" Style="height: 20px;">Owner</MudChip>
                                    }
                                    @if (isCurrentUser)
                                    {
                                        <MudChip Size="Size.Small" T=string Color="Color.Secondary" Style="height: 20px;">You</MudChip>
                                    }
                                </div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Joined @member.JoinedAt.ToString("MMM dd, yyyy")
                                </MudText>
                            </div>
                        </div>
                    }
                </div>
            }

            @if (CanLeaveHousehold())
            {
                <div class="leave-section">
                    <MudDivider Class="my-3" />
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               OnClick="LeaveHousehold"
                               Disabled="_isLeaving"
                               FullWidth="true"
                               Style="border-style: dashed;">
                        @if (_isLeaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Leaving...</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.ExitToApp" Class="mr-2" Size="Size.Small" />
                            <span>Leave Household</span>
                        }
                    </MudButton>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2" Style="text-align: center;">
                        You'll lose access to all household recipes
                    </MudText>
                </div>
            }
        </div>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .members-dialog {
        padding: 8px 0;
        min-width: 400px;
    }

    .dialog-header {
        margin-bottom: 20px;
    }

    .members-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
        padding: 4px;
    }

    .member-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        background: var(--mud-palette-background-grey);
        transition: all 0.2s ease;
    }

        .member-card:hover {
            background: var(--mud-palette-action-default-hover);
        }

    .member-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
    }

        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .member-avatar span {
            text-transform: uppercase;
        }

    .member-info {
        flex: 1;
        min-width: 0;
    }

    .leave-section {
        margin-top: 16px;
    }
</style>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public HouseholdDto? Household { get; set; }

    private bool _isLeaving = false;

    private bool CanLeaveHousehold()
    {
        if (Household == null || AuthService.CurrentUser == null)
            return false;

        var currentMember = Household.Members.FirstOrDefault(m => m.Email == AuthService.CurrentUser.Email);
        if (currentMember == null)
            return false;

        // Can't leave if you're the creator and there are other members
        var isCreator = currentMember.UserId == Household.CreatedById;
        var hasOtherMembers = Household.Members.Count > 1;

        return !isCreator || !hasOtherMembers;
    }

    private async Task LeaveHousehold()
    {
        if (Household == null)
            return;

        Snackbar.Add($"Are you sure you want to leave {Household.Name}?",
            Severity.Warning,
            config =>
            {
                config.RequireInteraction = true;
                config.ShowCloseIcon = true;
                config.VisibleStateDuration = 10000;
            });

        // MudBlazor's Snackbar doesn't have confirmation dialogs built-in,
        // so we'll just proceed. In a production app, use MudDialog for confirmation.
        // For now, let's just proceed with the leave action.

        _isLeaving = true;
        StateHasChanged();

        try
        {
            await ApiClient.LeaveHouseholdAsync(Household.Id);

            Snackbar.Add($"Left {Household.Name} successfully", Severity.Success);

            // Refresh household state
            await HouseholdState.RefreshHouseholdsAsync();

            // Close dialog
            Close();

            // If no households left, might need to show household setup
            if (!HouseholdState.HasHousehold)
            {
                Navigation.NavigateTo("settings", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error leaving household: {ex.Message}");
            Snackbar.Add("Failed to leave household", Severity.Error);
        }
        finally
        {
            _isLeaving = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        MudDialog?.Close();
    }

    private string GetMemberColor(string displayName)
    {
        // Generate consistent color based on name hash
        var hash = displayName.GetHashCode();
        var colors = new[]
        {
            "#E07A2E", // Orange
            "#2D5A45", // Green
            "#4A7C9B", // Blue
            "#6B5D4D", // Brown
            "#9B4A7C", // Purple
            "#7C9B4A", // Lime
            "#4A5A9B", // Indigo
            "#9B6B4A"  // Rust
        };

        return colors[Math.Abs(hash) % colors.Length];
    }
}
