@using MudBlazor
@using StorhaugenWebsite.DTOs
@using StorhaugenWebsite.Services
@inject IUserRecipeService RecipeService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Rounded.Publish" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Publiser oppskrift</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        @if (_isPublishing)
        {
            <div class="d-flex flex-column align-center pa-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.body1" Class="mt-4">Publiserer oppskrift...</MudText>
            </div>
        }
        else if (_publishResult != null)
        {
            <div class="d-flex flex-column align-center pa-4">
                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-3">Publisert!</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2 text-center">
                    @_publishResult.Message
                </MudText>
            </div>
        }
        else
        {
            <MudText Typo="Typo.body1" Class="mb-4">
                Ved å publisere denne oppskriften blir den tilgjengelig for alle brukere i den globale oppskriftsdatabasen.
            </MudText>

            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                <MudText Typo="Typo.body2">
                    Din oppskrift vil fortsatt være lenket til den publiserte versjonen.
                    Du kan når som helst "koble fra" for å gjøre lokale endringer.
                </MudText>
            </MudAlert>

            @if (Recipe != null)
            {
                <MudPaper Class="pa-3" Elevation="1">
                    <div class="d-flex gap-3">
                        @if (Recipe.ImageUrls.Any())
                        {
                            <MudImage Src="@Recipe.ImageUrls.First()"
                                     Alt="@Recipe.Name"
                                     Width="80"
                                     Height="80"
                                     ObjectFit="ObjectFit.Cover"
                                     Class="rounded" />
                        }
                        <div>
                            <MudText Typo="Typo.subtitle1">@Recipe.Name</MudText>
                            @if (!string.IsNullOrEmpty(Recipe.Description))
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                                    @(Recipe.Description.Length > 100 ? Recipe.Description.Substring(0, 100) + "..." : Recipe.Description)
                                </MudText>
                            }
                        </div>
                    </div>
                </MudPaper>
            }
        }
    </DialogContent>
    <DialogActions>
        @if (_publishResult != null)
        {
            <MudButton OnClick="Close" Color="Color.Primary" Variant="Variant.Filled">
                Lukk
            </MudButton>
        }
        else if (!_isPublishing)
        {
            <MudButton OnClick="Cancel" Color="Color.Default">Avbryt</MudButton>
            <MudButton OnClick="Publish" Color="Color.Primary" Variant="Variant.Filled">
                Publiser
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public UserRecipeDto? Recipe { get; set; }

    private bool _isPublishing = false;
    private PublishRecipeResultDto? _publishResult;

    private async Task Publish()
    {
        if (Recipe == null) return;

        _isPublishing = true;
        StateHasChanged();

        try
        {
            _publishResult = await RecipeService.PublishRecipeAsync(Recipe.Id);
            Snackbar.Add("Oppskriften ble publisert!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke publisere: {ex.Message}", Severity.Error);
            _isPublishing = false;
        }

        StateHasChanged();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(_publishResult));
    }
}
