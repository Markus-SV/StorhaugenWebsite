@using Microsoft.AspNetCore.Components.Authorization
@using StorhaugenWebsite.Shared
@using StorhaugenWebsite.Services
@using MudBlazor

@inject AuthenticationStateProvider AuthStateProvider
@inject IThemeService ThemeService
@inject IDeviceStateService DeviceState
@inject IAuthService AuthService
@inject ICollectionStateService CollectionState

<MudThemeProvider @ref="_themeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_currentTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (!_isAuthReady)
{
    <div class="d-flex justify-center align-center" style="height: 100vh; width: 100vw; background-color: var(--mud-palette-background);">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </div>
}
else
{
    <CascadingAuthenticationState>
        <Router AppAssembly="@typeof(App).Assembly">
            <Found Context="routeData">
                <AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)">
                    <NotAuthorized>
                        <LayoutView Layout="@typeof(MainLayout)">
                             <div class="login-required-container">
                                 <div class="empty-state">
                                     <MudIcon Icon="@Icons.Material.Rounded.Lock" Size="Size.Large" />
                                     <h3>Vennligst logg inn</h3>
                                     <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="login">Gå til innlogging</MudButton>
                                 </div>
                             </div>
                        </LayoutView>
                    </NotAuthorized>
                </AuthorizeRouteView>
                <FocusOnNavigate RouteData="@routeData" Selector="h1" />
            </Found>
            <NotFound>
                <PageTitle>Not found</PageTitle>
                <LayoutView Layout="@typeof(MainLayout)">
                    <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="height: 60vh;">
                        <MudText Typo="Typo.h4">Page Not Found</MudText>
                    </MudContainer>
                </LayoutView>
            </NotFound>
        </Router>
    </CascadingAuthenticationState>
}

@code {
    private MudThemeProvider? _themeProvider;
    private MudTheme _currentTheme = new();
    private bool _isDarkMode = false;
    
    // Flag to hold the UI until auth is ready
    private bool _isAuthReady = false;

    protected override async Task OnInitializedAsync()
    {
        // 1. Initialize synchronous/basic services
        await DeviceState.InitializeAsync();
        
        // 2. Wait for Auth to restore from LocalStorage
        // We capture the state here so we can check it immediately below
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        
        // 3. IF LOGGED IN: Initialize Collection State immediately
        // This prevents UI flash because we wait for this
        // to finish before setting _isAuthReady = true.
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            await CollectionState.InitializeAsync();
        }
        
        // 4. Mark as ready - UI will now render
        _isAuthReady = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeAsync();
            ThemeService.OnThemeChanged += OnThemeChanged;
            
            _currentTheme = ThemeService.GetCurrentTheme();
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();
        }
    }

    private void OnThemeChanged()
    {
        _currentTheme = ThemeService.GetCurrentTheme();
        _isDarkMode = ThemeService.IsDarkMode;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}