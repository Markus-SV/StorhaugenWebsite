@page "/friends/{FriendUserId:guid}"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IApiClient ApiClient
@inject IUserFriendshipService FriendshipService
@inject ICollectionStateService CollectionState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<MudPaper Class="pa-4" Elevation="0">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Rounded.ArrowBack"
                   OnClick="@(() => Navigation.NavigateTo("friends"))">
            Tilbake
        </MudButton>
        <MudMenu Icon="@Icons.Material.Rounded.MoreVert" AnchorOrigin="Origin.BottomRight">
            <MudMenuItem Icon="@Icons.Material.Rounded.PersonRemove" IconColor="Color.Error" OnClick="RemoveFriend">Fjern venn</MudMenuItem>
        </MudMenu>
    </div>

    @if (!_loaded)
    {
        <div class="d-flex justify-center my-6">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </div>
    }
    else if (_friend == null)
    {
        <div class="d-flex flex-column align-center pa-4">
            <MudIcon Icon="@Icons.Material.Rounded.PersonOff" Size="Size.Large" Color="Color.Default" />
            <MudText Class="mt-2">Fant ikke brukerprofil.</MudText>
        </div>
    }
    else
    {
        @* --- PROFILE HEADER --- *@
        <div class="d-flex flex-column align-center mb-6">
            <MudAvatar Style="width:80px; height:80px; font-size: 2rem;" Color="Color.Primary" Variant="Variant.Filled" Class="mb-3">
                @(_friend.DisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
            </MudAvatar>

            <MudText Typo="Typo.h5" Style="font-weight: 700;">@_friend.DisplayName</MudText>

            @if (!string.IsNullOrWhiteSpace(_friend.Bio))
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1 text-center">@_friend.Bio</MudText>
            }

            @if (CollectionState.UserCollections.Any())
            {
                <div class="d-flex gap-2 mt-4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Rounded.GroupAdd"
                               OnClick="OpenInviteDialog">
                        Legg til i samling
                    </MudButton>
                </div>
            }
        </div>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6" Class="mb-3">Vurderinger</MudText>

        @if (_ratings.Count == 0)
        {
            <div class="pa-4 text-center">
                <MudText Color="Color.Secondary">Ingen vurderinger ennå.</MudText>
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-3">
                @foreach (var r in _ratings)
                {
                    string linkUrl = r.UserRecipeId.HasValue
                    ? $"food/{r.UserRecipeId}"
                    : $"browse/{r.GlobalRecipeId}";

                    <MudPaper Class="pa-3" Elevation="0" Outlined="true" Style="cursor:pointer;"
                              @onclick="@(() => Navigation.NavigateTo(linkUrl))">
                        <div class="d-flex align-center gap-3">
                            <MudAvatar Size="Size.Medium" Rounded="true">
                                @if (!string.IsNullOrWhiteSpace(r.ImageUrl))
                                {
                                    <img src="@r.ImageUrl" style="width:100%; height:100%; object-fit:cover;" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Rounded.Restaurant" />
                                }
                            </MudAvatar>

                            <div class="flex-grow-1">
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">@r.RecipeTitle</MudText>

                                @if (!string.IsNullOrWhiteSpace(r.Comment))
                                {
                                    <MudText Typo="Typo.caption" Class="d-block text-truncate" Style="max-width: 200px;">"@r.Comment"</MudText>
                                }

                                <MudText Typo="Typo.caption" Color="Color.Secondary">@r.RatedAt.ToLocalTime().ToString("dd.MM.yyyy")</MudText>
                            </div>

                            <MudChip Color="Color.Primary" T=string Size="Size.Small" Variant="Variant.Filled" Style="font-weight: 700;">
                                @r.Score.ToString("0.0")
                            </MudChip>
                        </div>
                    </MudPaper>
                }
            </div>
        }
    }
</MudPaper>

@* Dialog is now shown via IDialogService with AddMemberToCollectionDialog component *@

@code {
    [Parameter] public Guid FriendUserId { get; set; }

    private FriendProfileDto? _friend;
    private List<UserRatingDto> _ratings = new();
    private bool _loaded;

    protected override async Task OnInitializedAsync()
    {
        await CollectionState.InitializeAsync();
        try
        {
            _friend = await FriendshipService.GetUserProfileAsync(FriendUserId);
            _ratings = await ApiClient.GetUserRatingsAsync(FriendUserId, skip: 0, take: 100);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke laste profil: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loaded = true;
        }
    }

    private async Task OpenInviteDialog()
    {
        if (_friend == null) return;

        // Ensure collections are loaded
        await CollectionState.RefreshCollectionsAsync();

        if (!CollectionState.HasCollections)
        {
            Snackbar.Add("Du har ingen samlinger.", Severity.Warning);
            return;
        }

        // Show collections user owns (only owners can add members)
        var availableCollections = CollectionState.UserCollections
            .Where(c => CollectionState.IsOwnerOf(c.Id))
            .ToList();

        if (!availableCollections.Any())
        {
            Snackbar.Add("Du må være eier av en samling for å legge til medlemmer.", Severity.Warning);
            return;
        }

        // Use IDialogService to show the dialog component (MudBlazor 8.15 compatible)
        var parameters = new DialogParameters<AddMemberToCollectionDialog>
        {
            { x => x.AvailableCollections, availableCollections },
            { x => x.UserShareId, _friend.ShareId },
            { x => x.UserDisplayName, _friend.DisplayName ?? "" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<AddMemberToCollectionDialog>("Legg til i samling", parameters, options);
    }

    private async Task RemoveFriend()
    {
        if (_friend == null) return;

        var friendships = await FriendshipService.GetFriendshipsAsync();
        var friendship = friendships.Friends.FirstOrDefault(f => f.FriendUserId == FriendUserId);

        if (friendship == null)
        {
            Snackbar.Add("Kunne ikke finne vennskapet.", Severity.Error);
            return;
        }

        var confirm = await DialogService.ShowMessageBox(
            "Fjern venn",
            $"Er du sikker på at du vil fjerne {_friend.DisplayName} som venn?",
            yesText: "Ja, fjern", cancelText: "Avbryt");

        if (confirm == true)
        {
            try
            {
                await FriendshipService.RemoveFriendAsync(friendship.FriendUserId);
                Snackbar.Add("Venn fjernet", Severity.Info);
                Navigation.NavigateTo("friends");
            }
            catch
            {
                Snackbar.Add("Kunne ikke fjerne venn", Severity.Error);
            }
        }
    }
}
