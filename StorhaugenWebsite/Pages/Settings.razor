@page "/settings"
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.DTOs
@inject IAuthService AuthService
@inject IThemeService ThemeService
@inject IDeviceStateService DeviceState
@inject IHouseholdStateService HouseholdState
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<div class="d-flex align-center gap-3 mb-6">
    <h1 class="page-title" style="margin-bottom: 0; font-size: 1.5rem;">Settings</h1>
    <p class="page-subtitle" style="margin: 0;">Customize your experience</p>
</div>

<div class="form-section">
    <p class="form-section-title">Household</p>

    @if (HouseholdState.CurrentHousehold != null)
    {
        <div class="setting-row">
            <div class="setting-info">
                @if (IsHouseholdLeader)
                {
                    <MudTextField @bind-Value="_editHouseholdName"
                                  Label="Household Name"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Save"
                                  OnAdornmentClick="UpdateHouseholdName"
                                  HelperText="You are the leader. Click save to rename." />
                }
                else
                {
                    <MudText Typo="Typo.body1" Style="font-weight: 500;">@HouseholdState.CurrentHousehold.Name</MudText>
                }

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @HouseholdState.CurrentHousehold.Members.Count member(s) •
                    @(HouseholdState.CurrentHousehold.IsPrivate ? "Private" : "Public")
                </MudText>
            </div>
        </div>

        @if (IsHouseholdLeader)
        {
            <div class="setting-row">
                <div class="setting-info">
                    <MudText Typo="Typo.body1">Visibility</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Public households appear in search results
                    </MudText>
                </div>
                <MudSwitch T="bool"
                           Value="@(!HouseholdState.CurrentHousehold.IsPrivate)"
                           ValueChanged="OnVisibilityChanged"
                           Color="Color.Success" />
            </div>
        }

        @if (HouseholdState.UserHouseholds.Count > 1)
        {
            <MudSelect T="Guid"
                       Label="Switch Household"
                       Value="@HouseholdState.CurrentHousehold.Id"
                       ValueChanged="SwitchHousehold"
                       Variant="Variant.Outlined"
                       Class="mt-3">
                @foreach (var household in HouseholdState.UserHouseholds)
                {
                    <MudSelectItem Value="@household.Id">@household.Name</MudSelectItem>
                }
            </MudSelect>
        }

        <div class="d-flex gap-2 mt-4">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Rounded.PersonAdd" OnClick="InviteMember" Style="border-radius: 12px;">
                Invite
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true" OnClick="ViewMembers">
                Members
            </MudButton>
        </div>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mb-3">
            You don't have a household yet.
        </MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="CreateHousehold">
            Create Household
        </MudButton>
    }
</div>

<div class="form-section">
    <p class="form-section-title">Account</p>

    <div class="setting-row">
        <div class="d-flex align-center gap-3">
            <MudAvatar Size="Size.Medium" Style="@($"background: {GetMemberColor(AuthService.CurrentUserName ?? "")}")">
                @(string.IsNullOrEmpty(AuthService.CurrentUserName) ? '?' : AuthService.CurrentUserName[0])
            </MudAvatar>
            <div>
                <MudText Typo="Typo.body1" Style="font-weight: 500;">@AuthService.CurrentUserName</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@AuthService.CurrentUserEmail</MudText>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <MudTextField @bind-Value="_editDisplayName"
                      Label="Display Name"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Save"
                      OnAdornmentClick="UpdateDisplayName"
                      HelperText="Click the save icon to update your name" />
    </div>

    @if (!string.IsNullOrEmpty(_userProfile?.UniqueShareId))
    {
        <div class="setting-row" style="padding: 12px 0;">
            <div class="d-flex align-center justify-space-between" style="width: 100%;">
                <div>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Your Share ID</MudText>
                    <MudText Typo="Typo.h6" Style="font-family: monospace; letter-spacing: 2px; font-weight: 600;">
                        @_userProfile.UniqueShareId
                    </MudText>
                </div>
                <MudIconButton Icon="@Icons.Material.Rounded.ContentCopy"
                               Size="Size.Small"
                               Color="Color.Primary"
                               OnClick="CopyShareId"
                               Title="Copy Share ID" />
            </div>
        </div>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="margin-top: -8px;">
            Share this ID with others to let them invite you to their household
        </MudText>
    }

    <MudButton Variant="Variant.Outlined"
               Color="Color.Error"
               FullWidth="true"
               StartIcon="@Icons.Material.Rounded.Logout"
               OnClick="Logout"
               Style="border-radius: 12px; margin-top: 16px;">
        Sign Out
    </MudButton>
</div>

<div class="form-section">
    <p class="form-section-title">About</p>
    <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
        <MudText Typo="Typo.body1" Style="font-weight: 500;">Storhaugen Eats</MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary">Version 1.0.0</MudText>
    </div>
</div>

<style>
    /* ... existing styles ... */
    .theme-select .mud-input-slot {
        min-height: 70px !important;
        padding: 8px 14px !important;
    }

    .theme-preview-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }

    .theme-name {
        font-weight: 500;
    }

    .mini-website {
        width: 100px;
        height: 56px;
        border-radius: 6px;
        border: 1px solid;
        display: flex;
        flex-wrap: wrap;
        overflow: hidden;
        flex-shrink: 0;
    }

    .mini-appbar {
        width: 100%;
        height: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .mini-sidebar {
        width: 16px;
        height: calc(100% - 10px);
    }

    .mini-content {
        flex: 1;
        margin: 4px;
        border-radius: 3px;
        padding: 4px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .mini-primary {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .mini-text {
        width: 60%;
        height: 4px;
        border-radius: 2px;
    }

    .mini-text-sm {
        width: 40%;
        height: 3px;
        border-radius: 2px;
    }

    .setting-row {
        display: flex;
        align-items: center;
        padding: 12px 0;
        gap: 16px;
    }

        .setting-row:not(:last-child) {
            border-bottom: 1px solid var(--mud-palette-divider);
        }

    .setting-info {
        flex: 1;
    }
</style>

@code {
    private string _currentTheme = "Light";
    private string _viewMode = "card";
    private UserDto? _userProfile;
    private string? _editDisplayName; // Bound variable for input
    private string? _editHouseholdName;

    private bool IsHouseholdLeader =>
        HouseholdState.CurrentHousehold != null &&
        _userProfile != null &&
        HouseholdState.CurrentHousehold.CreatedById == _userProfile.Id;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("login");
                return;
            }
        }

        await HouseholdState.InitializeAsync();

        try
        {
            _userProfile = await ApiClient.GetMyProfileAsync();

            if (HouseholdState.CurrentHousehold != null)
            {
                _editHouseholdName = HouseholdState.CurrentHousehold.Name;
            }

            if (_userProfile != null)
            {
                // 1. Initialize input field
                _editDisplayName = _userProfile.DisplayName;

                // 2. Sync Auth Service state so header/sidebar updates immediately if DB differs from Email
                AuthService.UpdateCachedDisplayName(_userProfile.DisplayName);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user profile: {ex.Message}");
        }

        _currentTheme = ThemeService.GetCurrentThemeName();
        _viewMode = DeviceState.Settings.ViewMode;
    }

    private async Task UpdateDisplayName()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_editDisplayName))
            {
                // If user clears it, we set it to null so it falls back to email later
                _editDisplayName = null;
            }

            // 1. Send update to API
            var updatedProfile = await ApiClient.UpdateMyProfileAsync(new UpdateUserDto
            {
                DisplayName = _editDisplayName
            });

            // 2. Update local profile object
            _userProfile = updatedProfile;

            // 3. Update Auth Service to reflect changes in Header/Sidebar immediately
            AuthService.UpdateCachedDisplayName(updatedProfile.DisplayName);

            Snackbar.Add("Display name updated", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to update name", Severity.Error);
            Console.WriteLine(ex.Message);
        }
    }

    private async Task UpdateHouseholdName()
    {
        if (string.IsNullOrWhiteSpace(_editHouseholdName) || HouseholdState.CurrentHousehold == null) return;

        try
        {
            await ApiClient.UpdateHouseholdNameAsync(HouseholdState.CurrentHousehold.Id, new UpdateHouseholdDto
            {
                Name = _editHouseholdName
            });
            await HouseholdState.RefreshHouseholdsAsync(); // Refresh local state
            Snackbar.Add("Household renamed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to rename household", Severity.Error);
            Console.WriteLine(ex.Message);
        }
    }

    private async Task OnVisibilityChanged(bool isPublic)
    {
        if (HouseholdState.CurrentHousehold == null) return;

        try
        {
            await ApiClient.UpdateHouseholdSettingsAsync(HouseholdState.CurrentHousehold.Id, new UpdateHouseholdSettingsDto
            {
                IsPrivate = !isPublic
            });

            // Manually update local state to reflect UI change immediately
            HouseholdState.CurrentHousehold.IsPrivate = !isPublic;
            Snackbar.Add(isPublic ? "Household is now Public" : "Household is now Private", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to update settings", Severity.Error);
            // Revert switch visually
            StateHasChanged();
        }
    }

    private async Task OnThemeChanged(string themeName)
    {
        _currentTheme = themeName;
        await ThemeService.SetThemeAsync(themeName);
    }

    private async Task SetViewMode(string mode)
    {
        _viewMode = mode;
        await DeviceState.SetViewModeAsync(mode);
    }

    private string GetThemeDisplayName(string themeName)
    {
        return themeName switch
        {
            "System" => "System Default",
            "Light" => "Light",
            "Dark" => "Dark",
            "Black" => "Midnight Black",
            "Material" => "Material Red",
            "Forest" => "Night Forest",
            _ => themeName
        };
    }

    private string GetMemberColor(string name)
    {
        var hash = name.GetHashCode();
        var hue = Math.Abs(hash % 360);
        return $"hsl({hue}, 45%, 45%)";
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("login");
    }

    private async Task CopyShareId()
    {
        if (string.IsNullOrEmpty(_userProfile?.UniqueShareId))
            return;

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _userProfile.UniqueShareId);
            Snackbar.Add("Share ID copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy to clipboard", Severity.Error);
        }
    }

    // Household Management Methods
    private async Task CreateHousehold()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<Components.HouseholdSelector>("Create Household", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HouseholdState.RefreshHouseholdsAsync();
            StateHasChanged();
        }
    }

    private async Task SwitchHousehold(Guid householdId)
    {
        try
        {
            await HouseholdState.SetCurrentHouseholdAsync(householdId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error switching household: {ex.Message}");
        }
    }

    private async Task InviteMember()
    {
        if (HouseholdState.CurrentHousehold == null)
            return;

        var parameters = new DialogParameters
        {
            { "HouseholdId", HouseholdState.CurrentHousehold.Id },
            { "HouseholdName", HouseholdState.CurrentHousehold.Name }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<Components.InviteMemberDialog>(
            "Invite Member",
            parameters,
            options);

        await dialog.Result;
    }

    private async Task ViewMembers()
    {
        if (HouseholdState.CurrentHousehold == null)
            return;

        var parameters = new DialogParameters
        {
            { "Household", HouseholdState.CurrentHousehold }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<Components.HouseholdMembersDialog>(
            "Household Members",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HouseholdState.RefreshHouseholdsAsync();
            StateHasChanged();
        }
    }
}