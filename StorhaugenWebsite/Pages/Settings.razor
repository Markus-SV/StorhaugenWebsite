@page "/settings"
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.DTOs
@inject IAuthService AuthService
@inject IThemeService ThemeService
@inject IDeviceStateService DeviceState
@inject IHouseholdStateService HouseholdState
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService

<div class="d-flex align-center gap-3 mb-6">
    <h1 class="page-title" style="margin-bottom: 0; font-size: 1.5rem;">Settings</h1>
    <p class="page-subtitle" style="margin: 0;">Customize your experience</p>
</div>

<div class="form-section">
    <p class="form-section-title">Appearance</p>

    <MudSelect T="string"
               Label="Color Theme"
               Value="@_currentTheme"
               ValueChanged="OnThemeChanged"
               Variant="Variant.Outlined"
               Class="theme-select"
               AnchorOrigin="Origin.BottomLeft"
               Style="margin-bottom: 16px;">
        @foreach (var themeName in ThemeService.GetAvailableThemes())
        {
            var colors = ThemeService.GetThemeColors(themeName);
            <MudSelectItem Value="@themeName">
                <div class="theme-preview-container">
                    <div class="mini-website" style="background: @colors.Background; border-color: @colors.Divider;">
                        <div class="mini-appbar" style="background: @colors.AppbarBackground;"></div>
                        <div class="mini-sidebar" style="background: @colors.BackgroundGrey;"></div>
                        <div class="mini-content" style="background: @colors.Surface;">
                            <div class="mini-primary" style="background: @colors.Primary;"></div>
                            <div class="mini-text" style="background: @colors.TextPrimary;"></div>
                            <div class="mini-text-sm" style="background: @colors.TextSecondary;"></div>
                        </div>
                    </div>
                    <span class="theme-name">@GetThemeDisplayName(themeName)</span>
                </div>
            </MudSelectItem>
        }
    </MudSelect>
</div>

<div class="form-section">
    <p class="form-section-title">Household</p>

    @if (HouseholdState.CurrentHousehold != null)
    {
        <div class="setting-row">
            <div class="setting-info">
                <MudText Typo="Typo.body1" Style="font-weight: 500;">@HouseholdState.CurrentHousehold.Name</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @HouseholdState.CurrentHousehold.Members.Count member(s)
                </MudText>
            </div>
        </div>

        @if (HouseholdState.UserHouseholds.Count > 1)
        {
            <MudSelect T="int"
                       Label="Switch Household"
                       Value="@HouseholdState.CurrentHousehold.Id"
                       ValueChanged="SwitchHousehold"
                       Variant="Variant.Outlined"
                       Class="mt-3">
                @foreach (var household in HouseholdState.UserHouseholds)
                {
                    <MudSelectItem Value="@household.Id">@household.Name</MudSelectItem>
                }
            </MudSelect>
        }

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   FullWidth="true"
                   StartIcon="@Icons.Material.Rounded.PersonAdd"
                   OnClick="InviteMember"
                   Style="border-radius: 12px; margin-top: 16px;">
            Invite Member
        </MudButton>

        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   FullWidth="true"
                   OnClick="ViewMembers"
                   Style="margin-top: 8px;">
            View Members
        </MudButton>
    }
    else
    {
        <MudAlert Severity="Severity.Warning" Class="mb-3">
            You don't have a household yet. Create one to get started!
        </MudAlert>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="CreateHousehold">
            Create Household
        </MudButton>
    }
</div>

<div class="form-section">
    <p class="form-section-title">Account</p>

    <div class="setting-row">
        <div class="d-flex align-center gap-3">
            <MudAvatar Size="Size.Medium" Style="@($"background: {GetMemberColor(AuthService.CurrentUser?.Name ?? "")}")">
                @(AuthService.CurrentUser?.Name?[0] ?? '?')
            </MudAvatar>
            <div>
                <MudText Typo="Typo.body1" Style="font-weight: 500;">@AuthService.CurrentUser?.Name</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@AuthService.CurrentUserEmail</MudText>
            </div>
        </div>
    </div>

    <MudButton Variant="Variant.Outlined"
               Color="Color.Error"
               FullWidth="true"
               StartIcon="@Icons.Material.Rounded.Logout"
               OnClick="Logout"
               Style="border-radius: 12px; margin-top: 16px;">
        Sign Out
    </MudButton>
</div>

<div class="form-section">
    <p class="form-section-title">About</p>

    <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
        <MudText Typo="Typo.body1" Style="font-weight: 500;">Storhaugen Eats</MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary">Version 1.0.0</MudText>
    </div>
</div>


<style>
    .theme-select .mud-input-slot {
        min-height: 70px !important;
        padding: 8px 14px !important;
    }

    .theme-preview-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }

    .theme-name {
        font-weight: 500;
    }

    .mini-website {
        width: 100px;
        height: 56px;
        border-radius: 6px;
        border: 1px solid;
        display: flex;
        flex-wrap: wrap;
        overflow: hidden;
        flex-shrink: 0;
    }

    .mini-appbar {
        width: 100%;
        height: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .mini-sidebar {
        width: 16px;
        height: calc(100% - 10px);
    }

    .mini-content {
        flex: 1;
        margin: 4px;
        border-radius: 3px;
        padding: 4px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .mini-primary {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .mini-text {
        width: 60%;
        height: 4px;
        border-radius: 2px;
    }

    .mini-text-sm {
        width: 40%;
        height: 3px;
        border-radius: 2px;
    }

    .setting-row {
        display: flex;
        align-items: center;
        padding: 12px 0;
        gap: 16px;
    }

        .setting-row:not(:last-child) {
            border-bottom: 1px solid var(--mud-palette-divider);
        }

    .setting-info {
        flex: 1;
    }
</style>

@code {
    private string _currentTheme = "Light";
    private string _viewMode = "card";

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("login");
                return;
            }
        }

        _currentTheme = ThemeService.GetCurrentThemeName();
        _viewMode = DeviceState.Settings.ViewMode;
    }

    private async Task OnThemeChanged(string themeName)
    {
        _currentTheme = themeName;
        await ThemeService.SetThemeAsync(themeName);
    }

    private async Task SetViewMode(string mode)
    {
        _viewMode = mode;
        await DeviceState.SetViewModeAsync(mode);
    }

    private string GetThemeDisplayName(string themeName)
    {
        return themeName switch
        {
            "System" => "System Default",
            "Light" => "Light",
            "Dark" => "Dark",
            "Black" => "Midnight Black",
            "Material" => "Material Red",
            "Forest" => "Night Forest",
            _ => themeName
        };
    }

    private string GetMemberColor(string name)
    {
        return name switch
        {
            "Markus" => "#E07A2E",
            "Siv" => "#2D5A45",
            "Elias" => "#4A7C9B",
            _ => "#6B5D4D"
        };
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("login");
    }

    // Household Management Methods
    private async Task CreateHousehold()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<Components.HouseholdSelector>("Create Household", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HouseholdState.RefreshHouseholdsAsync();
            StateHasChanged();
        }
    }

    private async Task SwitchHousehold(int householdId)
    {
        try
        {
            await HouseholdState.SetCurrentHouseholdAsync(householdId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Show error snackbar in real implementation
            Console.WriteLine($"Error switching household: {ex.Message}");
        }
    }

    private async Task InviteMember()
    {
        if (HouseholdState.CurrentHousehold == null)
            return;

        var parameters = new DialogParameters
        {
            { "HouseholdId", HouseholdState.CurrentHousehold.Id },
            { "HouseholdName", HouseholdState.CurrentHousehold.Name }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<Components.InviteMemberDialog>(
            "Invite Member",
            parameters,
            options);

        await dialog.Result;
        // Dialog handles all invite logic internally
    }

    private async Task ViewMembers()
    {
        if (HouseholdState.CurrentHousehold == null)
            return;

        var parameters = new DialogParameters
        {
            { "Household", HouseholdState.CurrentHousehold }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<Components.HouseholdMembersDialog>(
            "Household Members",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Refresh household state after dialog closes (in case user left)
            await HouseholdState.RefreshHouseholdsAsync();
            StateHasChanged();
        }
    }
}