@page "/browse/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IApiClient ApiClient
@inject IUserRecipeService RecipeService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="@(() => Navigation.NavigateTo("browse"))">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="p-4 d-flex justify-center">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_recipe == null)
{
    <div class="empty-state">
        <MudIcon Icon="@Icons.Material.Rounded.Error" Size="Size.Large" />
        <h2>Oppskrift ikke funnet</h2>
    </div>
}
else
{
    @* --- Header Image --- *@
    @if (!string.IsNullOrEmpty(GetImageUrl()))
    {
        <img src="@GetImageUrl()" class="detail-hero-image" />
    }
    else
    {
        <div class="detail-hero-placeholder">
            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" />
        </div>
    }

    <div class="detail-content">
        <div class="d-flex justify-space-between align-start gap-3">
            <h1 class="detail-title">@_recipe.Name</h1>
            @if (_recipe.AverageRating > 0)
            {
                <span class="rating-badge rating-high">
                    <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                    @_recipe.AverageRating.ToString("0.0")
                </span>
            }
        </div>

        @* --- Source Badge --- *@
        <div class="d-flex gap-2 mt-2">
            @if (_recipe.IsHellofresh)
            {
                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.LocalDining" Color="Color.Primary">
                    HelloFresh
                </MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.People" Color="Color.Tertiary">
                    Delt av @(_recipe.CreatedByUserName ?? "Fellesskapet")
                </MudChip>
            }

            @if (_recipe.PrepTimeMinutes.HasValue)
            {
                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.AccessTime" Variant="Variant.Text">
                    @_recipe.PrepTimeMinutes min
                </MudChip>
            }
        </div>

        @if (!string.IsNullOrEmpty(_recipe.Description))
        {
            <p class="detail-description mt-4">@_recipe.Description</p>
        }

        @* --- HelloFresh Recipe Details --- *@
        @if (_recipe.IsHellofresh)
        {
            <div class="mt-6">
                <HelloFreshRecipeDetails Recipe="_recipe" />
            </div>
        }

        <div class="action-buttons mt-6">
            @* --- Primary Action: Add to my cookbook --- *@
            <MudButton Variant="Variant.Filled"
                       Color="@(_recipe.IsHellofresh ? Color.Success : Color.Primary)"
                       FullWidth="true"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Rounded.Add"
                       OnClick="AddToMyList"
                       Disabled="_isProcessing"
                       Style="border-radius: 12px; height: 52px;">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Legger til...</span>
                }
                else
                {
                    <span>Legg til i min kokebok</span>
                }
            </MudButton>

            @* --- Secondary: Copy and customize --- *@
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       FullWidth="true"
                       Class="mt-3"
                       StartIcon="@Icons.Material.Rounded.Edit"
                       OnClick="CustomizeAndAdd"
                       Style="border-radius: 12px;">
                Kopier og tilpass
            </MudButton>
        </div>
    </div>
}

<style>
    .detail-hero-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 0 0 24px 24px;
    }

    .detail-hero-placeholder {
        width: 100%;
        height: 250px;
        background: var(--mud-palette-background-grey);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0 0 24px 24px;
        color: var(--mud-palette-text-disabled);
    }

    .detail-content {
        padding: 24px;
    }

    .detail-title {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
    }

    .detail-description {
        color: var(--mud-palette-text-secondary);
        line-height: 1.6;
    }

    .action-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-lines-default);
        border-radius: 16px;
        padding: 16px;
    }

    .action-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
    }

    .action-desc {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 0;
    }
</style>

@code {
    [Parameter] public Guid Id { get; set; }

    private GlobalRecipeDto? _recipe;
    private bool _isLoading = true;
    private bool _isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _recipe = await ApiClient.GetGlobalRecipeAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add("Feil ved lasting av oppskrift", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetImageUrl()
    {
        if (_recipe == null) return null;
        if (!string.IsNullOrEmpty(_recipe.ImageUrl)) return _recipe.ImageUrl;
        return _recipe.ImageUrls?.FirstOrDefault();
    }

    // Add to my list using UserRecipes API
    private async Task AddToMyList()
    {
        if (_recipe == null) return;

        _isProcessing = true;
        try
        {
            var dto = new CreateUserRecipeDto
            {
                Name = _recipe.Name,
                Description = _recipe.Description,
                ImageUrls = _recipe.ImageUrls ?? new List<string>(),
                GlobalRecipeId = _recipe.Id,
                PrepTimeMinutes = _recipe.PrepTimeMinutes,
                Servings = _recipe.Servings,
                Difficulty = _recipe.Difficulty,
                Cuisine = _recipe.Cuisine,
                Tags = _recipe.Tags,
                Ingredients = _recipe.Ingredients,
                Visibility = "private"
            };

            await RecipeService.CreateRecipeAsync(dto);
            Snackbar.Add($"'{_recipe.Name}' lagt til i din kokebok!", Severity.Success);
            Navigation.NavigateTo("");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("Kunne ikke lagre oppskrift", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    // Copy and customize
    private void CustomizeAndAdd()
    {
        if (_recipe == null) return;

        FoodService.DraftRecipe = new StorhaugenWebsite.Models.FoodItem
        {
            Name = _recipe.Name,
            Description = _recipe.Description,
            ImageUrls = _recipe.ImageUrls ?? new List<string>(),
            GlobalRecipeId = _recipe.Id
        };

        Navigation.NavigateTo("add");
    }
}