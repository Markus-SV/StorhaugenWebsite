@page "/browse/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IApiClient ApiClient
@inject IUserRecipeService RecipeService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="p-4 d-flex justify-center">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_recipe == null)
{
    <div class="empty-state">
        <MudIcon Icon="@Icons.Material.Rounded.Error" Size="Size.Large" />
        <h2>Oppskrift ikke funnet</h2>
    </div>
}
else
{
    @* --- Header Image --- *@
    @if (!string.IsNullOrEmpty(GetImageUrl()) && !_recipe.IsHellofresh)
    {
        <img src="@GetImageUrl()" class="detail-hero-image" />
    }

    <div>
        <div class="d-flex justify-space-between align-start gap-3">
            <h1 class="detail-title">@_recipe.Name</h1>
            @if (_recipe.AverageRating > 0)
            {
                <div class="d-flex flex-column align-end">
                    <span class="rating-badge rating-high">
                        <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                        @_recipe.AverageRating.ToString("0.0")
                    </span>
                    @if (_recipe.TotalRatings > 0)
                    {
                        <span class="rating-count-badge">
                            <MudIcon Icon="@Icons.Material.Rounded.People" Size="Size.Small" Style="font-size: 10px;" />
                            @_recipe.TotalRatings
                        </span>
                    }
                </div>
            }
        </div>

        @* --- Source Badge --- *@
        <div class="d-flex gap-2 mt-2 flex-wrap">
            @if (_recipe.IsHellofresh)
            {
                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.LocalDining" Color="Color.Success">
                    HelloFresh
                </MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.Cloud" Color="Color.Info">
                    Delt av @(_recipe.CreatedByUserName ?? "Fellesskapet")
                </MudChip>
            }
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="align-self-center">â€¢ @_recipe.CreatedAt.ToString("dd. MMM yyyy")</MudText>
        </div>

        @* --- Quick Info Row --- *@
        @if (_recipe.PrepTimeMinutes.HasValue || _recipe.CookTimeMinutes.HasValue || !string.IsNullOrEmpty(_recipe.Difficulty) || _recipe.Servings.HasValue || !string.IsNullOrEmpty(_recipe.Cuisine))
        {
            <div class="quick-info-row mt-4">
                @if (_recipe.PrepTimeMinutes.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.AccessTime" Size="Size.Small" Color="Color.Primary" />
                        <span>@_recipe.PrepTimeMinutes min forberedelse</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Difficulty))
                {
                    <div class="quick-info-item @GetDifficultyClass(_recipe.Difficulty)">
                        <MudIcon Icon="@GetDifficultyIcon(_recipe.Difficulty)" Size="Size.Small" />
                        <span>@GetDifficultyLabel(_recipe.Difficulty)</span>
                    </div>
                }
                @if (_recipe.Servings.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Group" Size="Size.Small" Color="Color.Tertiary" />
                        <span>@_recipe.Servings porsjoner</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Cuisine))
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" Color="Color.Info" />
                        <span>@_recipe.Cuisine</span>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(_recipe.Description))
        {
            <p class="detail-description mt-4">@_recipe.Description</p>
        }

        @* --- Recipe Tags --- *@
        @if (_recipe.Tags.Any())
        {
            <div class="d-flex flex-wrap gap-2 mt-3">
                @foreach (var tag in _recipe.Tags)
                {
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">@tag</MudChip>
                }
            </div>
        }

        @* --- HelloFresh Recipe Details (Ingredients & Nutrition) --- *@
        @if (_recipe.IsHellofresh)
        {
            <div class="mt-6">
                <HelloFreshRecipeDetails Recipe="_recipe" />
            </div>
        }
        else if (HasIngredients())
        {
            @* Community Recipe Ingredients *@
            <MudExpansionPanels Class="mt-4" MultiExpansion="true">
                <MudExpansionPanel Text="Ingredienser" Icon="@Icons.Material.Rounded.ShoppingCart" IsInitiallyExpanded="true">
                    <div class="ingredients-list">
                        @foreach (var ingredient in GetIngredients())
                        {
                            <div class="ingredient-item">
                                <div class="ingredient-placeholder">
                                    <MudIcon Icon="@Icons.Material.Rounded.Egg" Size="Size.Small" />
                                </div>
                                <div class="ingredient-info">
                                    <span class="ingredient-name">@ingredient.Name</span>
                                    @if (!string.IsNullOrEmpty(ingredient.Amount) || !string.IsNullOrEmpty(ingredient.Unit))
                                    {
                                        <span class="ingredient-amount">@ingredient.Amount @ingredient.Unit</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        <div class="action-buttons mt-6">
            @* --- Primary Action: Add to my cookbook --- *@
            <MudButton Variant="Variant.Filled"
                       Color="@(_recipe.IsHellofresh ? Color.Success : Color.Primary)"
                       FullWidth="true"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Rounded.Add"
                       OnClick="AddToMyList"
                       Disabled="_isProcessing"
                       Style="border-radius: 12px; height: 52px;">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Legger til...</span>
                }
                else
                {
                    <span>Legg til</span>
                }
            </MudButton>

            @* --- Secondary: Copy and customize --- *@
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       FullWidth="true"
                       Class="mt-3"
                       StartIcon="@Icons.Material.Rounded.Edit"
                       OnClick="CustomizeAndAdd"
                       Style="border-radius: 12px;">
                Kopier og endre
            </MudButton>
        </div>
    </div>
}

<style>
    .detail-hero-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 24px;
        margin-bottom: 16px;
    }

    .detail-hero-placeholder {
        width: 100%;
        height: 250px;
        background: var(--mud-palette-background-grey);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0 0 24px 24px;
        color: var(--mud-palette-text-disabled);
    }

    .detail-content {
        padding: 24px;
    }

    .detail-title {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
    }

    .detail-description {
        color: var(--mud-palette-text-secondary);
        line-height: 1.6;
    }

    .action-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-lines-default);
        border-radius: 16px;
        padding: 16px;
    }

    .action-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
    }

    .action-desc {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 0;
    }

    .rating-count {
        font-size: 0.7rem;
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }

    .quick-info-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .quick-info-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--mud-palette-background-grey);
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .quick-info-item.difficulty-easy {
        background: rgba(76, 175, 80, 0.1);
        color: #2e7d32;
    }

    .quick-info-item.difficulty-medium {
        background: rgba(255, 152, 0, 0.1);
        color: #e65100;
    }

    .quick-info-item.difficulty-hard {
        background: rgba(244, 67, 54, 0.1);
        color: #c62828;
    }

    .ingredients-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ingredient-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px;
        background: var(--mud-palette-background-grey);
        border-radius: 8px;
    }

    .ingredient-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--mud-palette-divider);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mud-palette-text-disabled);
    }

    .ingredient-info {
        display: flex;
        flex-direction: column;
    }

    .ingredient-name {
        font-weight: 500;
        color: var(--mud-palette-text-primary);
    }

    .ingredient-amount {
        font-size: 0.8rem;
        color: var(--mud-palette-text-secondary);
    }
</style>

@code {
    [Parameter] public Guid Id { get; set; }

    private GlobalRecipeDto? _recipe;
    private bool _isLoading = true;
    private bool _isProcessing = false;

    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _recipe = await ApiClient.GetGlobalRecipeAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add("Feil ved lasting av oppskrift", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetImageUrl()
    {
        if (_recipe == null) return null;
        if (!string.IsNullOrEmpty(_recipe.ImageUrl)) return _recipe.ImageUrl;
        return _recipe.ImageUrls?.FirstOrDefault();
    }

    // Add to my list using UserRecipes API
    private async Task AddToMyList()
    {
        if (_recipe == null) return;

        _isProcessing = true;
        try
        {
            var dto = new CreateUserRecipeDto
            {
                Name = _recipe.Name,
                Description = _recipe.Description,
                ImageUrls = _recipe.ImageUrls ?? new List<string>(),
                GlobalRecipeId = _recipe.Id,
                PrepTimeMinutes = _recipe.PrepTimeMinutes,
                Servings = _recipe.Servings,
                Difficulty = _recipe.Difficulty,
                Cuisine = _recipe.Cuisine,
                Tags = _recipe.Tags,
                Ingredients = _recipe.Ingredients,
                Visibility = "private"
            };

            await RecipeService.CreateRecipeAsync(dto);
            Snackbar.Add($"'{_recipe.Name}' lagt til i din kokebok!", Severity.Success);
            Navigation.NavigateTo("");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("Kunne ikke lagre oppskrift", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    // Copy and customize - creates independent copy NOT linked to HelloFresh
    private void CustomizeAndAdd()
    {
        if (_recipe == null) return;

        FoodService.DraftRecipe = new StorhaugenWebsite.Models.FoodItem
        {
            Name = _recipe.Name,
            Description = _recipe.Description,
            ImageUrls = _recipe.ImageUrls ?? new List<string>(),
            // Don't link to GlobalRecipe so it's fully editable
            GlobalRecipeId = null,
            // Not a HelloFresh recipe - it's a personal copy
            IsHelloFresh = false,
            PrepTimeMinutes = _recipe.PrepTimeMinutes,
            CookTimeMinutes = _recipe.CookTimeMinutes,
            Servings = _recipe.Servings,
            Difficulty = _recipe.Difficulty,
            Cuisine = _recipe.Cuisine,
            Ingredients = _recipe.Ingredients
        };

        Navigation.NavigateTo("add");
    }

    // Difficulty helpers
    private string GetDifficultyIcon(string? difficulty)
    {
        return difficulty?.ToLower() switch
        {
            "easy" or "lett" => Icons.Material.Rounded.SentimentSatisfied,
            "medium" or "middels" => Icons.Material.Rounded.Psychology,
            "hard" or "vanskelig" => Icons.Material.Rounded.LocalFireDepartment,
            _ => Icons.Material.Rounded.HelpOutline
        };
    }

    private string GetDifficultyLabel(string? difficulty)
    {
        return difficulty?.ToLower() switch
        {
            "easy" => "Lett",
            "medium" => "Middels",
            "hard" => "Vanskelig",
            _ => difficulty ?? ""
        };
    }

    private string GetDifficultyClass(string? difficulty)
    {
        return difficulty?.ToLower() switch
        {
            "easy" or "lett" => "difficulty-easy",
            "medium" or "middels" => "difficulty-medium",
            "hard" or "vanskelig" => "difficulty-hard",
            _ => ""
        };
    }

    // Ingredient helpers
    private record IngredientInfo(string Name, string? Amount, string? Unit);

    private bool HasIngredients()
    {
        if (_recipe?.Ingredients == null) return false;
        if (_recipe.Ingredients is System.Text.Json.JsonElement jsonElement)
        {
            return jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array && jsonElement.GetArrayLength() > 0;
        }
        return false;
    }

    private List<IngredientInfo> GetIngredients()
    {
        var items = new List<IngredientInfo>();
        if (_recipe?.Ingredients == null) return items;

        try
        {
            if (_recipe.Ingredients is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                foreach (var item in jsonElement.EnumerateArray())
                {
                    var name = item.TryGetProperty("name", out var n) ? n.GetString() : "";
                    var amount = item.TryGetProperty("amount", out var a) ? a.ToString() : null;
                    var unit = item.TryGetProperty("unit", out var u) ? u.GetString() : null;

                    if (!string.IsNullOrEmpty(name))
                    {
                        items.Add(new IngredientInfo(name!, amount, unit));
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing ingredients: {ex.Message}");
        }
        return items;
    }
}