@page "/browse/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@using StorhaugenWebsite.Shared.Extensions
@inject IApiClient ApiClient
@inject IUserRecipeService RecipeService
@inject IFoodService FoodService
@inject IAuthService AuthService
@inject ICollectionStateService CollectionState
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="p-4 d-flex justify-center">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_recipe == null)
{
    <div class="empty-state">
        <MudIcon Icon="@Icons.Material.Rounded.Error" Size="Size.Large" />
        <h2>Oppskrift ikke funnet</h2>
    </div>
}
else
{
    @* --- IMAGE --- *@
    @if (!string.IsNullOrEmpty(GetImageUrl()) && !_recipe.IsHellofresh)
    {
        <div class="detail-image-carousel">
            <img src="@GetImageUrl()" class="detail-hero-image" />
        </div>
    }

    @* --- INFO CARD --- *@
    <div class="detail-info-card">
        <div class="d-flex justify-space-between align-start gap-3">
            <div style="min-width:0;">
                <h1 class="detail-title">@_recipe.Name</h1>

                <div class="d-flex gap-2 mt-2 flex-wrap align-center">
                    @if (_recipe.IsHellofresh)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.LocalDining" Color="Color.Success">
                            HelloFresh
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.Cloud" Color="Color.Info">
                            Delt av @(_recipe.CreatedByUserName ?? "Fellesskapet")
                        </MudChip>
                    }

                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="align-self-center">
                        â€¢ @_recipe.CreatedAt.ToString("dd. MMM yyyy")
                    </MudText>

                    @if (IsOwner)
                    {
                        <div class="ml-auto">
                            <MudMenu Icon="@Icons.Material.Rounded.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight">
                                <MudMenuItem Icon="@Icons.Material.Rounded.Delete" IconColor="Color.Error" OnClick="DeletePublishedRecipe">
                                    Slett fra fellesskapet
                                </MudMenuItem>
                            </MudMenu>
                        </div>
                    }
                </div>
            </div>

            @if (_recipe.AverageRating > 0)
            {
                var ratingClass = _recipe.AverageRating >= 8 ? "rating-high"
                : _recipe.AverageRating >= 5 ? "rating-medium"
                : "rating-low";

                <div class="d-flex flex-column align-end" style="flex-shrink:0;">
                    <span class="rating-badge @ratingClass"
                          style="font-size: 1rem; padding: 8px 14px; color:@_recipe.AverageRating.ToRatingColorHex();">
                        <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                        @_recipe.AverageRating.ToString("0.0")
                    </span>

                    @if (_recipe.TotalRatings > 0)
                    {
                        <span class="rating-count-badge">
                            <MudIcon Icon="@Icons.Material.Rounded.People" Size="Size.Small" Style="font-size: 12px;" />
                            @_recipe.TotalRatings
                        </span>
                    }
                </div>
            }
        </div>

        @if (_recipe.PrepTimeMinutes.HasValue || _recipe.CookTimeMinutes.HasValue || !string.IsNullOrEmpty(_recipe.Difficulty) || _recipe.Servings.HasValue || !string.IsNullOrEmpty(_recipe.Cuisine))
        {
            <div class="quick-info-row mt-3">
                @if (_recipe.PrepTimeMinutes.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.AccessTime" Size="Size.Small" Color="Color.Primary" />
                        <span>@_recipe.PrepTimeMinutes min tilberedning</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Difficulty))
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@GetDifficultyIcon(_recipe.Difficulty)" Size="Size.Small" Color="Color.Secondary" />
                        <span>@GetDifficultyLabel(_recipe.Difficulty)</span>
                    </div>
                }
                @if (_recipe.Servings.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Group" Size="Size.Small" Color="Color.Tertiary" />
                        <span>@_recipe.Servings porsjoner</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Cuisine))
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" Color="Color.Info" />
                        <span>@_recipe.Cuisine</span>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(_recipe.Description))
        {
            <p class="detail-description mt-4">@_recipe.Description</p>
        }

        @if (_recipe.Tags.Any())
        {
            <div class="d-flex flex-wrap gap-2 mt-3">
                @foreach (var tag in _recipe.Tags)
                {
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">@tag</MudChip>
                }
            </div>
        }
    </div>

    <div>
        @if (_recipe.IsHellofresh)
        {
            <div class="mt-4">
                <HelloFreshRecipeDetails Recipe="_recipe" />
            </div>
        }
        else if (HasIngredients())
        {
            <MudExpansionPanels Class="mt-4" MultiExpansion="true">
                <MudExpansionPanel Text="Ingredienser" Icon="@Icons.Material.Rounded.ShoppingCart" IsInitiallyExpanded="true">
                    <div class="ingredients-list">
                        @foreach (var ingredient in GetIngredients())
                        {
                            <div class="ingredient-item">
                                <div class="ingredient-placeholder">
                                    <MudIcon Icon="@Icons.Material.Rounded.Egg" Size="Size.Small" />
                                </div>
                                <div class="ingredient-info">
                                    <span class="ingredient-name">@ingredient.Name</span>
                                    @if (!string.IsNullOrEmpty(ingredient.Amount) || !string.IsNullOrEmpty(ingredient.Unit))
                                    {
                                        <span class="ingredient-amount">@ingredient.Amount @ingredient.Unit</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

        <div class="action-buttons mt-4">
            <MudButton Variant="Variant.Filled"
                       Color="@(_recipe.IsHellofresh ? Color.Success : Color.Primary)"
                       FullWidth="true"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Rounded.Add"
                       OnClick="AddToMyListAsync"
                       Disabled="_isProcessing"
                       Style="border-radius: 12px; height: 52px;">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Legger til...</span>
                }
                else
                {
                    <span>Legg til</span>
                }
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mt-3"
                       StartIcon="@Icons.Material.Rounded.Edit"
                       OnClick="CustomizeAndAdd"
                       Style="border-radius: 12px;">
                Kopier og endre
            </MudButton>
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private GlobalRecipeDto? _recipe;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private Guid _currentUserId;

    private bool IsOwner => _recipe?.CreatedByUserId == _currentUserId && _currentUserId != Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserAsync();
        await LoadRecipeAsync();
    }

    private async Task GoBack()
        => await JSRuntime.InvokeVoidAsync("history.back");

    private async Task LoadCurrentUserAsync()
    {
        try
        {
            var user = await ApiClient.GetMyProfileAsync();
            if (user != null)
                _currentUserId = user.Id;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user profile: {ex.Message}");
        }
    }

    private async Task LoadRecipeAsync()
    {
        _isLoading = true;
        try
        {
            _recipe = await ApiClient.GetGlobalRecipeAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add("Feil ved lasting av oppskrift", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task DeletePublishedRecipe()
    {
        if (_recipe == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Slett fra fellesskapet?",
            "Dette fjerner oppskriften fra fellesskapet. Din lokale kopi beholdes.",
            yesText: "Slett", cancelText: "Avbryt");

        if (confirm != true)
            return;

        _isProcessing = true;
        try
        {
            await ApiClient.DeleteGlobalRecipeAsync(_recipe.Id);
            Snackbar.Add("Oppskrift slettet fra fellesskapet", Severity.Success);
            Navigation.NavigateTo("browse");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private string? GetImageUrl()
    {
        if (_recipe == null) return null;
        if (!string.IsNullOrEmpty(_recipe.ImageUrl)) return _recipe.ImageUrl;
        return _recipe.ImageUrls?.FirstOrDefault();
    }

    private async Task AddToMyListAsync()
    {
        if (_recipe == null || _isProcessing)
            return;

        // 1) Choose collection (null => Personlig)
        var selectedCollectionId = await PromptForCollectionAsync();
        if (selectedCollectionId == PromptCanceled)
            return;

        _isProcessing = true;
        try
        {
            // 2) Create recipe
            var created = await CreateUserRecipeFromGlobalAsync(_recipe, selectedCollectionId);

            // 3) Ensure it is added to the selected collection BEFORE navigating
            if (selectedCollectionId.HasValue)
            {
                await CollectionState.AddRecipeToCollectionAsync(selectedCollectionId.Value, created.Id);
            }

            Navigation.NavigateTo($"food/{created.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("Kunne ikke lagre oppskrift", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    // Sentinel to distinguish "user canceled dialog" from "Personlig" (null)
    private static readonly Guid? PromptCanceled = Guid.Empty;

    private async Task<Guid?> PromptForCollectionAsync()
    {
        var dialogRef = await DialogService.ShowAsync<ChooseCollectionDialog>(
            title: "Legg til i samling",
            options: new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            });

        var result = await dialogRef.Result;

        if (result.Canceled)
            return PromptCanceled;

        // Dialog returns Guid? (boxed as Guid when HasValue)
        return result.Data switch
        {
            null => (Guid?)null,     // Personlig
            Guid g => (Guid?)g,      // collection
            _ => (Guid?)null
        };
    }

    private async Task<UserRecipeDto> CreateUserRecipeFromGlobalAsync(GlobalRecipeDto recipe, Guid? selectedCollectionId)
    {
        var imageUrls = recipe.IsHellofresh ? new List<string>() : (recipe.ImageUrls ?? new List<string>());

        // Keep CollectionIds if your backend uses it for other things (e.g. allowed ratings),
        // but collection membership is ensured via AddRecipeToCollectionAsync above.
        var dto = new CreateUserRecipeDto
        {
            Name = recipe.Name,
            Description = recipe.Description,
            ImageUrls = imageUrls,
            GlobalRecipeId = recipe.Id,
            PrepTimeMinutes = recipe.PrepTimeMinutes,
            Servings = recipe.Servings,
            Difficulty = recipe.Difficulty,
            Cuisine = recipe.Cuisine,
            Tags = recipe.Tags,
            Ingredients = recipe.Ingredients,
            NutritionData = recipe.NutritionData,
            Visibility = "private",
            CollectionIds = selectedCollectionId.HasValue
                ? new List<Guid> { selectedCollectionId.Value }
                : new List<Guid>()
        };

        return await RecipeService.CreateRecipeAsync(dto);
    }

    private void CustomizeAndAdd()
    {
        if (_recipe == null) return;

        var imageUrls = _recipe.IsHellofresh ? new List<string>() : (_recipe.ImageUrls ?? new List<string>());

        FoodService.DraftRecipe = new StorhaugenWebsite.Models.FoodItem
        {
            Name = _recipe.Name,
            Description = _recipe.Description,
            ImageUrls = imageUrls,
            GlobalRecipeId = null,
            IsHelloFresh = false,
            PrepTimeMinutes = _recipe.PrepTimeMinutes,
            CookTimeMinutes = _recipe.CookTimeMinutes,
            Servings = _recipe.Servings,
            Difficulty = _recipe.Difficulty,
            Cuisine = _recipe.Cuisine,
            Ingredients = _recipe.Ingredients,
            NutritionData = _recipe.NutritionData
        };

        Navigation.NavigateTo("add");
    }

    private string GetDifficultyIcon(string? difficulty)
        => difficulty?.ToLower() switch
        {
            "easy" or "lett" => Icons.Material.Rounded.SentimentSatisfied,
            "medium" or "middels" => Icons.Material.Rounded.Psychology,
            "hard" or "vanskelig" => Icons.Material.Rounded.LocalFireDepartment,
            _ => Icons.Material.Rounded.HelpOutline
        };

    private string GetDifficultyLabel(string? difficulty)
        => difficulty?.ToLower() switch
        {
            "easy" => "Lett",
            "medium" => "Middels",
            "hard" => "Vanskelig",
            _ => difficulty ?? ""
        };

    private record IngredientInfo(string Name, string? Amount, string? Unit);

    private bool HasIngredients()
    {
        if (_recipe?.Ingredients == null) return false;
        if (_recipe.Ingredients is System.Text.Json.JsonElement jsonElement)
            return jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array && jsonElement.GetArrayLength() > 0;
        return false;
    }

    private List<IngredientInfo> GetIngredients()
    {
        var items = new List<IngredientInfo>();
        if (_recipe?.Ingredients == null) return items;

        try
        {
            if (_recipe.Ingredients is System.Text.Json.JsonElement jsonElement &&
                jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                foreach (var item in jsonElement.EnumerateArray())
                {
                    var name = item.TryGetProperty("name", out var n) ? n.GetString() : "";
                    var amount = item.TryGetProperty("amount", out var a) ? a.ToString() : null;
                    var unit = item.TryGetProperty("unit", out var u) ? u.GetString() : null;

                    if (!string.IsNullOrEmpty(name))
                        items.Add(new IngredientInfo(name!, amount, unit));
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing ingredients: {ex.Message}");
        }

        return items;
    }
}
