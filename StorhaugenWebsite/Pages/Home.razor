@page "/"
@using MudBlazor
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IHouseholdStateService HouseholdState
@inject NavigationManager Navigation
@inject IDeviceStateService DeviceState

@if (HouseholdState.HasHousehold)
{
    <div class="d-flex justify-space-between align-center mb-4">
        <MudMenu AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <div class="sort-dropdown">
                    <MudIcon Icon="@Icons.Material.Rounded.Sort" Size="Size.Small" />
                    <span>@GetSortLabel()</span>
                    <MudIcon Icon="@(_sortDescending? Icons.Material.Rounded.ArrowDownward : Icons.Material.Rounded.ArrowUpward)" Size="Size.Small" />
                </div>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="@(() => SetSort("date"))">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Rounded.CalendarMonth" Size="Size.Small" />
                        <span>Dato</span>
                        @if (_currentSort == "date")
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                        }
                    </div>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => SetSort("average"))">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                        <span>Snitt</span>
                        @if (_currentSort == "average")
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                        }
                    </div>
                </MudMenuItem>
                <MudDivider />
                @if (HouseholdState.CurrentHousehold?.Members != null)
                {
                    @foreach (var member in HouseholdState.CurrentHousehold.Members)
                    {
                        var m = member.DisplayName;
                        <MudMenuItem OnClick="@(() => SetSort(m.ToLower()))">
                            <div class="d-flex align-center gap-2">
                                <div class="member-rating-avatar" style="@($"background: {GetMemberColor(m)}; width: 20px; height: 20px; font-size: 0.65rem;")">@m[0]</div>
                                <span>@m</span>
                                @if (_currentSort == m.ToLower())
                                {
                                    <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Color="Color.Primary" />
                                }
                            </div>
                        </MudMenuItem>
                    }
                }
                <MudDivider />
                <MudMenuItem OnClick="ToggleSortDirection">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@(_sortDescending? Icons.Material.Rounded.ArrowUpward : Icons.Material.Rounded.ArrowDownward)" Size="Size.Small" />
                        <span>@(_sortDescending ? "Stigende" : "Synkende")</span>
                    </div>
                </MudMenuItem>
            </ChildContent>
        </MudMenu>

        <div class="view-toggle">
            <button class="view-toggle-btn @(_viewMode == "card" ? "active" : "")" @onclick="@(() => SetViewMode("card"))">
                <MudIcon Icon="@Icons.Material.Rounded.GridView" Size="Size.Small" />
            </button>
            <button class="view-toggle-btn @(_viewMode == "list" ? "active" : "")" @onclick="@(() => SetViewMode("list"))">
                <MudIcon Icon="@Icons.Material.Rounded.ViewList" Size="Size.Small" />
            </button>
        </div>

    </div>
}

@if (!HouseholdState.HasHousehold)
{
<div class="empty-state">
    <div class="empty-state-icon">
        <MudIcon Icon="@Icons.Material.Rounded.Home" Size="Size.Large" />
    </div>
    <h2 class="empty-state-title">Ingen husstand valgt</h2>
    <p class="empty-state-text">Opprett eller bli med i en husstand for å starte sporing av måltider!</p>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="settings" StartIcon="@Icons.Material.Rounded.Settings">
        Gå til innstillinger
    </MudButton>
</div>
}
else if (_isLoading)
{
    <div class="d-flex flex-column gap-3">
        @for (int i = 0; i < 3; i++)
        {
            <div class="skeleton-card">
                <div class="skeleton-image"></div>
                <div class="skeleton-content">
                    <div class="skeleton-text title"></div>
                    <div class="skeleton-text subtitle"></div>
                </div>
            </div>
        }
    </div>
}
else if (!_foodItems.Any())
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.DinnerDining" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Ingen måltider ennå</h2>
        <p class="empty-state-text">Start med å legge til deres første middag!</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="add" StartIcon="@Icons.Material.Rounded.Add">
            Legg til første måltid
        </MudButton>
    </div>
}
else
{
    @if (_viewMode == "card")
    {
        <div class="d-flex flex-column gap-4">
            @{
                var index = 0;
            }
            @foreach (var food in GetSortedFoods())
            {
                var currentFood = food;
                var delay = index++;
                <div class="food-card animate-in animate-delay-@Math.Min(delay, 4)" @onclick="() => OpenFoodDetail(currentFood)">
                    @if (currentFood.ImageUrls.Any())
                    {
                        <img src="@currentFood.ImageUrls.First()" alt="@currentFood.Name" class="food-card-image" />
                    }
                    else
                    {
                        <div class="food-card-placeholder">
                            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" />
                        </div>
                    }
                    <div class="food-card-content">
                        <div class="d-flex justify-space-between align-start gap-3">
                            <h3 class="food-card-title">@currentFood.Name</h3>
                            <span class="rating-badge @GetRatingClass(currentFood.AverageRating)">
                                <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                                @currentFood.AverageRating.ToString("0.0")
                            </span>
                        </div>
                        <div class="member-ratings">
                            @foreach (var rating in currentFood.Ratings.Where(r => r.Value.HasValue))
                            {
                                var member = rating.Key;
                                var r = rating.Value;
                                <div class="member-rating">
                                    <div class="member-rating-avatar" style="@($"background: {GetMemberColor(member)}")">@member[0]</div>
                                    <span class="member-rating-value">@r</span>
                                </div>
                            }
                        </div>
                        <p class="food-card-meta">@currentFood.DateAdded.ToString("MMM dd, yyyy")</p>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="d-flex flex-column gap-2">
            @{
                var listIndex = 0;
            }
            @foreach (var food in GetSortedFoods())
            {
                var currentFood = food;
                var delay = listIndex++;
                <div class="food-list-item animate-in animate-delay-@Math.Min(delay, 4)" @onclick="() => OpenFoodDetail(currentFood)">
                    @if (currentFood.ImageUrls.Any())
                    {
                        <img src="@currentFood.ImageUrls.First()" alt="@currentFood.Name" class="food-list-image" />
                    }
                    else
                    {
                        <div class="food-list-placeholder">
                            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" />
                        </div>
                    }
                    <div class="food-list-content">
                        <h3 class="food-list-title">@currentFood.Name</h3>
                        <div class="member-ratings">
                            @foreach (var rating in currentFood.Ratings.Where(r => r.Value.HasValue))
                            {
                                var member = rating.Key;
                                var r = rating.Value;
                                <div class="member-rating">
                                    <div class="member-rating-avatar" style="@($"background: {GetMemberColor(member)}")">@member[0]</div>
                                    <span class="member-rating-value">@r</span>
                                </div>
                            }
                        </div>
                        <p class="food-list-date">@currentFood.DateAdded.ToString("MMM dd")</p>
                    </div>
                    <div class="food-list-rating">
                        <span class="rating-badge @GetRatingClass(currentFood.AverageRating)">
                            @currentFood.AverageRating.ToString("0.0")
                        </span>
                    </div>
                </div>
            }
        </div>
    }
}


@code {
    private List<FoodItem> _foodItems = new();
    private bool _isLoading = true;
    private string _currentSort = "date";
    private bool _sortDescending = true;
    private string _viewMode = "card";

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthStateChanged += async () => await InvokeAsync(StateHasChanged);

        HouseholdState.OnHouseholdChanged += async () =>
        {
            // Only load foods if we have a household and haven't loaded them yet
            if (HouseholdState.HasHousehold)
            {
                await LoadFoods();
            }
            await InvokeAsync(StateHasChanged);
        };

        // Load saved preferences
        _viewMode = DeviceState.Settings.ViewMode ?? "card";
        _currentSort = DeviceState.Settings.SortBy ?? "date";
        _sortDescending = DeviceState.Settings.SortDescending;

        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("login");
                return;
            }
        }

        if (HouseholdState.HasHousehold)
        {
            await LoadFoods();
        }
    }

    private async Task LoadFoods()
    {
        _isLoading = true;
        _foodItems = await FoodService.GetAllFoodsAsync(false);
        _isLoading = false;
    }

    private async Task SetViewMode(string mode)
    {
        _viewMode = mode;
        // Save preference using DeviceStateService
        await DeviceState.SetViewModeAsync(mode);
    }

    private async Task SetSort(string sort)
    {
        if (_currentSort == sort)
        {
            _sortDescending = !_sortDescending;
        }
        else
        {
            _currentSort = sort;
            _sortDescending = true;
        }

        // Save sort preference
        await DeviceState.SetSortAsync(_currentSort, _sortDescending);
    }

    private async Task ToggleSortDirection()
    {
        _sortDescending = !_sortDescending;
        // Save sort preference
        await DeviceState.SetSortAsync(_currentSort, _sortDescending);
    }

    private string GetSortLabel()
    {
        if (_currentSort == "date") return "Dato";
        if (_currentSort == "average") return "Snitt";

        // Check if it's a member name
        var member = HouseholdState.CurrentHousehold?.Members
            .FirstOrDefault(m => m.DisplayName.ToLower() == _currentSort);
        if (member != null) return member.DisplayName;

        return "Dato";
    }

    private IEnumerable<FoodItem> GetSortedFoods()
    {
        if (_currentSort == "date")
        {
            return _sortDescending
                ? _foodItems.OrderByDescending(f => f.DateAdded)
                : _foodItems.OrderBy(f => f.DateAdded);
        }

        if (_currentSort == "average")
        {
            return _sortDescending
                ? _foodItems.OrderByDescending(f => f.AverageRating)
                : _foodItems.OrderBy(f => f.AverageRating);
        }

        // Check if sorting by member name
        var memberName = HouseholdState.CurrentHousehold?.Members
            .FirstOrDefault(m => m.DisplayName.ToLower() == _currentSort)?.DisplayName;

        if (memberName != null)
        {
            return _sortDescending
                ? _foodItems.OrderByDescending(f => f.GetRatingForPerson(memberName))
                : _foodItems.OrderBy(f => f.GetRatingForPerson(memberName));
        }

        return _foodItems.OrderByDescending(f => f.DateAdded);
    }

    private void OpenFoodDetail(FoodItem food)
    {
        Navigation.NavigateTo($"food/{food.Id}");
    }

    private string GetRatingClass(double rating)
    {
        return rating switch
        {
            >= 8 => "rating-high",
            >= 5 => "rating-medium",
            _ => "rating-low"
        };
    }

    private string GetMemberColor(string name)
    {
        // Generate a consistent color based on the name
        var hash = name.GetHashCode();
        var hue = Math.Abs(hash % 360);
        return $"hsl({hue}, 45%, 45%)";
    }
}