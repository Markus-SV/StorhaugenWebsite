@page "/"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.ApiClient
@inject IAuthService AuthService
@inject IUserRecipeService RecipeService
@inject IActivityFeedService ActivityService
@inject IHouseholdStateService HouseholdState
@inject NavigationManager Navigation
@inject IDeviceStateService DeviceState
@attribute [Authorize]

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-0"><b>Min Kokebok</b></MudText>

    @* VIEW AND SORT CONTROLS *@
    <div class="d-flex align-center gap-2">
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudChip T="string" Icon="@Icons.Material.Rounded.Sort" Variant="Variant.Outlined" Color="Color.Primary">
                    @GetSortLabel()
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="@(() => SetSort("date"))">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Rounded.CalendarMonth" Size="Size.Small" />
                        <span>Dato</span>
                    </div>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => SetSort("rating"))">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                        <span>Rating</span>
                    </div>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => SetSort("name"))">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Rounded.SortByAlpha" Size="Size.Small" />
                        <span>Navn</span>
                    </div>
                </MudMenuItem>
                <MudDivider />
                <MudMenuItem OnClick="ToggleSortDirection">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@(_sortDescending? Icons.Material.Rounded.ArrowDownward : Icons.Material.Rounded.ArrowUpward)" Size="Size.Small" />
                        <span>@(_sortDescending ? "Synkende" : "Stigende")</span>
                    </div>
                </MudMenuItem>
            </ChildContent>
        </MudMenu>

        <div class="view-toggle">
            <button class="view-toggle-btn @(_viewMode == "card" ? "active" : "")" @onclick="@(() => SetViewMode("card"))">
                <MudIcon Icon="@Icons.Material.Rounded.GridView" Size="Size.Small" />
            </button>
            <button class="view-toggle-btn @(_viewMode == "list" ? "active" : "")" @onclick="@(() => SetViewMode("list"))">
                <MudIcon Icon="@Icons.Material.Rounded.ViewList" Size="Size.Small" />
            </button>
        </div>
    </div>
</div>

<MudGrid>
    @* --- LEFT COLUMN: USER RECIPES --- *@
    <MudItem xs="12" md="8">
        @if (_isLoadingRecipes)
        {
            <div class="d-flex flex-column gap-3">
                @for (int i = 0; i < 3; i++)
                {
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="rounded-lg" />
                }
            </div>
        }
        else if (!_recipes.Any())
        {
            <div class="empty-state pa-8">
                <div class="empty-state-icon">
                    <MudIcon Icon="@Icons.Material.Rounded.MenuBook" Size="Size.Large" />
                </div>
                <h3 class="mt-4">Ingen oppskrifter ennå</h3>
                <p class="mud-text-secondary mb-4">Start din personlige samling nå.</p>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="add" StartIcon="@Icons.Material.Rounded.Add">
                    Ny Oppskrift
                </MudButton>
            </div>
        }
        else
        {
            @if (_viewMode == "card")
            {
                <div class="d-flex flex-column gap-4">
                    @{
                        var index = 0;
                    }
                    @foreach (var recipe in GetSortedRecipes())
                    {
                        var r = recipe;
                        var delay = index++;
                        var animClass = _shouldAnimate ? $"animate-in animate-delay-{Math.Min(delay, 4)}" : "";

                        <div @key="r.Id" class="food-card @animClass" @onclick="() => OpenRecipeDetail(r.Id)">
                            @if (r.ImageUrls.Any())
                            {
                                <img src="@r.ImageUrls.First()" alt="@r.Name" class="food-card-image" />
                            }
                            else
                            {
                                <div class="food-card-placeholder">
                                    <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" />
                                </div>
                            }

                            <div class="food-card-content">
                                <div class="d-flex justify-space-between align-start gap-3">
                                    <h3 class="food-card-title">@r.Name</h3>
                                    @if (r.AverageRating > 0)
                                    {
                                        <span class="rating-badge @GetRatingClass(r.AverageRating)">
                                            <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                                            @r.AverageRating.ToString("0.0")
                                        </span>
                                    }
                                </div>

                                <div class="d-flex gap-2 mt-2">
                                    @if (r.IsLinkedToGlobal)
                                    {
                                        <MudTooltip Text="Linked to Global Recipe">
                                            <MudIcon Icon="@Icons.Material.Rounded.Public" Size="Size.Small" Color="Color.Info" />
                                        </MudTooltip>
                                    }
                                    @if (r.Visibility == "public")
                                    {
                                        <MudTooltip Text="Published to Community">
                                            <MudIcon Icon="@Icons.Material.Rounded.Share" Size="Size.Small" Color="Color.Success" />
                                        </MudTooltip>
                                    }
                                </div>

                                <p class="food-card-meta mt-2">
                                    Lagt til @r.CreatedAt.ToString("d. MMM yyyy")
                                </p>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                // LIST VIEW
                <div class="d-flex flex-column gap-2">
                    @{
                        var listIndex = 0;
                    }
                    @foreach (var recipe in GetSortedRecipes())
                    {
                        var r = recipe;
                        var delay = listIndex++;
                        var animClass = _shouldAnimate ? $"animate-in animate-delay-{Math.Min(delay, 4)}" : "";

                        <div @key="r.Id" class="food-list-item @animClass" @onclick="() => OpenRecipeDetail(r.Id)">
                            @if (r.ImageUrls.Any())
                            {
                                <img src="@r.ImageUrls.First()" alt="@r.Name" class="food-list-image" />
                            }
                            else
                            {
                                <div class="food-list-placeholder">
                                    <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" />
                                </div>
                            }
                            <div class="food-list-content">
                                <h3 class="food-list-title">@r.Name</h3>
                                <p class="food-list-date">@r.CreatedAt.ToString("MMM dd")</p>
                            </div>
                            <div class="food-list-rating">
                                @if (r.AverageRating > 0)
                                {
                                    <span class="rating-badge @GetRatingClass(r.AverageRating)">
                                        @r.AverageRating.ToString("0.0")
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </MudItem>

    @* --- RIGHT COLUMN: ACTIVITY FEED --- *@
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4 rounded-lg" Elevation="0" Outlined="true">
            <div class="d-flex align-center gap-2 mb-4">
                <MudIcon Icon="@Icons.Material.Rounded.ShowChart" Color="Color.Secondary" />
                <MudText Typo="Typo.h6">Aktivitet</MudText>
            </div>

            @if (_isLoadingFeed)
            {
                <MudStack>
                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" />
                    <MudSkeleton Width="100%" />
                    <MudSkeleton Width="80%" />
                </MudStack>
            }
            else if (!_activities.Any())
            {
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Ingen nylig aktivitet fra dine venner eller husstand.</MudText>
            }
            else
            {
                <div class="d-flex flex-column gap-3">
                    @foreach (var activity in _activities)
                    {
                        <div class="d-flex gap-3 align-start">
                            <MudAvatar Size="Size.Medium" Color="Color.Tertiary" Variant="Variant.Filled">
                                @if (!string.IsNullOrEmpty(activity.UserAvatarUrl))
                                {
                                    <MudImage Src="@activity.UserAvatarUrl" />
                                }
                                else
                                {
                                    @activity.UserDisplayName.FirstOrDefault()
                                }
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.body2">
                                    <b>@activity.UserDisplayName</b>
                                    <span class="mud-text-secondary">@GetActivityActionText(activity)</span>
                                    <b>@activity.RecipeName</b>
                                </MudText>
                                @if (activity.RatingScore.HasValue)
                                {
                                    <div class="d-flex align-center mt-1">
                                        <MudRating ReadOnly="true" SelectedValue="@activity.RatingScore.Value" Size="Size.Small" />
                                    </div>
                                }
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    @GetTimeAgo(activity.CreatedAt)
                                </MudText>
                            </div>
                        </div>
                        <MudDivider Class="my-2" />
                    }
                    <MudButton Variant="Variant.Text" Size="Size.Small" FullWidth="true" Href="feed">Se mer</MudButton>
                </div>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<UserRecipeDto> _recipes = new();
    private List<ActivityFeedItemDto> _activities = new();

    private bool _isLoadingRecipes = true;
    private bool _isLoadingFeed = true;

    // UI State
    private string _currentSort = "date";
    private bool _sortDescending = true;
    private string _viewMode = "card";
    private bool _shouldAnimate = true;

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnAuthStateChanged += async () => await InvokeAsync(StateHasChanged);

        // Load View Settings
        _viewMode = DeviceState.Settings.ViewMode ?? "card";
        _currentSort = DeviceState.Settings.SortBy ?? "date";
        _sortDescending = DeviceState.Settings.SortDescending;

        // Fetch Data Parallel
        await Task.WhenAll(LoadRecipes(), LoadActivityFeed());
    }

    private async Task LoadRecipes()
    {
        try
        {
            _isLoadingRecipes = true;
            // Check cache first if implemented in service
            if (RecipeService.CachedRecipes != null && RecipeService.CachedRecipes.Any())
            {
                _recipes = RecipeService.CachedRecipes;
                _shouldAnimate = false;
            }
            else
            {
                // Fetch fresh
                var result = await RecipeService.GetMyRecipesAsync(new GetUserRecipesQuery { PageSize = 100 });
                _recipes = result.Recipes;
                _shouldAnimate = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading recipes: {ex.Message}");
        }
        finally
        {
            _isLoadingRecipes = false;
            StateHasChanged();
        }
    }

    private async Task LoadActivityFeed()
    {
        try
        {
            _isLoadingFeed = true;
            var result = await ActivityService.GetFeedAsync(new ActivityFeedQuery { PageSize = 5 });
            _activities = result.Items;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading feed: {ex.Message}");
        }
        finally
        {
            _isLoadingFeed = false;
            StateHasChanged();
        }
    }

    // --- Sorting Logic ---
    private IEnumerable<UserRecipeDto> GetSortedRecipes()
    {
        return _currentSort switch
        {
            "date" => _sortDescending ? _recipes.OrderByDescending(r => r.CreatedAt) : _recipes.OrderBy(r => r.CreatedAt),
            "rating" => _sortDescending ? _recipes.OrderByDescending(r => r.AverageRating) : _recipes.OrderBy(r => r.AverageRating),
            "name" => _sortDescending ? _recipes.OrderByDescending(r => r.Name) : _recipes.OrderBy(r => r.Name),
            _ => _recipes // Default
        };
    }

    private async Task SetSort(string sort)
    {
        _shouldAnimate = true;
        if (_currentSort == sort) _sortDescending = !_sortDescending;
        else
        {
            _currentSort = sort;
            _sortDescending = true;
        }
        await DeviceState.SetSortAsync(_currentSort, _sortDescending);
    }

    private async Task ToggleSortDirection()
    {
        _shouldAnimate = true;
        _sortDescending = !_sortDescending;
        await DeviceState.SetSortAsync(_currentSort, _sortDescending);
    }

    private string GetSortLabel()
    {
        return _currentSort switch
        {
            "date" => "Dato",
            "rating" => "Rating",
            "name" => "Navn",
            _ => "Sorter"
        };
    }

    // --- View Mode ---
    private async Task SetViewMode(string mode)
    {
        if (_viewMode == mode) return;
        _shouldAnimate = true;
        _viewMode = mode;
        await DeviceState.SetViewModeAsync(mode);
    }

    // --- Navigation ---
    private void OpenRecipeDetail(Guid id)
    {
        Navigation.NavigateTo($"food/{id}");
    }

    // --- Helpers ---
    private string GetRatingClass(double rating)
    {
        return rating switch
        {
            >= 8 => "rating-high",
            >= 5 => "rating-medium",
            _ => "rating-low"
        };
    }

    private string GetActivityActionText(ActivityFeedItemDto item)
    {
        return item.ActivityType switch
        {
            "rated" => "ga karakter til",
            "added" => "la til",
            "published" => "delte",
            "forked" => "kopierte",
            _ => "handlet med"
        };
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalMinutes < 60) return $"For {Math.Max(1, (int)span.TotalMinutes)}m siden";
        if (span.TotalHours < 24) return $"For {(int)span.TotalHours}t siden";
        return date.ToString("d. MMM");
    }
}