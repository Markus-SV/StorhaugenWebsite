@page "/add"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IUserRecipeService RecipeService
@inject IHouseholdStateService HouseholdState
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IOcrService OcrService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

@* --- 1. LANDSCAPE BLOCKER --- *@
<div id="landscape-blocker">
    <MudIcon Icon="@Icons.Material.Rounded.ScreenLockPortrait" Style="font-size: 64px; margin-bottom: 20px; color: #E07A2E;" />
    <h2 style="font-family: 'Fraunces', serif;">Vennligst snu telefonen</h2>
    <p style="opacity: 0.7; max-width: 300px; margin-top: 10px;">Storhaugen Eats er designet for å brukes i portrettmodus.</p>
</div>

@* --- 2. CAMERA OVERLAY UI --- *@
@if (_showCameraOverlay)
{
    <div class="camera-overlay">
        <video @ref="_videoElement" autoplay playsinline muted class="camera-video"></video>
        <div class="camera-guide-container @GetOverlayClass()">
            <div class="camera-guide-box">
                @if (_currentStep == ScanStep.Front)
                {
                    <div class="logo-hint-zone">
                        <svg width="60" height="80" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg" fill="#fff">
                            <path d="M50 0 C25 0 5 20 5 45 C5 70 25 90 50 90 C75 90 95 70 95 45 C95 35 90 15 80 5" fill="#9ACD32" />
                            <path d="M80 5 C85 0 95 0 95 10 C95 5 85 5 80 5 Z" fill="#76a11e" />
                            <text x="50" y="105" font-family="Arial, sans-serif" font-weight="900" font-size="14" text-anchor="middle" letter-spacing="1">HELLO</text>
                            <text x="50" y="118" font-family="Arial, sans-serif" font-weight="900" font-size="14" text-anchor="middle" letter-spacing="1">FRESH</text>
                        </svg>
                    </div>
                    <div class="text-hint-zone"><span class="text-label">TITTEL HER</span></div>
                }
                <div class="scan-line"></div>
            </div>
            <div class="camera-instruction-pill">
                <MudIcon Icon="@GetStepIcon()" Size="Size.Small" Class="mr-2" Style="color: #00E676;" />
                <span class="step-text">@GetStepTitle()</span>
            </div>
            <p class="camera-guide-text">@GetInstructionText()</p>
        </div>
        <div class="camera-controls">
            <MudIconButton Icon="@Icons.Material.Rounded.Close" Color="Color.Surface" Size="Size.Large" OnClick="StopCamera" />
            <button class="camera-shutter @(_isProcessingOcr ? "processing" : "")" disabled="@_isProcessingOcr" @onclick="CaptureCameraImage"></button>
            <div class="step-counter">@((int)_currentStep + 1) / 3</div>
        </div>
    </div>
}

<div class="app-content-container">
    @if (!HouseholdState.HasHousehold)
    {
        <div class="empty-state pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Rounded.Home" Size="Size.Large" Class="mb-4" />
            <h2>Ingen husstand valgt</h2>
            <p class="mb-4">Du må opprette eller bli med i en husstand.</p>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="settings">Gå til innstillinger</MudButton>
        </div>
    }
    else
    {
        <div class="d-flex justify-space-between align-center mb-4">
            <div>
                <h1 class="page-title" style="margin-bottom: 4px; font-size: 24px; font-weight: 700;">Legg til måltid</h1>
                <p class="page-subtitle" style="color: var(--mud-palette-text-secondary);">
                    @(_fromDraft ? "Tilpass kopiert oppskrift" : "Gi kveldens middag en vurdering")
                </p>
            </div>
        </div>

        <MudPaper Class="pa-2 mb-6 d-flex justify-center gap-2" Elevation="0" Style="background: var(--mud-palette-background-grey); border-radius: 12px;">
            <MudButton Variant="@(_isHelloFresh? Variant.Filled: Variant.Text)" Color="Color.Success" OnClick="@(() => SetFoodType(true))" Class="flex-1" Style="border-radius: 10px;" StartIcon="@Icons.Custom.Brands.MudBlazor">HelloFresh</MudButton>
            <MudButton Variant="@(!_isHelloFresh ? Variant.Filled : Variant.Text)" Color="Color.Primary" OnClick="@(() => SetFoodType(false))" Class="flex-1" Style="border-radius: 10px;" StartIcon="@Icons.Material.Rounded.Restaurant">Annet</MudButton>
        </MudPaper>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)">@_errorMessage</MudAlert>
        }

        <div class="form-section">
            <div class="d-flex justify-space-between align-center">
                <p class="form-section-title">Måltidsdetaljer</p>
                @if (_isHelloFresh && _isProcessingOcr)
                {
                    <MudChip Size="Size.Small" Color="Color.Success" T="string" Variant="Variant.Text" Icon="@Icons.Material.Rounded.AutoAwesome">Analyserer...</MudChip>
                }
            </div>

            <MudTextField @bind-Value="_newFood.Name"
                          Label="@(_isHelloFresh ? "Navn på rett" : "Hva spiste vi?")"
                          Variant="Variant.Outlined"
                          Placeholder="@(_isHelloFresh ? "Skann forside for å fylle ut..." : "f.eks. Bestemors lasagne")"
                          Required="true"
                          Class="mb-4"
                          Style="--mud-default-borderradius: 12px;" />

            <MudTextField @bind-Value="_newFood.Description"
                          Label="Beskrivelse / Ingredienser"
                          Variant="Variant.Outlined"
                          Lines="8"
                          Placeholder="Ingredienser blir lagt til her..."
                          Style="--mud-default-borderradius: 12px;" />
        </div>

        <div class="form-section">
            <p class="form-section-title">Bilder</p>

            @if (_imagePreviewUrls.Any())
            {
                <div class="image-preview-grid">
                    @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                    {
                        var index = i;
                        <div class="image-preview-item">
                            <img src="@_imagePreviewUrls[index]" />
                            <button class="image-preview-remove" @onclick="@(() => RemoveImage(index))">
                                <MudIcon Icon="@Icons.Material.Rounded.Close" Size="Size.Small" />
                            </button>
                        </div>
                    }
                </div>
            }

            <div class="d-flex gap-3 w-100">
                @if (_isHelloFresh)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Rounded.DocumentScanner" Size="Size.Large" OnClick="StartCamera" Class="flex-1" Style="border-radius: 12px; height: 56px;">Skann</MudButton>
                }
                else
                {
                    <MudFileUpload T="IReadOnlyList<IBrowserFile>" @ref="@_fileUpload" FilesChanged="OnImagesSelected" Accept="image/*" MaximumFileCount="5" Class="flex-1" @attributes="@(new Dictionary<string, object> { { "capture", "environment" } })">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Rounded.CameraAlt" Size="Size.Large" FullWidth="true" Style="border-radius: 12px; height: 56px;">Ta bilde</MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                }
                <input type="file" id="galleryInput" accept="image/*, .heic" multiple style="display: none;" @onchange="OnGalleryFileSelected" />
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Rounded.PhotoLibrary" Size="Size.Large" OnClick="TriggerGalleryClick" Class="flex-1" Style="border-radius: 12px; height: 56px; border-style: dashed; border-width: 2px;">Galleri</MudButton>
            </div>
        </div>

        <div class="form-section">
            <div class="d-flex justify-space-between align-center mb-4">
                <p class="form-section-title mb-0">Hvordan smakte det?</p>
                <MudSwitch T="bool" @bind-Value="_ratingEnabled" Color="Color.Primary" Label="Gi vurdering" />
            </div>

            @if (_ratingEnabled)
            {
                <div class="d-flex flex-column gap-4">
                    @foreach (var member in _householdMembers)
                    {
                        var isMe = member.DisplayName == _currentUserName;
                        bool included = IsMemberIncluded(member.UserId);
                        int rating = GetMemberRating(member.UserId);

                        <div class="rating-member-row">
                            <div class="d-flex justify-space-between align-center mb-1">
                                <div class="d-flex align-center gap-2" style="opacity: @(included ? "1" : "0.5")">
                                    <MudAvatar Size="Size.Small" Style="@($"background: {GetMemberColor(member.DisplayName)}")">
                                        @(string.IsNullOrEmpty(member.DisplayName) ? '?' : member.DisplayName[0])
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">@member.DisplayName @(isMe ? "(Deg)" : "")</MudText>
                                </div>
                                <MudCheckBox T="bool" Value="included" ValueChanged="@((bool v) => SetMemberIncluded(member.UserId, v))" Color="Color.Primary" Dense="true" Size="Size.Small" Label="Spiste" LabelPosition="LabelPosition.Start" />
                            </div>

                            @if (included)
                            {
                                <div class="d-flex align-center gap-3 animate-in">
                                    <MudSlider T="int" Value="rating" ValueChanged="@((int v) => SetMemberRating(member.UserId, v))" Min="1" Max="10" Step="1" Color="Color.Primary" Class="flex-1" />
                                    <div style="background: @GetRatingBackground(rating); color: @GetRatingTextColor(rating); padding: 2px 10px; border-radius: 8px; font-weight: bold; min-width: 36px; text-align: center;">@rating</div>
                                </div>
                            }
                        </div>
                        @if (member != _householdMembers.Last())
                        {
                            <MudDivider Class="my-2" />
                        }
                    }
                </div>
            }
        </div>

        <div class="form-section">
            <MudSelect T="string" Label="Synlighet" @bind-Value="_visibility" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" AdornmentIcon="@Icons.Material.Rounded.Visibility">
                <MudSelectItem Value="@("private")">Privat (Kun deg)</MudSelectItem>
                <MudSelectItem Value="@("household")">Husstand</MudSelectItem>
                <MudSelectItem Value="@("friends")">Venner</MudSelectItem>
                <MudSelectItem Value="@("public")">Offentlig (Alle)</MudSelectItem>
            </MudSelect>

            <MudButton Variant="Variant.Filled"
                       Color="@(_isHelloFresh ? Color.Success : Color.Primary)"
                       Size="Size.Large"
                       FullWidth="true"
                       OnClick="SubmitFood"
                       Disabled="_isSubmitting"
                       Class="mt-4"
                       Style="border-radius: 14px; padding: 14px;">
                @if (_isSubmitting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
                    <span>Lagrer...</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Rounded.Check" Class="mr-2" />
                    <span>Lagre måltid</span>
                }
            </MudButton>
        </div>
    }
</div>

@code {
    #region State Variables
    private FoodItem _newFood = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private bool _isSubmitting = false;
    private bool _fromDraft = false;
    private string? _errorMessage;
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private List<string> _draftImageUrls = new();
    private bool _ratingEnabled = true;
    private string _currentUserName = "";
    private bool _isHelloFresh = true;
    private string _visibility = "household"; // Default for easier sharing
    #endregion

    #region Camera & OCR State
    private ElementReference _videoElement;
    private bool _showCameraOverlay = false;
    private bool _isProcessingOcr = false;
    private enum ScanStep { Front, Ingredients, Back, Finished }
    private ScanStep _currentStep = ScanStep.Front;
    public class ProcessedImage { public string Name { get; set; } = ""; public string Data { get; set; } = ""; }
    #endregion

    #region Household & Ratings State
    private Dictionary<Guid, int> _memberRatings = new();
    private Dictionary<Guid, bool> _memberIncluded = new();
    private List<HouseholdMemberDto> _householdMembers = new();
    #endregion

    protected override async Task OnInitializedAsync()
    {
        await HouseholdState.InitializeAsync();

        if (HouseholdState.HasHousehold)
        {
            _currentUserName = AuthService.CurrentUserName ?? "Unknown";
            _householdMembers = HouseholdState.CurrentHousehold?.Members ?? new();

            // Initialize ratings with safe defaults
            foreach (var member in _householdMembers)
            {
                if (!_memberIncluded.ContainsKey(member.UserId)) _memberIncluded[member.UserId] = true;
                if (!_memberRatings.ContainsKey(member.UserId)) _memberRatings[member.UserId] = 5;
            }
        }

        if (FoodService.DraftRecipe != null)
        {
            LoadDraft(FoodService.DraftRecipe);
        }
    }

    private void LoadDraft(FoodItem draft)
    {
        _newFood.Name = draft.Name;
        _newFood.Description = draft.Description;
        _fromDraft = true;
        if (draft.ImageUrls != null)
        {
            _imagePreviewUrls.AddRange(draft.ImageUrls);
            _draftImageUrls.AddRange(draft.ImageUrls);
        }
        FoodService.DraftRecipe = null;
    }

    private void SetFoodType(bool isHelloFresh) => _isHelloFresh = isHelloFresh;

    #region Dictionary Helpers (Prevents KeyNotFoundException)
    private bool IsMemberIncluded(Guid userId) => _memberIncluded.ContainsKey(userId) && _memberIncluded[userId];
    private int GetMemberRating(Guid userId) => _memberRatings.ContainsKey(userId) ? _memberRatings[userId] : 5;
    private void SetMemberIncluded(Guid userId, bool value) => _memberIncluded[userId] = value;
    private void SetMemberRating(Guid userId, int value) => _memberRatings[userId] = value;
    #endregion

    #region Submission Logic
    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Navn mangler.";
            return;
        }
        _isSubmitting = true;
        try
        {
            var urls = new List<string>(_draftImageUrls);
            for (int i = 0; i < _imageData.Count; i++)
                urls.Add(await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]));

            var ratingsToSend = new Dictionary<Guid, int>();
            if (_ratingEnabled)
            {
                foreach (var member in _householdMembers)
                {
                    if (IsMemberIncluded(member.UserId))
                    {
                        ratingsToSend[member.UserId] = GetMemberRating(member.UserId);
                    }
                }
            }

            var createDto = new CreateUserRecipeDto
            {
                Name = _newFood.Name,
                Description = _newFood.Description,
                ImageUrls = urls,
                PersonalNotes = _newFood.PersonalNotes,
                GlobalRecipeId = _newFood.GlobalRecipeId,
                Visibility = _visibility,
                MemberRatings = ratingsToSend
            };

            await RecipeService.CreateRecipeAsync(createDto);
            RecipeService.InvalidateCache();
            Navigation.NavigateTo("/");
        }
        catch (Exception ex) { _errorMessage = ex.Message; }
        finally { _isSubmitting = false; }
    }
    #endregion

    #region Image & OCR
    private async Task TriggerGalleryClick() => await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('galleryInput').click()");

    private async Task OnGalleryFileSelected()
    {
        try
        {
            _isSubmitting = true;
            if (_isHelloFresh) _isProcessingOcr = true;
            StateHasChanged();

            var images = await JSRuntime.InvokeAsync<List<ProcessedImage>>("imageTools.processInputFile", "galleryInput");
            if (images == null || images.Count == 0) return;

            bool ingredientsFound = false;

            for (int i = 0; i < images.Count; i++)
            {
                var img = images[i];
                if (_imageData.Count < 5)
                {
                    var base64Pure = img.Data.Split(',')[1];
                    _imageData.Add(Convert.FromBase64String(base64Pure));
                    _imagePreviewUrls.Add(img.Data);
                    _imageNames.Add(img.Name);
                }

                if (_isHelloFresh)
                {
                    if (i == 0 && string.IsNullOrWhiteSpace(_newFood.Name))
                    {
                        Snackbar.Add("Analyserer forside...", Severity.Info);
                        await TryAutoFillTitle(img.Data);
                    }
                    if (!ingredientsFound && string.IsNullOrWhiteSpace(_newFood.Description))
                    {
                        if (i == 0 && !string.IsNullOrWhiteSpace(_newFood.Name)) continue;
                        Snackbar.Add($"Ser etter ingredienser (Bilde {i + 1})...", Severity.Info);
                        ingredientsFound = await TryExtractIngredients(img.Data);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Feil i galleri-opplasting: {ex.Message}");
            Snackbar.Add("Noe gikk galt med bildebehandlingen.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            _isProcessingOcr = false;
            StateHasChanged();
        }
    }

    private async Task TryAutoFillTitle(string dataUrl)
    {
        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);
            if (!string.IsNullOrWhiteSpace(rawText))
            {
                var lines = rawText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                foreach (var line in lines)
                {
                    var cleanLine = line.Trim();
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\b(HELLO|FRESH|OPPSKRIFT|RECIPE)\b", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"^[^a-zA-ZæøåÆØÅ0-9]+", "").Trim();

                    if (cleanLine.Length > 5 && cleanLine.Length < 60 && cleanLine.Any(char.IsLetter))
                    {
                        _newFood.Name = char.ToUpper(cleanLine[0]) + cleanLine.Substring(1);
                        Snackbar.Add($"Tittel funnet: {_newFood.Name}", Severity.Success);
                        await InvokeAsync(StateHasChanged);
                        break;
                    }
                }
            }
        }
        catch (Exception ex) { Console.WriteLine($"Title OCR Error: {ex}"); }
    }

    private async Task<bool> TryExtractIngredients(string dataUrl)
    {
        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);
            if (string.IsNullOrWhiteSpace(rawText)) return false;

            var rawLines = rawText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
            var flattenedList = new List<string>();

            foreach (var line in rawLines)
            {
                var columns = System.Text.RegularExpressions.Regex.Split(line, @"\s{3,}");
                foreach (var col in columns)
                {
                    var trimmed = System.Text.RegularExpressions.Regex.Replace(col.Trim(), @"^[^a-zA-ZæøåÆØÅ0-9]+", "").Trim();
                    if (trimmed.Length > 2) flattenedList.Add(trimmed);
                }
            }

            var cleanIngredients = new List<string>();
            int foodConfidence = 0;
            var commonFoodWords = new HashSet<string>(StringComparer.OrdinalIgnoreCase) {
                "gulrot", "potet", "løk", "hvitløk", "tomat", "agurk", "salat", "kylling", "kjøtt", "biff", "svin", "fisk", "laks", "torsk",
                "ris", "pasta", "nudler", "saus", "fløte", "rømme", "ost", "smør", "olje", "krydder", "salt", "pepper"
            };

            foreach (var currentLine in flattenedList)
            {
                if (currentLine.Split(' ').Any(word => commonFoodWords.Contains(word.Trim(',', '.')))) foodConfidence++;

                bool isContinuation = cleanIngredients.Count > 0 && (char.IsLower(currentLine[0]) || currentLine.StartsWith("("));
                if (isContinuation)
                {
                    int lastIdx = cleanIngredients.Count - 1;
                    cleanIngredients[lastIdx] = cleanIngredients[lastIdx] + " " + currentLine;
                }
                else
                {
                    cleanIngredients.Add(char.ToUpper(currentLine[0]) + currentLine.Substring(1));
                }
            }

            if (foodConfidence >= 2 || (cleanIngredients.Count >= 4 && cleanIngredients.All(i => i.Length < 50)))
            {
                cleanIngredients = cleanIngredients.Distinct().ToList();
                if (cleanIngredients.Count > 0)
                {
                    _newFood.Description = "Ingredienser:\n" + string.Join("\n", cleanIngredients);
                    await InvokeAsync(StateHasChanged);
                    return true;
                }
            }
            return false;
        }
        catch (Exception ex) { Console.WriteLine($"Ingredient OCR Error: {ex.Message}"); return false; }
    }

    private async Task StartCamera()
    {
        _currentStep = ScanStep.Front;
        _showCameraOverlay = true;
        await Task.Delay(100);
        try { await JSRuntime.InvokeVoidAsync("cameraInterop.start", _videoElement); }
        catch (Exception) { Snackbar.Add("Kunne ikke starte kamera.", Severity.Error); _showCameraOverlay = false; }
    }
    private async Task StopCamera() { await JSRuntime.InvokeVoidAsync("cameraInterop.stop", _videoElement); _showCameraOverlay = false; }

    private async Task CaptureCameraImage()
    {
        if (_isProcessingOcr) return;
        _isProcessingOcr = true;
        StateHasChanged();
        try
        {
            var base64Data = await JSRuntime.InvokeAsync<string>("cameraInterop.capture", _videoElement);
            var cleanBase64 = base64Data.Contains(",") ? base64Data.Split(',')[1] : base64Data;
            _imagePreviewUrls.Add(base64Data);
            _imageData.Add(Convert.FromBase64String(cleanBase64));

            if (_currentStep == ScanStep.Front)
            {
                _imageNames.Add("hf_front.jpg");
                Snackbar.Add("Forside fanget! Analyserer...", Severity.Info);
                await TryAutoFillTitle(base64Data);
                _currentStep = ScanStep.Ingredients;
            }
            else if (_currentStep == ScanStep.Ingredients)
            {
                _imageNames.Add("hf_ingr.jpg");
                Snackbar.Add("Ingredienser fanget!", Severity.Info);
                await TryExtractIngredients(base64Data);
                _currentStep = ScanStep.Back;
            }
            else if (_currentStep == ScanStep.Back)
            {
                _imageNames.Add("hf_back.jpg");
                Snackbar.Add("Ferdig!", Severity.Success);
                await StopCamera();
                _currentStep = ScanStep.Finished;
            }
        }
        catch { Snackbar.Add("Feil ved bildeopptak.", Severity.Error); }
        finally { _isProcessingOcr = false; StateHasChanged(); }
    }

    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (_imageData.Count >= 5) break;
            var fileToRead = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);
            using var stream = fileToRead.OpenReadStream(30 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            _imagePreviewUrls.Add($"data:image/jpeg;base64,{Convert.ToBase64String(buffer)}");
            _imageData.Add(buffer);
            _imageNames.Add(file.Name);
        }
    }
    private void RemoveImage(int index)
    {
        if (index < _draftImageUrls.Count) { _draftImageUrls.RemoveAt(index); _imagePreviewUrls.RemoveAt(index); }
        else
        {
            var newIdx = index - _draftImageUrls.Count;
            if (newIdx >= 0 && newIdx < _imageData.Count) { _imageData.RemoveAt(newIdx); _imageNames.RemoveAt(newIdx); _imagePreviewUrls.RemoveAt(index); }
        }
    }
    #endregion

    #region Helpers
    private string GetMemberColor(string? n) => string.IsNullOrEmpty(n) ? "grey" : $"hsl({Math.Abs(n.GetHashCode() % 360)}, 45%, 45%)";
    private string GetRatingBackground(int r) => r >= 8 ? "rgba(45,90,69,0.15)" : r >= 5 ? "rgba(212,160,23,0.15)" : "rgba(196,69,54,0.15)";
    private string GetRatingTextColor(int r) => r >= 8 ? "#2D5A45" : r >= 5 ? "#A17D00" : "#C44536";
    private string GetOverlayClass() => _currentStep switch { ScanStep.Front => "step-landscape", ScanStep.Ingredients => "step-portrait-tall", _ => "step-portrait-normal" };
    private string GetStepTitle() => _currentStep switch { ScanStep.Front => "1: FORSIDE (SNU)", ScanStep.Ingredients => "2: INGREDIENSER", ScanStep.Back => "3: FREMGANGSMÅTE", _ => "" };
    private string GetInstructionText() => _currentStep == ScanStep.Front ? "Hold telefonen vannrett." : "Hold telefonen loddrett.";
    private string GetStepIcon() => _currentStep == ScanStep.Front ? Icons.Material.Rounded.ScreenRotation : Icons.Material.Rounded.CropPortrait;
    #endregion

}