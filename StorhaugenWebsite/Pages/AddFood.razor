@page "/add"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.DTOs
@using System.Text.Json
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IUserRecipeService RecipeService
@inject ICollectionStateService CollectionState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@attribute [Authorize]

@* --- 1. LANDSCAPE BLOCKER --- *@
<div id="landscape-blocker">
    <MudIcon Icon="@Icons.Material.Rounded.ScreenLockPortrait" Style="font-size: 64px; margin-bottom: 20px; color: #E07A2E;" />
    <h2 style="font-family: 'Fraunces', serif;">Vennligst snu telefonen</h2>
    <p style="opacity: 0.7; max-width: 300px; margin-top: 10px;">Storhaugen Eats er designet for å brukes i portrettmodus.</p>
</div>

<div class="app-content-container">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <h1 class="page-title" style="margin-bottom: 4px; font-size: 24px; font-weight: 700;">Legg til måltid</h1>
            <p class="page-subtitle" style="color: var(--mud-palette-text-secondary);">
                @(_fromDraft ? "Tilpass kopiert oppskrift" : "Gi kveldens middag en vurdering")
            </p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)">@_errorMessage</MudAlert>
    }

    <div class="form-section">
        <div class="d-flex justify-space-between align-center">
            <p class="form-section-title">Måltidsdetaljer</p>
        </div>

        <MudTextField @bind-Value="_newFood.Name"
                      Label="Hva spiste vi?"
                      Variant="Variant.Outlined"
                      Placeholder="f.eks. Bestemors lasagne"
                      Required="true"
                      Class="mb-4"
                      Style="--mud-default-borderradius: 12px;" />

        <MudTextField @bind-Value="_newFood.Description"
                      Label="Beskrivelse"
                      Variant="Variant.Outlined"
                      Lines="4"
                      Placeholder="Beskriv retten..."
                      Style="--mud-default-borderradius: 12px;" />

        @* Collapsible structured ingredients section *@
        <MudExpansionPanels Class="mt-4" Elevation="0">
            <MudExpansionPanel Text="@GetIngredientsTitle()" Icon="@Icons.Material.Rounded.ShoppingCart" Style="background: var(--mud-palette-background); border-radius: 12px;">
                <div class="d-flex flex-column gap-2">
                    @for (int i = 0; i < _structuredIngredients.Count; i++)
                    {
                        var index = i;
                        <div class="d-flex gap-2 align-center">
                            <MudTextField @bind-Value="_structuredIngredients[index].Name"
                                          Label="Ingrediens"
                                          Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Style="flex: 2; --mud-default-borderradius: 8px;" />
                            <MudTextField @bind-Value="_structuredIngredients[index].Amount"
                                          Label="Mengde"
                                          Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Style="flex: 1; --mud-default-borderradius: 8px;" />
                            <MudSelect T="string" @bind-Value="_structuredIngredients[index].Unit"
                                       Label="Enhet"
                                       Variant="Variant.Outlined"
                                       Dense="true"
                                       Style="flex: 1; --mud-default-borderradius: 8px;">
                                <MudSelectItem Value="@("")">-</MudSelectItem>
                                <MudSelectItem Value="@("stk")">stk</MudSelectItem>
                                <MudSelectItem Value="@("g")">g</MudSelectItem>
                                <MudSelectItem Value="@("kg")">kg</MudSelectItem>
                                <MudSelectItem Value="@("dl")">dl</MudSelectItem>
                                <MudSelectItem Value="@("l")">l</MudSelectItem>
                                <MudSelectItem Value="@("ss")">ss</MudSelectItem>
                                <MudSelectItem Value="@("ts")">ts</MudSelectItem>
                                <MudSelectItem Value="@("fedd")">fedd</MudSelectItem>
                            </MudSelect>
                            <MudIconButton Icon="@Icons.Material.Rounded.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => RemoveIngredient(index))" />
                        </div>
                    }
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Rounded.Add"
                               Size="Size.Small"
                               OnClick="AddIngredient"
                               Class="mt-2">
                        Legg til ingrediens
                    </MudButton>
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>

        @* Collapsible metadata section *@
        <MudExpansionPanels Class="mt-4" Elevation="0">
            <MudExpansionPanel Text="Tilleggsinfo" Style="background: var(--mud-palette-background); border-radius: 12px;">
                <div class="d-flex flex-wrap gap-3">
                    <MudNumericField T="int?" @bind-Value="_newFood.PrepTimeMinutes"
                                     Label="Tilberedningstid (min)"
                                     Variant="Variant.Outlined"
                                     Min="1" Max="300"
                                     Style="flex: 1; min-width: 140px; --mud-default-borderradius: 10px;"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Rounded.AccessTime" />

                    <MudNumericField T="int?" @bind-Value="_newFood.Servings"
                                     Label="Porsjoner"
                                     Variant="Variant.Outlined"
                                     Min="1" Max="20"
                                     Style="flex: 1; min-width: 100px; --mud-default-borderradius: 10px;"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Rounded.People" />
                </div>

                <div class="d-flex flex-wrap gap-3 mt-3">
                    <MudSelect T="string" @bind-Value="_newFood.Difficulty"
                               Label="Vanskelighetsgrad"
                               Variant="Variant.Outlined"
                               Style="flex: 1; min-width: 140px; --mud-default-borderradius: 10px;"
                               AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="@((string?)null)">Ikke valgt</MudSelectItem>
                        <MudSelectItem Value="@("easy")">Lett</MudSelectItem>
                        <MudSelectItem Value="@("medium")">Middels</MudSelectItem>
                        <MudSelectItem Value="@("hard")">Vanskelig</MudSelectItem>
                    </MudSelect>

                    <MudTextField @bind-Value="_newFood.Cuisine"
                                  Label="Kjøkken / Type"
                                  Variant="Variant.Outlined"
                                  Placeholder="f.eks. Italiensk, Asiatisk..."
                                  Style="flex: 1; min-width: 140px; --mud-default-borderradius: 10px;" />
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </div>

    @if (HasNutritionData)
    {
        <div class="form-section">
            <div class="d-flex justify-space-between align-center">
                <div class="section-title-row">
                    <MudIcon Icon="@Icons.Material.Rounded.LocalFireDepartment" Size="Size.Small" Color="Color.Primary" />
                    <p class="form-section-title" style="margin:0;">Næringsinformasjon</p>
                </div>
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Rounded.DeleteForever"
                           Size="Size.Small"
                           OnClick="RemoveNutrition">
                    Fjern
                </MudButton>
            </div>

            <div class="nutrition-grid mt-2">
                @foreach (var item in GetNutritionItems())
                {
                    <div class="nutrition-item">
                        <span class="nutrition-value">@item.Amount</span>
                        <span class="nutrition-label">@item.Name</span>
                    </div>
                }
            </div>
        </div>
    }
    else if (_removedNutritionData != null)
    {
        <div class="form-section">
            <div class="d-flex justify-space-between align-center">
                <div class="section-title-row">
                    <MudIcon Icon="@Icons.Material.Rounded.LocalFireDepartment" Size="Size.Small" Color="Color.Primary" />
                    <p class="form-section-title" style="margin:0;">Næringsinformasjon fjernet</p>
                </div>
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Rounded.Undo"
                           Size="Size.Small"
                           OnClick="RestoreNutrition">
                    Angre
                </MudButton>
            </div>
            <MudText Typo="Typo.caption" Color="Color.Secondary">Den importerte næringsinformasjonen blir ikke lagret. Trykk Angre for å beholde den.</MudText>
        </div>
    }

    <div class="form-section">
        <p class="form-section-title">Bilder</p>

        @if (_imagePreviewUrls.Any())
        {
            <div class="image-preview-grid">
                @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                {
                    var index = i;
                    <div class="image-preview-item">
                        <img src="@_imagePreviewUrls[index]" />
                        <button class="image-preview-remove" @onclick="@(() => RemoveImage(index))">
                            <MudIcon Icon="@Icons.Material.Rounded.Close" Size="Size.Small" />
                        </button>
                    </div>
                }
            </div>
        }

        <div class="d-flex gap-3 w-100">
            <MudFileUpload T="IReadOnlyList<IBrowserFile>" @ref="@_fileUpload" FilesChanged="OnImagesSelected" Accept="image/*" MaximumFileCount="5" Class="flex-1" @attributes="@(new Dictionary<string, object> { { "capture", "environment" } })">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Rounded.CameraAlt" Size="Size.Large" FullWidth="true" Style="border-radius: 12px; height: 56px;">Ta bilde</MudButton>
                </ActivatorContent>
            </MudFileUpload>
            <InputFile id="galleryInput" style="display: none;" multiple accept="image/*, .heic" OnChange="OnGalleryFileSelected" />
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Rounded.PhotoLibrary" Size="Size.Large" OnClick="TriggerGalleryClick" Class="flex-1" Style="border-radius: 12px; height: 56px; border-style: dashed; border-width: 2px;">Galleri</MudButton>
        </div>
    </div>

    @* --- PRIVACY & COLLECTION SELECTION --- *@
    <div class="form-section">
        <div class="d-flex justify-space-between align-center">
            <p class="form-section-title mb-0">Deling</p>
            <MudSwitch T="bool"
                       Value="@_shareWithCollection"
                       ValueChanged="OnShareCollectionToggled"
                       Color="Color.Primary"
                       Label="Legg til i samling" />
        </div>

        @if (_shareWithCollection)
        {
            <div class="mt-3 animate-in">
                @if (CollectionState.UserCollections.Any())
                {
                    <MudSelect T="Guid?"
                               Label="Velg samling"
                               Value="@_selectedCollectionId"
                               ValueChanged="OnCollectionSelectionChanged"
                               Variant="Variant.Outlined">
                        @foreach (var collection in CollectionState.UserCollections)
                        {
                            <MudSelectItem Value="@((Guid?)collection.Id)">@collection.Name</MudSelectItem>
                        }
                    </MudSelect>

                    @* Quick create new collection *@
                    <div class="mt-2">
                        @if (_showCreateCollection)
                        {
                            <div class="d-flex gap-2 align-center">
                                <MudTextField @bind-Value="_newCollectionName"
                                              Label="Navn på samling"
                                              Variant="Variant.Outlined"
                                              Size="Size.Small"
                                              Style="flex: 1; --mud-default-borderradius: 8px;" />
                                <MudIconButton Icon="@Icons.Material.Rounded.Check"
                                               Color="Color.Success"
                                               Size="Size.Small"
                                               OnClick="CreateNewCollection" />
                                <MudIconButton Icon="@Icons.Material.Rounded.Close"
                                               Color="Color.Default"
                                               Size="Size.Small"
                                               OnClick="CancelCreateCollection" />
                            </div>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                       StartIcon="@Icons.Material.Rounded.Add"
                                       OnClick="ShowCreateCollectionDialog">
                                Opprett ny samling
                            </MudButton>
                        }
                    </div>
                }
                else
                {
                    @if (_showCreateCollection)
                    {
                        <div class="d-flex gap-2 align-center mt-2">
                            <MudTextField @bind-Value="_newCollectionName"
                                          Label="Navn på samling"
                                          Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Style="flex: 1; --mud-default-borderradius: 8px;" />
                            <MudIconButton Icon="@Icons.Material.Rounded.Check"
                                           Color="Color.Success"
                                           Size="Size.Small"
                                           OnClick="CreateNewCollection" />
                            <MudIconButton Icon="@Icons.Material.Rounded.Close"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           OnClick="CancelCreateCollection" />
                        </div>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            Du har ingen samlinger enda.
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                       OnClick="ShowCreateCollectionDialog">
                                Opprett en samling
                            </MudButton>
                        </MudAlert>
                    }
                }
            </div>
        }

        <div class="mt-4 d-flex justify-space-between align-center">
            <MudText Typo="Typo.body2">Gjør offentlig (Publiser)</MudText>
            <MudSwitch @bind-Value="_isPublic" Color="Color.Tertiary" />
        </div>
        @if (_isPublic)
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary">Oppskriften blir søkbar for hele fellesskapet.</MudText>
        }
    </div>

    @* --- RATINGS SECTION --- *@
    <div class="form-section">
        <div class="d-flex justify-space-between align-center mb-4">
            <p class="form-section-title mb-0">Hvordan smakte det?</p>
            <MudSwitch T="bool" @bind-Value="_ratingEnabled" Color="Color.Primary" Label="Gi vurdering" />
        </div>

        <div class="rating-toggle-container @(_ratingEnabled ? "expanded" : "collapsed")" aria-hidden="@(!_ratingEnabled)">
            <div class="d-flex flex-column gap-3">
                @foreach (var member in _currentRatingMembers)
                {
                    bool included = IsMemberIncluded(member.UserId);
                    decimal rating = GetMemberRating(member.UserId);

                    <div class="d-flex align-center gap-2 pa-2" style="background: var(--mud-palette-background); border-radius: 12px; transition: opacity 0.2s; opacity: @(included ? 1 : 0.6);">

                        @* Avatar *@
                        <MudAvatar Size="Size.Medium" Style="@($"background: {GetMemberColor(member.DisplayName)}")">
                            @(string.IsNullOrEmpty(member.DisplayName) ? '?' : member.DisplayName[0])
                        </MudAvatar>

                        @* Name & Slider *@
                        <div class="flex-grow-1 ml-2">
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@member.DisplayName</MudText>
                                @if (included)
                                {
                                    <span style="font-size: 0.8rem; font-weight: 700; color: @GetRatingTextColor((int)rating);">@rating.ToString("0.0")/10</span>
                                }
                            </div>

                            <MudSlider T="decimal"
                                       Value="rating"
                                       ValueChanged="@((decimal v) => SetMemberRating(member.UserId, v))"
                                       Min="0" Max="10" Step="0.1M"
                                       Color="Color.Primary"
                                       Disabled="@(!included)"
                                       Class="my-0" />
                        </div>

                        @* Toggle *@
                        <MudSwitch T="bool"
                                   Value="included"
                                   ValueChanged="@((bool v) => SetMemberIncluded(member.UserId, v))"
                                   Color="Color.Success"
                                   UnCheckedColor="Color.Default"
                                   Size="Size.Medium"
                                   Class="ml-1" />
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="form-section" style="border:none; background:transparent; padding:0;">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="SubmitFood"
                   Disabled="_isSubmitting"
                   Style="border-radius: 14px; padding: 14px; height: 56px;">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
                <span>Lagrer...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Rounded.Check" Class="mr-2" />
                <span>Lagre måltid</span>
            }
        </MudButton>
    </div>
</div>

@code {
    #region State Variables
    private FoodItem _newFood = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private bool _isSubmitting = false;
    private bool _fromDraft = false;
    private string? _errorMessage;
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private List<string> _draftImageUrls = new();
    private object? _removedNutritionData;

    private bool _ratingEnabled = true;
    private Guid? _currentUserId;
    private string _currentUserName = "";

    // Collection & Privacy State
    private bool _shareWithCollection = false;
    private bool _isPublic = false;
    private Guid? _selectedCollectionId;
    private string _newCollectionName = "";
    private bool _showCreateCollection = false;

    // Member list for rating (Filtered based on selection)
    private List<CollectionMemberDto> _currentRatingMembers = new();

    // Structured ingredients
    private List<IngredientEntry> _structuredIngredients = new();
    public class IngredientEntry { public string Name { get; set; } = ""; public string Amount { get; set; } = ""; public string Unit { get; set; } = ""; }
    #endregion

    #region Ratings State
    private Dictionary<Guid, decimal> _memberRatings = new();
    private Dictionary<Guid, bool> _memberIncluded = new();
    #endregion

    protected override async Task OnInitializedAsync()
    {
        await CollectionState.InitializeAsync();
        _currentUserName = AuthService.CurrentUserName ?? "Unknown";
        _currentUserId = CollectionState.CurrentProfile?.Id;

        // Auto-select first collection if available
        if (CollectionState.UserCollections.Any())
        {
            _shareWithCollection = true;
            _selectedCollectionId = CollectionState.UserCollections.First().Id;
        }
        else
        {
            _shareWithCollection = false;
        }

        await UpdateRatingMemberListAsync();

        if (FoodService.DraftRecipe != null)
        {
            LoadDraft(FoodService.DraftRecipe);
        }
    }

    private async Task OnShareCollectionToggled(bool toggled)
    {
        _shareWithCollection = toggled;

        if (_shareWithCollection && _selectedCollectionId == null && CollectionState.UserCollections.Any())
        {
            _selectedCollectionId = CollectionState.UserCollections.First().Id;
        }

        await UpdateRatingMemberListAsync();
    }

    private async Task OnCollectionSelectionChanged(Guid? collectionId)
    {
        _selectedCollectionId = collectionId;
        await UpdateRatingMemberListAsync();
    }

    private async Task UpdateRatingMemberListAsync()
    {
        _currentUserId = CollectionState.CurrentProfile?.Id;
        if (_shareWithCollection && _selectedCollectionId.HasValue)
        {
            // Get members of the selected collection
            try
            {
                _currentRatingMembers = await CollectionState.GetCollectionMembersAsync(_selectedCollectionId.Value);
            }
            catch
            {
                _currentRatingMembers = new List<CollectionMemberDto>();
            }
        }
        else
        {
            // If private, only show current user
            _currentRatingMembers = new List<CollectionMemberDto>();

            if (_currentUserId.HasValue)
            {
                _currentRatingMembers.Add(new CollectionMemberDto { UserId = _currentUserId.Value, DisplayName = _currentUserName });
            }
        }

        var firstInitialization = !_memberIncluded.Any();

        // Initialize dictionaries for new members
        foreach (var member in _currentRatingMembers)
        {
            bool isCurrentUser = (_currentUserId.HasValue && member.UserId == _currentUserId.Value) || member.DisplayName == _currentUserName;
            if (!_memberIncluded.ContainsKey(member.UserId))
            {
                _memberIncluded[member.UserId] = isCurrentUser;
            }
            else if (firstInitialization && !isCurrentUser)
            {
                _memberIncluded[member.UserId] = false;
            }
            if (!_memberRatings.ContainsKey(member.UserId)) _memberRatings[member.UserId] = 5m;
        }
    }

    private void LoadDraft(FoodItem draft)
    {
        _removedNutritionData = null;
        _newFood.Name = draft.Name;
        _newFood.Description = draft.Description;
        _newFood.PrepTimeMinutes = draft.PrepTimeMinutes;
        _newFood.CookTimeMinutes = draft.CookTimeMinutes;
        _newFood.Servings = draft.Servings;
        _newFood.Difficulty = draft.Difficulty;
        _newFood.Cuisine = draft.Cuisine;
        _newFood.Ingredients = draft.Ingredients;
        _newFood.NutritionData = draft.NutritionData;
        _newFood.GlobalRecipeId = draft.GlobalRecipeId;
        _fromDraft = true;
        if (draft.ImageUrls != null)
        {
            _imagePreviewUrls.AddRange(draft.ImageUrls);
            _draftImageUrls.AddRange(draft.ImageUrls);
        }
        FoodService.DraftRecipe = null;
    }

    #region Dictionary Helpers
    private bool IsMemberIncluded(Guid userId) => _memberIncluded.ContainsKey(userId) && _memberIncluded[userId];
    private decimal GetMemberRating(Guid userId) => _memberRatings.ContainsKey(userId) ? _memberRatings[userId] : 5m;
    private void SetMemberIncluded(Guid userId, bool value) => _memberIncluded[userId] = value;
    private void SetMemberRating(Guid userId, decimal value) => _memberRatings[userId] = value;
    #endregion

    #region Submission Logic
    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Navn mangler.";
            return;
        }
        _isSubmitting = true;
        try
        {
            var urls = new List<string>(_draftImageUrls);
            for (int i = 0; i < _imageData.Count; i++)
                urls.Add(await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]));

            var ratingsToSend = new Dictionary<Guid, decimal>();
            if (_ratingEnabled)
            {
                foreach (var member in _currentRatingMembers)
                {
                    if (IsMemberIncluded(member.UserId))
                    {
                        ratingsToSend[member.UserId] = GetMemberRating(member.UserId);
                    }
                }
            }

            // Determine Visibility - only "private" or "public" now (no more "household")
            string finalVisibility = _isPublic ? "public" : "private";

            // Use structured ingredients if any are filled in, otherwise use existing (from draft)
            var finalIngredients = BuildIngredientsJson() ?? _newFood.Ingredients;

            var createDto = new CreateUserRecipeDto
            {
                Name = _newFood.Name,
                Description = _newFood.Description,
                ImageUrls = urls,
                PersonalNotes = _newFood.PersonalNotes,
                GlobalRecipeId = _newFood.GlobalRecipeId,
                Visibility = finalVisibility,
                MemberRatings = ratingsToSend,
                CollectionIds = _shareWithCollection && _selectedCollectionId.HasValue
                    ? new List<Guid> { _selectedCollectionId.Value }
                    : new List<Guid>(),
                // Metadata fields
                PrepTimeMinutes = _newFood.PrepTimeMinutes,
                Servings = _newFood.Servings,
                Difficulty = _newFood.Difficulty,
                Cuisine = _newFood.Cuisine,
                Ingredients = finalIngredients,
                NutritionData = _newFood.NutritionData
            };

            var createdRecipe = await RecipeService.CreateRecipeAsync(createDto);

            // If sharing with a collection, add the recipe to that collection
            if (_shareWithCollection && _selectedCollectionId.HasValue && createdRecipe != null)
            {
                await CollectionState.AddRecipeToCollectionAsync(_selectedCollectionId.Value, createdRecipe.Id);
            }

            RecipeService.InvalidateCache();
            Navigation.NavigateTo("cookbook");
        }
        catch (Exception ex) { _errorMessage = ex.Message; }
        finally { _isSubmitting = false; }
    }
    #endregion

    #region Image Upload
    private async Task TriggerGalleryClick() => await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('galleryInput').click()");

    private async Task OnGalleryFileSelected(InputFileChangeEventArgs args)
    {
        try
        {
            var remainingSlots = Math.Max(0, 5 - _imageData.Count);
            var files = args.GetMultipleFiles(remainingSlots);
            if (files.Count == 0) return;
            await OnImagesSelected(files);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Feil i galleri-opplasting: {ex.Message}");
            Snackbar.Add("Noe gikk galt med bildeopplastingen.", Severity.Error);
        }
    }

    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (_imageData.Count >= 5) break;
            var fileToRead = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);
            using var stream = fileToRead.OpenReadStream(30 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            _imagePreviewUrls.Add($"data:image/jpeg;base64,{Convert.ToBase64String(buffer)}");
            _imageData.Add(buffer);
            _imageNames.Add(file.Name);
        }
    }
    private void RemoveImage(int index)
    {
        if (index < _draftImageUrls.Count) { _draftImageUrls.RemoveAt(index); _imagePreviewUrls.RemoveAt(index); }
        else
        {
            var newIdx = index - _draftImageUrls.Count;
            if (newIdx >= 0 && newIdx < _imageData.Count) { _imageData.RemoveAt(newIdx); _imageNames.RemoveAt(newIdx); _imagePreviewUrls.RemoveAt(index); }
        }
    }
    #endregion

    #region Collection Methods
    private void ShowCreateCollectionDialog()
    {
        _showCreateCollection = true;
        _newCollectionName = "";
    }

    private async Task CreateNewCollection()
    {
        if (string.IsNullOrWhiteSpace(_newCollectionName))
        {
            Snackbar.Add("Samlingsnavn kan ikke være tomt.", Severity.Warning);
            return;
        }

        try
        {
            var newCollection = await CollectionState.CreateCollectionAsync(_newCollectionName);
            _selectedCollectionId = newCollection.Id;
            _shareWithCollection = true;
            _showCreateCollection = false;
            _newCollectionName = "";
            await UpdateRatingMemberListAsync();
            Snackbar.Add($"Samlingen '{newCollection.Name}' ble opprettet!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke opprette samling: {ex.Message}", Severity.Error);
        }
    }

    private void CancelCreateCollection()
    {
        _showCreateCollection = false;
        _newCollectionName = "";
    }
    #endregion

    #region Helpers
    private string GetMemberColor(string? n) => string.IsNullOrEmpty(n) ? "grey" : $"hsl({Math.Abs(n.GetHashCode() % 360)}, 45%, 45%)";
    private string GetRatingTextColor(int r) => r >= 8 ? "#2D5A45" : r >= 5 ? "#A17D00" : "#C44536";
    #endregion

    #region Nutrition Helpers
    private record NutritionInfo(string Name, string Amount);
    private bool HasNutritionData => _newFood.NutritionData != null && GetNutritionItems().Count > 0;

    private List<NutritionInfo> GetNutritionItems() => ParseNutrition(_newFood.NutritionData);

    private List<NutritionInfo> ParseNutrition(object? data)
    {
        var items = new List<NutritionInfo>();
        if (data == null) return items;

        try
        {
            if (data is JsonElement jsonElement && jsonElement.ValueKind == JsonValueKind.Object)
            {
                foreach (var prop in jsonElement.EnumerateObject())
                {
                    var amount = prop.Value.ToString();
                    if (!string.IsNullOrWhiteSpace(amount))
                    {
                        items.Add(new NutritionInfo(GetNutritionDisplayName(prop.Name), amount));
                    }
                }
            }
            else if (data is IDictionary<string, object?> dict)
            {
                foreach (var kvp in dict)
                {
                    var amount = kvp.Value?.ToString();
                    if (!string.IsNullOrWhiteSpace(amount))
                    {
                        items.Add(new NutritionInfo(GetNutritionDisplayName(kvp.Key), amount));
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing nutrition data: {ex.Message}");
        }

        return items;
    }

    private string GetNutritionDisplayName(string key)
    {
        return key.ToLower() switch
        {
            "kalorier" => "kcal",
            "energi (kj)" => "kJ",
            "fett" => "Fett",
            "mettet fett" => "M. fett",
            "karbohydrater" => "Karb.",
            "sukker" => "Sukker",
            "protein" => "Protein",
            "natrium" => "Natrium",
            _ => key.Length > 8 ? key.Substring(0, 6) + ".." : key
        };
    }

    private void RemoveNutrition()
    {
        if (_newFood.NutritionData != null)
        {
            _removedNutritionData = _newFood.NutritionData;
            _newFood.NutritionData = null;
        }
    }

    private void RestoreNutrition()
    {
        if (_removedNutritionData != null)
        {
            _newFood.NutritionData = _removedNutritionData;
            _removedNutritionData = null;
        }
    }
    #endregion

    #region Ingredients Helpers
    private void AddIngredient() => _structuredIngredients.Add(new IngredientEntry());
    private void RemoveIngredient(int index)
    {
        if (index >= 0 && index < _structuredIngredients.Count)
            _structuredIngredients.RemoveAt(index);
    }
    private string GetIngredientsTitle() => _structuredIngredients.Count > 0
        ? $"Ingredienser ({_structuredIngredients.Count})"
        : "Ingredienser (valgfritt)";

    private object? BuildIngredientsJson()
    {
        var validIngredients = _structuredIngredients
            .Where(i => !string.IsNullOrWhiteSpace(i.Name))
            .Select(i => new { name = i.Name, amount = i.Amount, unit = i.Unit })
            .ToList();
        return validIngredients.Any() ? validIngredients : null;
    }
    #endregion

}
