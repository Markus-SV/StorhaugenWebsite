@page "/add"
@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IOcrService OcrService


    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <h1 class="page-title" style="margin-bottom: 4px;">Add Meal</h1>
            <p class="page-subtitle">Rate tonight's dinner with the family</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)"
                  Style="border-radius: 12px;">
            @_errorMessage
        </MudAlert>
    }

    <div class="form-section">
        <p class="form-section-title">Meal Details</p>

        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudTextField @bind-Value="_newFood.Name"
                          Label="What did we eat?"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Taco Tuesday, Grandma's Lasagna"
                          Required="true"
                          Disabled="_isReadingText"
                          Style="--mud-default-borderradius: 12px; flex-grow: 1;" />

            @if (_isReadingText)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" Class="ml-2" />
                <MudText Typo="Typo.caption" Class="ml-1" Color="Color.Secondary">Reading...</MudText>
            }
        </MudStack>

        <MudTextField @bind-Value="_newFood.Description"
                      Label="Notes (optional)"
                      Variant="Variant.Outlined"
                      Placeholder="Recipe link, ingredients, or notes..."
                      Lines="2"
                      Style="--mud-default-borderradius: 12px;" />
    </div>

    <div class="form-section">
        <p class="form-section-title">Photos</p>

        @if (_imagePreviewUrls.Any())
        {
            <div class="image-preview-grid">
                @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                {
                    var index = i;
                    <div class="image-preview-item">
                        <img src="@_imagePreviewUrls[index]" alt="Preview" />
                        <button class="image-preview-remove" @onclick="@(() => RemoveImage(index))">
                            <MudIcon Icon="@Icons.Material.Rounded.Close" Size="Size.Small" />
                        </button>
                    </div>
                }
            </div>
        }

        <MudStack Row="true" Spacing="2" Class="w-100">
            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           @ref="@_fileUpload"
                           FilesChanged="OnImagesSelected"
                           Accept="image/*"
                           MaximumFileCount="5"
                           Class="flex-1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Rounded.CameraAlt"
                               Size="Size.Large"
                               FullWidth="true"
                               OnClick="@(() => _fileUpload?.OpenFilePickerAsync())"
                               Style="border-radius: 12px; height: 56px;">
                        Take Photo
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           @ref="@_galleryUpload"
                           FilesChanged="OnImagesSelected"
                           Accept=".png,.jpg,.jpeg,.webp"
                           MaximumFileCount="5"
                           Class="flex-1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Rounded.PhotoLibrary"
                               FullWidth="true"
                               OnClick="@(() => _galleryUpload?.OpenFilePickerAsync())"
                               Style="border-radius: 12px; height: 56px; border-style: dashed; border-width: 2px;">
                        Gallery
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        </MudStack>

        <p style="margin: 8px 0 0; font-size: 0.8rem; color: var(--mud-palette-text-secondary); text-align: center;">
            Up to 5 images
        </p>
    </div>

    <div class="form-section">
        <p class="form-section-title">Ratings</p>

        @foreach (var member in AppConfig.FamilyNames)
        {
            var currentMember = member;
            var isEnabled = _ratingsEnabled[currentMember];
            var ratingValue = GetRatingValue(currentMember);

            <div class="rating-member-card">
                <div class="rating-member-header">
                    <div class="rating-member-info">
                        <div class="rating-member-avatar" style="@($"background: {GetMemberColor(currentMember)}")">
                            @currentMember[0]
                        </div>
                        <div>
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@currentMember</MudText>
                            @if (AuthService.CurrentUser?.Name == currentMember)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Primary">(You)</MudText>
                            }
                        </div>
                    </div>
                    <MudSwitch T="bool"
                               Value="@isEnabled"
                               ValueChanged="@((bool v) => ToggleRating(currentMember, v))"
                               Color="Color.Primary" />
                </div>

                @if (isEnabled)
                {
                    <div class="rating-slider-container">
                        <MudSlider T="int"
                                   Value="@ratingValue"
                                   ValueChanged="@((int v) => SetRating(currentMember, v))"
                                   Min="0" Max="10" Step="1"
                                   Color="Color.Primary"
                                   Style="flex: 1;" />
                        <div class="rating-value-display" style="@($"background: {GetRatingBackground(ratingValue)}; color: {GetRatingTextColor(ratingValue)}")">
                            @ratingValue
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               Size="Size.Large"
               FullWidth="true"
               OnClick="SubmitFood"
               Disabled="_isSubmitting"
               Style="border-radius: 14px; padding: 14px; margin-top: 8px;">
        @if (_isSubmitting)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
            <span>Saving...</span>
        }
        else
        {
            <MudIcon Icon="@Icons.Material.Rounded.Check" Class="mr-2" />
            <span>Save Meal</span>
        }
    </MudButton>


@code {
    private FoodItem _newFood = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _galleryUpload;
    private bool _isSubmitting = false;
    private bool _isReadingText = false; // New loading state for OCR
    private string? _errorMessage;
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private Dictionary<string, bool> _ratingsEnabled = new()
    {
        { "Markus", false },
        { "Siv", false },
        { "Elias", false }
    };

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("login");
                return;
            }
        }

        if (AuthService.CurrentUser != null)
        {
            _ratingsEnabled[AuthService.CurrentUser.Name] = true;
            _newFood.Ratings[AuthService.CurrentUser.Name] = 5;
        }
    }

    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        bool isFirstImage = _imageData.Count == 0;

        foreach (var file in files)
        {
            if (_imageData.Count >= 5) break;

            try
            {
                // MOBIL-FIX: Vi går ned til 800x800.
                // Dette er fortsatt mer enn nok for å lese tekst, men sparer mye minne på iPhone/Android.
                var resizedFile = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);

                var smallBuffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).ReadAsync(smallBuffer);

                var smallBase64 = Convert.ToBase64String(smallBuffer);
                var previewUrl = $"data:image/jpeg;base64,{smallBase64}";

                // Legg til i listen for visning
                _imagePreviewUrls.Add(previewUrl);
                _imageNames.Add(file.Name);

                // --- ORIGINALFIL ---
                // Vi laster opp originalen til serveren (høy kvalitet)
                // OBS: Vi setter en try/catch her også, i tilfelle originalen er gigantisk (50MB+)
                try
                {
                    var originalBuffer = new byte[file.Size];
                    // Økt grense til 30MB for tunge mobilbilder
                    await file.OpenReadStream(maxAllowedSize: 30 * 1024 * 1024).ReadAsync(originalBuffer);
                    _imageData.Add(originalBuffer);
                }
                catch
                {
                    // Hvis originalen feiler, bruk den lille versjonen som backup så vi i alle fall får lagret
                    _imageData.Add(smallBuffer);
                    Snackbar.Add("Originalbildet var for stort, bruker komprimert versjon.", Severity.Info);
                }

                StateHasChanged();
                await Task.Delay(100); // Økt pause litt for å la mobilen puste

                // --- OCR ---
                if (isFirstImage && string.IsNullOrWhiteSpace(_newFood.Name))
                {
                    _ = TryAutoFillTitle(previewUrl);
                    isFirstImage = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Critical error: {ex}");
            }
        }
    }

    private async Task TryAutoFillTitle(string dataUrl)
    {
        if (dataUrl.Length > 10 * 1024 * 1024) 
    {
        Console.WriteLine("Image too large for OCR, skipping.");
        return;
    }
        
        _isReadingText = true;
        StateHasChanged();

        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);

            if (!string.IsNullOrWhiteSpace(rawText))
            {
                // Split by lines and find the first non-empty one with significant length
                var lines = rawText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                var firstSignificantLine = lines.FirstOrDefault(l => l.Trim().Length > 3);

                if (!string.IsNullOrWhiteSpace(firstSignificantLine))
                {
                    // Clean extra spaces
                    _newFood.Name = System.Text.RegularExpressions.Regex.Replace(firstSignificantLine, @"\s+", " ").Trim();
                    Snackbar.Add("Auto-filled title from photo", Severity.Success);
                }
            }
        }
        catch (Exception)
        {
            // Silently fail or simple warning. It's an optional feature.
            // Snackbar.Add("Could not read text from image", Severity.Warning);
        }
        finally
        {
            _isReadingText = false;
            StateHasChanged();
        }
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < _imageData.Count)
        {
            _imageData.RemoveAt(index);
            _imageNames.RemoveAt(index);
            _imagePreviewUrls.RemoveAt(index);
        }
    }

    private void ToggleRating(string member, bool enabled)
    {
        _ratingsEnabled[member] = enabled;
        if (!enabled)
        {
            _newFood.Ratings[member] = null;
        }
        else
        {
            _newFood.Ratings[member] = 5;
        }
    }

    private int GetRatingValue(string member)
    {
        return _newFood.Ratings.TryGetValue(member, out var rating) && rating.HasValue ? rating.Value : 5;
    }

    private void SetRating(string member, int value)
    {
        _newFood.Ratings[member] = value;
    }

    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Please enter a name for the meal.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var uploadedUrls = new List<string>();
            for (int i = 0; i < _imageData.Count; i++)
            {
                var url = await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]);
                uploadedUrls.Add(url);
            }

            _newFood.ImageUrls = uploadedUrls;
            _newFood.DateAdded = DateTime.UtcNow;
            _newFood.AddedBy = AuthService.CurrentUser?.Name ?? "Unknown";

            foreach (var member in AppConfig.FamilyNames)
            {
                if (!_ratingsEnabled[member])
                {
                    _newFood.Ratings[member] = null;
                }
            }

            await FoodService.AddFoodAsync(_newFood);

            Snackbar.Add("Meal saved successfully!", Severity.Success);
            Navigation.NavigateTo("");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving meal: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string GetMemberColor(string name)
    {
        return name switch
        {
            "Markus" => "#E07A2E",
            "Siv" => "#2D5A45",
            "Elias" => "#4A7C9B",
            _ => "#6B5D4D"
        };
    }

    private string GetRatingBackground(int rating)
    {
        return rating switch
        {
            >= 8 => "rgba(45, 90, 69, 0.15)",
            >= 5 => "rgba(212, 160, 23, 0.15)",
            _ => "rgba(196, 69, 54, 0.15)"
        };
    }

    private string GetRatingTextColor(int rating)
    {
        return rating switch
        {
            >= 8 => "#2D5A45",
            >= 5 => "#A17D00",
            _ => "#C44536"
        };
    }
}