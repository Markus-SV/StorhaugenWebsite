@page "/add"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IHouseholdStateService HouseholdState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IOcrService OcrService
@attribute [Authorize]
@inject IJSRuntime JSRuntime

<style>
    /* ... existing styles ... */
    .camera-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        z-index: 9999;
        display: flex;
        flex-direction: column;
    }

    .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }

    .camera-guide-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        pointer-events: none;
        transition: all 0.5s ease;
    }

    .camera-guide-box {
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        position: relative;
        overflow: hidden;
        background: transparent;
        transition: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .camera-guide-container.step-landscape .camera-guide-box {
        width: 80vw;
        aspect-ratio: 297/210;
        max-height: 85vh;
    }

    .camera-guide-container.step-portrait-tall .camera-guide-box {
        width: 60vw;
        aspect-ratio: 1/2.5;
        max-height: 70vh;
    }

    .camera-guide-container.step-portrait-normal .camera-guide-box {
        width: 85vw;
        aspect-ratio: 210/297;
        max-width: 450px;
    }

    .step-landscape .text-hint-zone {
        position: absolute;
        top: 15%;
        left: 5%;
        width: 60%;
        height: 15%;
        border: 1px dashed rgba(255,255,255,0.5);
        display: flex;
        align-items: center;
        padding-left: 10px;
    }

    .step-landscape .text-label {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        font-weight: bold;
    }

    .step-landscape .logo-hint-zone {
        position: absolute;
        top: 10%;
        right: 5%;
        width: 12%;
        aspect-ratio: 1/1;
        border: 2px dashed #9ACD32;
        border-radius: 50%;
        opacity: 0.6;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .step-landscape .logo-label {
        color: #9ACD32;
        font-size: 10px;
        font-weight: bold;
    }

    .scan-line {
        width: 100%;
        height: 2px;
        background: #00E676;
        position: absolute;
        top: 0;
        box-shadow: 0 0 10px #00E676;
        animation: scanAnim 2.5s ease-in-out infinite;
    }

    @@keyframes scanAnim {
        0% {
            top: 5%;
            opacity: 0;
        }

        20% {
            opacity: 1;
        }

        80% {
            opacity: 1;
        }

        100% {
            top: 95%;
            opacity: 0;
        }
    }

    .camera-instruction-pill {
        margin-bottom: 24px;
        background: rgba(0,0,0,0.6);
        padding: 8px 16px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
    }

    .step-text {
        color: #00E676;
        font-weight: bold;
        font-size: 12px;
        letter-spacing: 1px;
    }

    .camera-guide-text {
        margin-top: 24px;
        color: white;
        text-align: center;
        font-size: 16px;
        font-weight: 500;
        white-space: pre-wrap;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        max-width: 80%;
    }

    .camera-controls {
        position: absolute;
        bottom: 30px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 32px;
        z-index: 10000;
        pointer-events: auto;
    }

    @@media (orientation: landscape) and (max-height: 500px) {
        .camera-controls {
            bottom: 10px;
            padding: 0 60px;
        }

        .camera-guide-text {
            display: none;
        }

        .camera-instruction-pill {
            margin-bottom: 10px;
        }
    }

    .step-counter {
        color: white;
        font-weight: bold;
        font-size: 14px;
        width: 48px;
        text-align: center;
        background: rgba(255,255,255,0.1);
        padding: 4px 8px;
        border-radius: 8px;
    }

    .camera-shutter {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 4px solid white;
        position: relative;
        transition: all 0.2s;
        cursor: pointer;
    }

        .camera-shutter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            transition: all 0.2s;
        }

        .camera-shutter:active {
            transform: scale(0.95);
        }

        .camera-shutter.processing {
            border-color: #999;
            pointer-events: none;
        }

            .camera-shutter.processing::after {
                width: 20px;
                height: 20px;
                background: #999;
                border-radius: 2px;
                animation: spin 1s infinite linear;
            }

    @@keyframes spin {
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    .image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
        margin-bottom: 16px;
    }

    .image-preview-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
    }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .image-preview-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.5);
        border: none;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .form-section {
        background: var(--mud-palette-surface);
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .form-section-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 12px;
    }
</style>

@* --- 1. CAMERA OVERLAY UI (Keep existing) --- *@
@if (_showCameraOverlay)
{
    <div class="camera-overlay">
        <video @ref="_videoElement" autoplay playsinline muted class="camera-video"></video>
        <div class="camera-guide-container @GetOverlayClass()">
            <div class="camera-guide-box">
                @if (_currentStep == ScanStep.Front)
                {
                    <div class="logo-hint-zone"><span class="logo-label">HELLO<br />FRESH</span></div>
                    <div class="text-hint-zone"><span class="text-label">TITTEL HER</span></div>
                }
                <div class="scan-line"></div>
            </div>
            <div class="camera-instruction-pill">
                <MudIcon Icon="@GetStepIcon()" Size="Size.Small" Class="mr-2" Style="color: #00E676;" />
                <span class="step-text">@GetStepTitle()</span>
            </div>
            <p class="camera-guide-text">@GetInstructionText()</p>
        </div>
        <div class="camera-controls">
            <MudIconButton Icon="@Icons.Material.Rounded.Close" Color="Color.Surface" Size="Size.Large" OnClick="StopCamera" />
            <button class="camera-shutter @(_isProcessingOcr ? "processing" : "")" disabled="@_isProcessingOcr" @onclick="CaptureCameraImage"></button>
            <div class="step-counter">@((int)_currentStep + 1) / 3</div>
        </div>
    </div>
}

@if (!HouseholdState.HasHousehold)
{
    <div class="empty-state pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Rounded.Home" Size="Size.Large" Class="mb-4" />
        <h2>Ingen husstand valgt</h2>
        <p class="mb-4">Du må opprette eller bli med i en husstand.</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="settings">Gå til innstillinger</MudButton>
    </div>
}
else
{
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <h1 class="page-title" style="margin-bottom: 4px; font-size: 24px; font-weight: 700;">Legg til måltid</h1>
            <p class="page-subtitle" style="color: var(--mud-palette-text-secondary);">
                @(_fromDraft ? "Tilpass kopiert oppskrift" : "Gi kveldens middag en vurdering")
            </p>
        </div>
    </div>

    @* --- TYPE SELECTOR --- *@
    <MudPaper Class="pa-2 mb-6 d-flex justify-center gap-2" Elevation="0" Style="background: var(--mud-palette-background-grey); border-radius: 12px;">
        <MudButton Variant="@(_isHelloFresh? Variant.Filled: Variant.Text)"
                   Color="Color.Success"
                   OnClick="@(() => SetFoodType(true))"
                   Class="flex-1"
                   Style="border-radius: 10px;"
                   StartIcon="@Icons.Custom.Brands.MudBlazor">
            HelloFresh
        </MudButton>
        <MudButton Variant="@(!_isHelloFresh ? Variant.Filled : Variant.Text)"
                   Color="Color.Primary"
                   OnClick="@(() => SetFoodType(false))"
                   Class="flex-1"
                   Style="border-radius: 10px;"
                   StartIcon="@Icons.Material.Rounded.Restaurant">
            Annet
        </MudButton>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)">
            @_errorMessage
        </MudAlert>
    }

    @* --- DETAILS FORM --- *@
    <div class="form-section">
        <div class="d-flex justify-space-between align-center">
            <p class="form-section-title">Måltidsdetaljer</p>
            @if (_isHelloFresh && _isProcessingOcr)
            {
                <MudChip Size="Size.Small" Color="Color.Success" T="string" Variant="Variant.Text" Icon="@Icons.Material.Rounded.AutoAwesome">
                    Analyserer...
                </MudChip>
            }
        </div>

        <MudTextField @bind-Value="_newFood.Name"
                      Label="@(_isHelloFresh ? "Navn på rett" : "Hva spiste vi?")"
                      Variant="Variant.Outlined"
                      Placeholder="@(_isHelloFresh ? "Skann forside for å fylle ut..." : "f.eks. Bestemors lasagne")"
                      Required="true"
                      Class="mb-4"
                      Style="--mud-default-borderradius: 12px;" />

        <MudTextField @bind-Value="_newFood.Description"
                      Label="Beskrivelse / Ingredienser"
                      Variant="Variant.Outlined"
                      Lines="5"
                      Placeholder="Ingredienser blir lagt til her automatisk etter skanning av bilde 2..."
                      Style="--mud-default-borderradius: 12px;" />
    </div>

    @* --- IMAGES SECTION --- *@
    <div class="form-section">
        <p class="form-section-title">Bilder</p>

        @if (_imagePreviewUrls.Any())
        {
            <div class="image-preview-grid">
                @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                {
                    var index = i;
                    <div class="image-preview-item">
                        <img src="@_imagePreviewUrls[index]" />
                        <button class="image-preview-remove" @onclick="@(() => RemoveImage(index))">
                            <MudIcon Icon="@Icons.Material.Rounded.Close" Size="Size.Small" />
                        </button>
                    </div>
                }
            </div>
        }

        <MudStack Row="true" Spacing="2" Class="w-100">
            @if (_isHelloFresh)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Rounded.DocumentScanner" Size="Size.Large" OnClick="StartCamera" Class="flex-1" Style="border-radius: 12px; height: 56px;">
                    Start Skanning
                </MudButton>
            }
            else
            {
                <MudFileUpload T="IReadOnlyList<IBrowserFile>" @ref="@_fileUpload" FilesChanged="OnImagesSelected" Accept="image/*" MaximumFileCount="5" Class="flex-1" @attributes="@(new Dictionary<string, object> { { "capture", "environment" } })">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Rounded.CameraAlt" Size="Size.Large" FullWidth="true" Style="border-radius: 12px; height: 56px;">
                            Ta bilde
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
            }

            <MudFileUpload T="IReadOnlyList<IBrowserFile>" @ref="@_galleryUpload" FilesChanged="OnImagesSelected" Accept="image/*" MaximumFileCount="5" Class="flex-1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Rounded.PhotoLibrary" FullWidth="true" OnClick="@(() => _galleryUpload?.OpenFilePickerAsync())" Style="border-radius: 12px; height: 56px; border-style: dashed; border-width: 2px;">
                        Galleri
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        </MudStack>
    </div>

    @* --- RATING SECTION --- *@
    <div class="form-section">
        <p class="form-section-title">Din vurdering</p>
        <div class="d-flex align-center justify-space-between mb-2">
            <div class="d-flex align-center gap-2">
                <MudAvatar Size="Size.Small" Style="@($"background: {GetMemberColor(_currentUserName)}")">
                    @(string.IsNullOrEmpty(_currentUserName) ? '?' : _currentUserName[0])
                </MudAvatar>
                <MudText Typo="Typo.subtitle1"><b>Deg</b></MudText>
            </div>
            <MudSwitch T="bool" Value="@_ratingEnabled" ValueChanged="@ToggleRating" Color="Color.Primary" />
        </div>

        @if (_ratingEnabled)
        {
            <div class="d-flex align-center gap-4">
                <MudSlider T="int" Value="@_ratingValue" ValueChanged="@((int v) => _ratingValue = v)" Min="0" Max="10" Step="1" Color="Color.Primary" Class="flex-1" />
                <div style="background: @GetRatingBackground(_ratingValue); color: @GetRatingTextColor(_ratingValue); padding: 4px 12px; border-radius: 8px; font-weight: bold; min-width: 40px; text-align: center;">
                    @_ratingValue
                </div>
            </div>
        }
    </div>

    @* --- VISIBILITY & SUBMIT --- *@
    <div class="form-section">
        <p class="form-section-title">Synlighet</p>
        <div class="d-flex align-center gap-3 mb-4">
            <MudIcon Icon="@(_newFood.IsPublic? Icons.Material.Rounded.Public : Icons.Material.Rounded.Lock)" Color="@(_newFood.IsPublic? Color.Primary: Color.Default)" />
            <div style="flex: 1;">
                <MudText Typo="Typo.subtitle1"><b>@(_newFood.IsPublic ? "Offentlig" : "Privat")</b></MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @(_newFood.IsPublic ? "Synlig for alle i Utforsk" : "Kun synlig for din husstand")
                </MudText>
            </div>
            <MudSwitch T="bool" @bind-Value="_newFood.IsPublic" Color="Color.Primary" />
        </div>

        <MudButton Variant="Variant.Filled"
                   Color="@(_isHelloFresh ? Color.Success : Color.Primary)"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="SubmitFood"
                   Disabled="_isSubmitting"
                   Style="border-radius: 14px; padding: 14px;">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
                <span>Lagrer...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Rounded.Check" Class="mr-2" />
                <span>Lagre måltid</span>
            }
        </MudButton>
    </div>
}

@code {
    // --- STATE VARIABLES ---
    private FoodItem _newFood = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _galleryUpload;

    private bool _isSubmitting = false;
    private bool _fromDraft = false;
    private string? _errorMessage;

    // Images
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private List<string> _draftImageUrls = new();

    // Rating
    private bool _ratingEnabled = true;
    private int _ratingValue = 5;
    private string _currentUserName = "";
    private bool _isHelloFresh = true;

    // --- CAMERA STATE MACHINE ---
    private ElementReference _videoElement;
    private bool _showCameraOverlay = false;
    private bool _isProcessingOcr = false;

    private enum ScanStep { Front, Ingredients, Back, Finished }
    private ScanStep _currentStep = ScanStep.Front;

    // --- INITIALIZATION ---
    protected override async Task OnInitializedAsync()
    {
        await HouseholdState.InitializeAsync();
        if (HouseholdState.HasHousehold)
        {
            _currentUserName = AuthService.CurrentUserName ?? "Unknown";
        }

        if (FoodService.DraftRecipe != null)
        {
            var draft = FoodService.DraftRecipe;
            _newFood.Name = draft.Name;
            _newFood.Description = draft.Description;
            _fromDraft = true;

            // FIX: Handle image transfer
            if (draft.ImageUrls != null && draft.ImageUrls.Any())
            {
                // Add them to the preview list so the user sees them
                _imagePreviewUrls.AddRange(draft.ImageUrls);

                // Add them to our tracking list so we know these are valid URLs, not base64 blobs
                _draftImageUrls.AddRange(draft.ImageUrls);
            }

            FoodService.DraftRecipe = null;
        }
    }

    private void SetFoodType(bool isHelloFresh) => _isHelloFresh = isHelloFresh;

    // --- CAMERA LOGIC ---
    private async Task StartCamera()
    {
        _currentStep = ScanStep.Front;
        _showCameraOverlay = true;
        await Task.Delay(100);
        try { await JSRuntime.InvokeVoidAsync("cameraInterop.start", _videoElement); }
        catch (Exception) { Snackbar.Add("Kunne ikke starte kamera. Sjekk tillatelser.", Severity.Error); _showCameraOverlay = false; }
    }

    private async Task StopCamera()
    {
        await JSRuntime.InvokeVoidAsync("cameraInterop.stop", _videoElement);
        _showCameraOverlay = false;
    }

    private async Task CaptureCameraImage()
    {
        if (_isProcessingOcr) return;
        _isProcessingOcr = true;
        StateHasChanged();

        try
        {
            var base64Data = await JSRuntime.InvokeAsync<string>("cameraInterop.capture", _videoElement);
            var base64Signature = ";base64,";
            var index = base64Data.IndexOf(base64Signature);
            var cleanBase64 = index >= 0 ? base64Data.Substring(index + base64Signature.Length) : base64Data;
            var bytes = Convert.FromBase64String(cleanBase64);

            _imagePreviewUrls.Add(base64Data);
            _imageData.Add(bytes);

            switch (_currentStep)
            {
                case ScanStep.Front:
                    _imageNames.Add("hellofresh_front.jpg");
                    Snackbar.Add("Forside fanget! Analyserer tittel...", Severity.Info);
                    await TryAutoFillTitle(base64Data);
                    _currentStep = ScanStep.Ingredients;
                    break;
                case ScanStep.Ingredients:
                    _imageNames.Add("hellofresh_ingredients.jpg");
                    Snackbar.Add("Ingredienser fanget! Leser liste...", Severity.Info);
                    await TryExtractIngredients(base64Data);
                    _currentStep = ScanStep.Back;
                    break;
                case ScanStep.Back:
                    _imageNames.Add("hellofresh_back.jpg");
                    Snackbar.Add("Skanning fullført!", Severity.Success);
                    await StopCamera();
                    _currentStep = ScanStep.Finished;
                    break;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Capture error: {ex.Message}");
            Snackbar.Add("Feil ved bildeopptak.", Severity.Error);
        }
        finally
        {
            _isProcessingOcr = false;
            StateHasChanged();
        }
    }

    // --- UI HELPERS FOR OVERLAY ---
    private string GetOverlayClass() => _currentStep switch { ScanStep.Front => "step-landscape", ScanStep.Ingredients => "step-portrait-tall", _ => "step-portrait-normal" };
    private string GetStepTitle() => _currentStep switch { ScanStep.Front => "STEG 1: FORSIDE (SNU TELEFONEN)", ScanStep.Ingredients => "STEG 2: INGREDIENSER (RETT OPP)", ScanStep.Back => "STEG 3: FREMGANGSMÅTE", _ => "" };
    private string GetInstructionText() => _currentStep switch { ScanStep.Front => "Hold telefonen vannrett (liggende) for å ta bilde av hele forsiden.", ScanStep.Ingredients => "Hold telefonen loddrett (stående) for å ta bilde av ingredienslisten.", ScanStep.Back => "Hold telefonen loddrett (stående). Ta bilde av hele baksiden.", _ => "" };
    private string GetStepIcon() => _currentStep switch { ScanStep.Front => Icons.Material.Rounded.ScreenRotation, _ => Icons.Material.Rounded.CropPortrait };

    // --- OCR LOGIC ---
    private async Task TryAutoFillTitle(string dataUrl)
    {
        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);
            if (!string.IsNullOrWhiteSpace(rawText))
            {
                var lines = rawText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                foreach (var line in lines)
                {
                    var cleanLine = line.Trim();
                    if (cleanLine.Length < 3) continue;
                    // Basic cleanup regex
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\b(HELLO|FRESH)\b", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    if (cleanLine.Length > 3 && cleanLine.Length < 60 && !cleanLine.Any(char.IsDigit))
                    {
                        _newFood.Name = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\s+", " ").Trim();
                        Snackbar.Add($"Tittel funnet: {_newFood.Name}", Severity.Success);
                        await InvokeAsync(StateHasChanged);
                        break;
                    }
                }
            }
        }
        catch (Exception ex) { Console.WriteLine($"Title OCR Error: {ex}"); }
    }

    private async Task TryExtractIngredients(string dataUrl)
    {
        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);
            if (!string.IsNullOrWhiteSpace(rawText))
            {
                var cleanText = rawText.Replace("\n", ", ").Trim();
                if (string.IsNullOrWhiteSpace(_newFood.Description))
                    _newFood.Description = "Ingredienser: " + cleanText;
                else
                    _newFood.Description += "\n\nIngredienser: " + cleanText;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex) { Console.WriteLine("Ingredient OCR Error: " + ex.Message); }
    }

    // --- FORM HANDLING ---
    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (_imageData.Count >= 5) break;
            try
            {
                var fileToRead = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);
                using var stream = fileToRead.OpenReadStream(maxAllowedSize: 1024 * 1024 * 30);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var buffer = ms.ToArray();
                var base64 = Convert.ToBase64String(buffer);
                _imagePreviewUrls.Add($"data:image/jpeg;base64,{base64}");
                _imageData.Add(buffer);
                _imageNames.Add(file.Name);
            }
            catch { }
        }
    }

    private void RemoveImage(int index)
    {
        // Check if the index corresponds to a draft image (they are added first)
        if (index < _draftImageUrls.Count)
        {
            _draftImageUrls.RemoveAt(index);
            _imagePreviewUrls.RemoveAt(index);
        }
        else
        {
            // It's a newly added image. Adjust index relative to _imageData
            var newImageIndex = index - _draftImageUrls.Count;
            if (newImageIndex >= 0 && newImageIndex < _imageData.Count)
            {
                _imageData.RemoveAt(newImageIndex);
                _imageNames.RemoveAt(newImageIndex);
                _imagePreviewUrls.RemoveAt(index);
            }
        }
    }

    private void ToggleRating(bool enabled) => _ratingEnabled = enabled;

    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Du må gi måltidet et navn.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var finalImageUrls = new List<string>();

            // 1. Add the draft URLs that were preserved
            finalImageUrls.AddRange(_draftImageUrls);

            // 2. Upload the NEW images
            for (int i = 0; i < _imageData.Count; i++)
            {
                var url = await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]);
                finalImageUrls.Add(url);
            }

            _newFood.ImageUrls = finalImageUrls;
            _newFood.DateAdded = DateTime.UtcNow;
            _newFood.AddedBy = _currentUserName;
            _newFood.IsHelloFresh = _isHelloFresh;

            if (_ratingEnabled)
            {
                _newFood.Ratings[_currentUserName] = _ratingValue;
            }

            await FoodService.AddFoodAsync(_newFood);
            Snackbar.Add("Måltid lagret!", Severity.Success);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Feil ved lagring: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    // --- HELPERS ---
    private string GetMemberColor(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "hsl(0, 0%, 50%)";
        var hash = name.GetHashCode();
        var hue = Math.Abs(hash % 360);
        return $"hsl({hue}, 45%, 45%)";
    }

    private string GetRatingBackground(int rating) => rating switch
    {
        >= 8 => "rgba(45, 90, 69, 0.15)",
        >= 5 => "rgba(212, 160, 23, 0.15)",
        _ => "rgba(196, 69, 54, 0.15)"
    };

    private string GetRatingTextColor(int rating) => rating switch
    {
        >= 8 => "#2D5A45",
        >= 5 => "#A17D00",
        _ => "#C44536"
    };
}