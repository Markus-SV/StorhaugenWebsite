@page "/add"

@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services

@inject IAuthService AuthService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@if (!AuthService.IsAuthorized)
{
    <MudContainer Class="d-flex flex-column align-center justify-center" Style="min-height: 60vh;">
        <MudText Typo="Typo.h5" Class="mb-4">Please log in to continue</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login">Go to Login</MudButton>
    </MudContainer>
}
else
{
    <div class="mb-4">
        <MudText Typo="Typo.h5" Class="font-weight-bold mb-1">
            ➕ Add New Meal
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Rate tonight's dinner with the family
        </MudText>
    </div>

    <MudPaper Class="pa-4 rounded-lg" Elevation="2">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)">
                @_errorMessage
            </MudAlert>
        }

        <!-- Food Name -->
        <MudTextField @bind-Value="_newFood.Name"
                      Label="What did we eat?"
                      Variant="Variant.Outlined"
                      Placeholder="e.g., Taco Tuesday, Grandma's Lasagna"
                      Class="mb-4"
                      Required="true" />

        <!-- Description -->
        <MudTextField @bind-Value="_newFood.Description"
                      Label="Notes (optional)"
                      Variant="Variant.Outlined"
                      Placeholder="Recipe link, ingredients, or notes..."
                      Lines="2"
                      Class="mb-4" />

        <!-- Image Upload -->
        <MudText Typo="Typo.subtitle2" Class="mb-2">Photos</MudText>
        <MudPaper Outlined="true" Class="pa-4 mb-4 rounded-lg">
            @if (_imagePreviewUrls.Any())
            {
                <div class="d-flex gap-2 flex-wrap mb-3">
                    @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                    {
                        var index = i;
                        <div class="position-relative">
                            <MudImage Src="@_imagePreviewUrls[index]"
                                      Width="80" Height="80"
                                      ObjectFit="ObjectFit.Cover"
                                      Class="rounded-lg" />
                            <MudIconButton Icon="@Icons.Material.Filled.Close"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => RemoveImage(index))"
                                           Class="position-absolute"
                                           Style="top: -8px; right: -8px; background: white;" />
                        </div>
                    }
                </div>
            }
            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           FilesChanged="OnImagesSelected"
                           Accept=".png,.jpg,.jpeg,.webp"
                           MaximumFileCount="5">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PhotoCamera"
                               FullWidth="true">
                        @(_imagePreviewUrls.Any() ? "Add More Photos" : "Add Photos")
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        </MudPaper>

        <!-- Ratings -->
        <MudText Typo="Typo.subtitle2" Class="mb-3">Rate the meal (0-10)</MudText>
        @foreach (var member in AppConfig.FamilyNames)
        {
            <MudPaper Outlined="true" Class="pa-3 mb-3 rounded-lg" Style="@($"border-color: {GetMemberColor(member)}40")">
                <div class="d-flex align-center justify-space-between mb-2">
                    <div class="d-flex align-center gap-2">
                        <MudAvatar Size="Size.Small" Style="@($"background-color: {GetMemberColor(member)}")">
                            @member[0]
                        </MudAvatar>
                        <MudText Typo="Typo.subtitle2">@member</MudText>
                    </div>
                    <MudSwitch T="bool"
                               Value="@_ratingsEnabled[member]"
                               ValueChanged="@((bool v) => ToggleRating(member, v))"
                               Color="Color.Primary" />
                </div>
                @if (_ratingsEnabled[member])
                {
                    <div class="d-flex align-center gap-2">
                        <MudSlider T="int"
                                   Value="@GetRatingValue(member)"
                                   ValueChanged="@((int v) => SetRating(member, v))"
                                   Min="0" Max="10" Step="1"
                                   Color="Color.Primary"
                                   Class="flex-grow-1" />
                        <MudChip T="string"
                                 Color="@GetRatingColor(GetRatingValue(member))"
                                 Size="Size.Small"
                                 Style="min-width: 40px;">
                            @GetRatingValue(member)
                        </MudChip>
                    </div>
                }
            </MudPaper>
        }

        <!-- Submit Button -->
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="SubmitFood"
                   Disabled="_isSubmitting"
                   Class="mt-2">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Saving...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                <span>Save Meal</span>
            }
        </MudButton>
    </MudPaper>
}

@code {
    private FoodItem _newFood = new();
    private bool _isSubmitting = false;
    private string? _errorMessage;
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private Dictionary<string, bool> _ratingsEnabled = new()
    {
        { "Markus", false },
        { "Siv", false },
        { "Elias", false }
    };

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("/login");
                return;
            }
        }

        // Pre-enable rating for current user
        if (AuthService.CurrentUser != null)
        {
            _ratingsEnabled[AuthService.CurrentUser.Name] = true;
            _newFood.Ratings[AuthService.CurrentUser.Name] = 5;
        }
    }

    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (_imageData.Count >= 5)
            {
                Snackbar.Add("Maximum 5 images allowed", Severity.Warning);
                break;
            }

            try
            {
                var buffer = new byte[file.Size];
                await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
                _imageData.Add(buffer);
                _imageNames.Add(file.Name);

                var base64 = Convert.ToBase64String(buffer);
                var dataUrl = $"data:{file.ContentType};base64,{base64}";
                _imagePreviewUrls.Add(dataUrl);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading image: {ex.Message}", Severity.Error);
            }
        }
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < _imageData.Count)
        {
            _imageData.RemoveAt(index);
            _imageNames.RemoveAt(index);
            _imagePreviewUrls.RemoveAt(index);
        }
    }

    private void ToggleRating(string member, bool enabled)
    {
        _ratingsEnabled[member] = enabled;
        if (!enabled)
        {
            _newFood.Ratings[member] = null;
        }
        else
        {
            _newFood.Ratings[member] = 5;
        }
    }

    private int GetRatingValue(string member)
    {
        return _newFood.Ratings.TryGetValue(member, out var rating) && rating.HasValue ? rating.Value : 5;
    }

    private void SetRating(string member, int value)
    {
        _newFood.Ratings[member] = value;
    }

    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Please enter a name for the meal.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var uploadedUrls = new List<string>();
            for (int i = 0; i < _imageData.Count; i++)
            {
                var url = await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]);
                uploadedUrls.Add(url);
            }

            _newFood.ImageUrls = uploadedUrls;
            _newFood.DateAdded = DateTime.UtcNow;
            _newFood.AddedBy = AuthService.CurrentUser?.Name ?? "Unknown";

            foreach (var member in AppConfig.FamilyNames)
            {
                if (!_ratingsEnabled[member])
                {
                    _newFood.Ratings[member] = null;
                }
            }

            await FoodService.AddFoodAsync(_newFood);

            Snackbar.Add("Meal saved successfully! 🎉", Severity.Success);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving meal: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string GetMemberColor(string name)
    {
        return name switch
        {
            "Markus" => "#6366f1",
            "Siv" => "#ec4899",
            "Elias" => "#10b981",
            _ => "#94a3b8"
        };
    }

    private Color GetRatingColor(int rating)
    {
        return rating switch
        {
            >= 8 => Color.Success,
            >= 5 => Color.Warning,
            _ => Color.Error
        };
    }
}
