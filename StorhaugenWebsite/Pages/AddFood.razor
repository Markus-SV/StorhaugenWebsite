@page "/add"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using StorhaugenWebsite.Models
@using StorhaugenWebsite.Services
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IHouseholdStateService HouseholdState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IOcrService OcrService
@attribute [Authorize]
@inject IJSRuntime JSRuntime

@* --- 1. CAMERA OVERLAY UI --- *@
@if (_showCameraOverlay)
{
    <div class="camera-overlay">
        <video @ref="_videoElement" autoplay playsinline muted class="camera-video"></video>

        <div class="camera-guide-container">
            <div class="camera-guide-box">
                <div class="scan-line"></div>
            </div>
            <p class="camera-guide-text">Plasser oppskriftsnavnet innenfor ruten</p>
        </div>

        <div class="camera-controls">
            <MudIconButton Icon="@Icons.Material.Rounded.Close"
                           Color="Color.Surface"
                           Size="Size.Large"
                           OnClick="StopCamera"
                           Class="camera-btn-secondary" />

            <button class="camera-shutter" @onclick="CaptureCameraImage"></button>

            <div style="width: 48px;"></div>
        </div>
    </div>
}

@if (!HouseholdState.HasHousehold)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.Home" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Ingen husstand valgt</h2>
        <p class="empty-state-text">Du må opprette eller bli med i en husstand før du kan legge til måltider!</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="settings" StartIcon="@Icons.Material.Rounded.Settings">
            Gå til innstillinger
        </MudButton>
    </div>
}
else
{
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <h1 class="page-title" style="margin-bottom: 4px;">Legg til måltid</h1>
            <p class="page-subtitle">Gi kveldens middag en vurdering</p>
        </div>
    </div>

    <MudPaper Class="pa-2 mb-6 d-flex justify-center gap-2" Elevation="0" Style="background: var(--mud-palette-background-grey); border-radius: 12px;">
        <MudButton Variant="@(_isHelloFresh? Variant.Filled: Variant.Text)"
                   Color="Color.Success"
                   OnClick="@(() => SetFoodType(true))"
                   Class="flex-1"
                   Style="border-radius: 10px; transition: all 0.3s;"
                   StartIcon="@Icons.Custom.Brands.MudBlazor">
            HelloFresh
        </MudButton>
        <MudButton Variant="@(!_isHelloFresh ? Variant.Filled : Variant.Text)"
                   Color="Color.Primary"
                   OnClick="@(() => SetFoodType(false))"
                   Class="flex-1"
                   Style="border-radius: 10px; transition: all 0.3s;"
                   StartIcon="@Icons.Material.Rounded.Restaurant">
            Annet
        </MudButton>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)"
                  Style="border-radius: 12px;">
            @_errorMessage
        </MudAlert>
    }

    <div class="form-section">
        <div class="d-flex justify-space-between align-center">
            <p class="form-section-title">Måltidsdetaljer</p>
            @if (_isHelloFresh)
            {
                <MudChip Size="Size.Small" Color="Color.Success" T=string Variant="Variant.Text" Icon="@Icons.Material.Rounded.AutoAwesome">
                    Autofyll aktiv
                </MudChip>
            }
        </div>

        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudTextField @bind-Value="_newFood.Name"
                          Label="@(_isHelloFresh ? "Hvilken rett er dette?" : "Hva spiste vi?")"
                          Variant="Variant.Outlined"
                          Placeholder="@(_isHelloFresh ? "Skann oppskriftskort..." : "f.eks. Bestemors lasagne")"
                          Required="true"
                          Disabled="_isReadingText"
                          Style="--mud-default-borderradius: 12px; flex-grow: 1;" />

            @if (_isReadingText)
            {
                <MudProgressCircular Color="Color.Success" Size="Size.Small" Indeterminate="true" Class="ml-2" />
                <MudText Typo="Typo.caption" Class="ml-1" Color="Color.Success">Leser kort...</MudText>
            }
        </MudStack>

        <MudTextField @bind-Value="_newFood.Description"
                      Label="Notater (valgfritt)"
                      Variant="Variant.Outlined"
                      Placeholder="Lenke til oppskrift, ingredienser eller kommentarer..."
                      Lines="2"
                      Style="--mud-default-borderradius: 12px;" />
    </div>

    <div class="form-section">
        <p class="form-section-title">Bilder</p>

        @if (_imagePreviewUrls.Any())
        {
            <div class="image-preview-grid">
                @for (int i = 0; i < _imagePreviewUrls.Count; i++)
                {
                    var index = i;
                    <div class="image-preview-item">
                        <img src="@_imagePreviewUrls[index]" alt="Forhåndsvisning" />
                        <button class="image-preview-remove" @onclick="@(() => RemoveImage(index))">
                            <MudIcon Icon="@Icons.Material.Rounded.Close" Size="Size.Small" />
                        </button>
                    </div>
                }
            </div>
        }

        <MudStack Row="true" Spacing="2" Class="w-100">

            @* --- 2. MODIFIED CAMERA BUTTON LOGIC --- *@
            @if (_isHelloFresh)
            {
                @* Use Custom Camera Overlay for HelloFresh *@
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Rounded.DocumentScanner"
                           Size="Size.Large"
                           OnClick="StartCamera"
                           Class="flex-1"
                           Style="border-radius: 12px; height: 56px;">
                    Skann kort
                </MudButton>
            }
            else
            {
                @* Use Standard Native Camera for "Other" *@
                <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                               @ref="@_fileUpload"
                               FilesChanged="OnImagesSelected"
                               Accept="image/*"
                               MaximumFileCount="5"
                               Class="flex-1"
                               InputClass="absolute mud-width-full mud-height-full overflow-hidden z-10"
                               InputStyle="opacity:0"
                               @attributes="@(new Dictionary<string, object> { { "capture", "environment" } })">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Rounded.CameraAlt"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Style="border-radius: 12px; height: 56px;">
                            Ta bilde
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
            }

            @* GALLERY BUTTON (Unchanged) *@
            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           @ref="@_galleryUpload"
                           FilesChanged="OnImagesSelected"
                           Accept="image/*"
                           MaximumFileCount="5"
                           Class="flex-1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Rounded.PhotoLibrary"
                               FullWidth="true"
                               OnClick="@(() => _galleryUpload?.OpenFilePickerAsync())"
                               Style="border-radius: 12px; height: 56px; border-style: dashed; border-width: 2px;">
                        Galleri
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        </MudStack>
    </div>

    <div class="form-section">
        <p class="form-section-title">Din vurdering</p>
        <div class="rating-member-card">
            <div class="rating-member-header">
                <div class="rating-member-info">
                    <div class="rating-member-avatar" style="@($"background: {GetMemberColor(_currentUserName)}")">
                        @(string.IsNullOrEmpty(_currentUserName) ? '?' : _currentUserName[0])
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(string.IsNullOrEmpty(_currentUserName) ? "Ukjent" : _currentUserName)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Primary">(Deg)</MudText>
                    </div>
                </div>
                <MudSwitch T="bool"
                           Value="@_ratingEnabled"
                           ValueChanged="@((bool v) => ToggleRating(v))"
                           Color="Color.Primary" />
            </div>

            @if (_ratingEnabled)
            {
                <div class="rating-slider-container">
                    <MudSlider T="int"
                               Value="@_ratingValue"
                               ValueChanged="@((int v) => _ratingValue = v)"
                               Min="0" Max="10" Step="1"
                               Color="Color.Primary"
                               Style="flex: 1;" />
                    <div class="rating-value-display" style="@($"background: {GetRatingBackground(_ratingValue)}; color: {GetRatingTextColor(_ratingValue)}")">
                        @_ratingValue
                    </div>
                </div>
            }
    </div>
</div>

<div class="form-section">
    <p class="form-section-title">Synlighet</p>

    <div class="visibility-card">
        <div class="d-flex align-center gap-3">
            <MudIcon Icon="@(_newFood.IsPublic? Icons.Material.Rounded.Public : Icons.Material.Rounded.Lock)"
                     Size="Size.Medium"
                     Color="@(_newFood.IsPublic ? Color.Primary : Color.Default)" />
            <div style="flex: 1;">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                    @(_newFood.IsPublic ? "Offentlig" : "Privat")
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @(_newFood.IsPublic
                                        ? "Alle kan finne dette måltidet under 'Utforsk' og legge det til i sin liste"
                                        : "Kun din husstand kan se dette måltidet")
                    </MudText>
                </div>
                <MudSwitch T="bool"
                           @bind-Value="_newFood.IsPublic"
                           Color="Color.Primary" />
            </div>
        </div>

        <MudButton Variant="Variant.Filled"
                   Color="@(_isHelloFresh ? Color.Success : Color.Primary)"
                   Size="Size.Large"
                   FullWidth="true"
                   OnClick="SubmitFood"
                   Disabled="_isSubmitting"
                   Style="border-radius: 14px; padding: 14px; margin-top: 8px;">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Color="Color.Surface" />
                <span>Lagrer...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Rounded.Check" Class="mr-2" />
                <span>Lagre måltid</span>
            }
        </MudButton>
    </div>
}

@code {
    private FoodItem _newFood = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _galleryUpload;
    private bool _isSubmitting = false;
    private bool _isReadingText = false;
    private string? _errorMessage;
    private List<string> _imagePreviewUrls = new();
    private List<byte[]> _imageData = new();
    private List<string> _imageNames = new();
    private bool _ratingEnabled = true;
    private int _ratingValue = 5;
    private string _currentUserName = "";
    private bool _isHelloFresh = true;

    // --- 3. NEW VARIABLES FOR CAMERA ---
    private ElementReference _videoElement;
    private bool _showCameraOverlay = false;

    protected override async Task OnInitializedAsync()
    {
        await HouseholdState.InitializeAsync();
        if (HouseholdState.HasHousehold)
        {
            _currentUserName = AuthService.CurrentUserName ?? "Unknown";
        }
    }

    private void SetFoodType(bool isHelloFresh)
    {
        _isHelloFresh = isHelloFresh;
    }

    // --- 4. NEW METHODS FOR CAMERA INTEROP ---

    private async Task StartCamera()
    {
        _showCameraOverlay = true;
        // Wait for UI to render the <video> element
        await Task.Delay(100);

        try
        {
            await JSRuntime.InvokeVoidAsync("cameraInterop.start", _videoElement);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Kunne ikke starte kamera. Sjekk at du har gitt tillatelse.", Severity.Error);
            _showCameraOverlay = false;
        }
    }

    private async Task StopCamera()
    {
        await JSRuntime.InvokeVoidAsync("cameraInterop.stop", _videoElement);
        _showCameraOverlay = false;
    }

    private async Task CaptureCameraImage()
    {
        try
        {
            // 1. Get Base64 string from JS
            var base64Data = await JSRuntime.InvokeAsync<string>("cameraInterop.capture", _videoElement);

            // 2. Stop camera
            await StopCamera();

            // 3. Process the base64 string
            // Remove "data:image/jpeg;base64," header
            var base64Signature = ";base64,";
            var index = base64Data.IndexOf(base64Signature);
            var cleanBase64 = index >= 0 ? base64Data.Substring(index + base64Signature.Length) : base64Data;

            var bytes = Convert.FromBase64String(cleanBase64);

            // 4. Add to lists
            _imagePreviewUrls.Add(base64Data); // Keep header for preview
            _imageData.Add(bytes);
            _imageNames.Add($"scan_{DateTime.Now.Ticks}.jpg");

            // 5. Trigger OCR automatically
            if (_isHelloFresh && string.IsNullOrWhiteSpace(_newFood.Name))
            {
                await TryAutoFillTitle(base64Data);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Capture error: {ex.Message}");
            Snackbar.Add("Feil ved bildeopptak.", Severity.Error);
        }
    }

    // ... (Keep existing OnImagesSelected, TryAutoFillTitle, AutoCorrectText, etc.) ...
    // Note: Copy the rest of your existing logic here unchanged.
    // I am omitting it for brevity, but make sure to include:
    // - OnImagesSelected
    // - TryAutoFillTitle
    // - AutoCorrectText
    // - ComputeLevenshteinDistance
    // - RemoveImage
    // - ToggleRating
    // - SubmitFood
    // - GetMemberColor, GetRatingBackground, etc.
    // - The _foodVocabulary list

    // --- INSERT YOUR EXISTING HELPER METHODS HERE ---
    private async Task OnImagesSelected(IReadOnlyList<IBrowserFile> files)
    {
        // ... paste your existing code here ...
        // (Just remember to ensure `_imageData` and `_imagePreviewUrls` are populated correctly)
        bool isFirstImage = _imageData.Count == 0;
        long maxFileSize = 1024L * 1024L * 30L;

        foreach (var file in files)
        {
            if (_imageData.Count >= 5) break;
            try
            {
                IBrowserFile fileToRead = file;
                bool wasResized = false;
                try
                {
                    fileToRead = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);
                    wasResized = true;
                }
                catch { }

                using var stream = fileToRead.OpenReadStream(maxAllowedSize: maxFileSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var buffer = ms.ToArray();
                var base64 = Convert.ToBase64String(buffer);
                var previewUrl = $"data:{(wasResized ? "image/jpeg" : file.ContentType)};base64,{base64}";

                _imagePreviewUrls.Add(previewUrl);
                _imageNames.Add(file.Name);
                _imageData.Add(buffer);
                StateHasChanged();
                await Task.Delay(50);

                if (isFirstImage && string.IsNullOrWhiteSpace(_newFood.Name) && _isHelloFresh)
                {
                    _ = TryAutoFillTitle(previewUrl);
                    isFirstImage = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Image processing error: {ex.Message}");
            }
        }
    }

    // ... Include TryAutoFillTitle, AutoCorrectText, SubmitFood, etc from your original file ...
    private async Task TryAutoFillTitle(string dataUrl)
    {
        if (dataUrl.Length > 15 * 1024 * 1024) return;
        _isReadingText = true;
        StateHasChanged();
        try
        {
            var rawText = await OcrService.RecognizeTextAsync(dataUrl);
            if (!string.IsNullOrWhiteSpace(rawText))
            {
                var lines = rawText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                foreach (var line in lines)
                {
                    var cleanLine = line.Trim();
                    if (cleanLine.Length < 3) continue;
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\b(HELLO|FRESH)\b", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"^[\d\W_]+", "");
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"^\b[a-zA-Z]\b\s+", "");
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\d+\s*(P|pers|porsjoner)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\d+(?:-\d+)?\s*min", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    cleanLine = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\([^)]*\)", "");
                    cleanLine = cleanLine.Trim();

                    var stopWords = new[] { " med ", " og ", " servert ", " toppet ", " i " };
                    foreach (var word in stopWords)
                    {
                        int index = cleanLine.IndexOf(word, StringComparison.OrdinalIgnoreCase);
                        if (index > 0)
                        {
                            cleanLine = cleanLine.Substring(0, index).Trim();
                            break;
                        }
                    }
                    cleanLine = AutoCorrectText(cleanLine);
                    if (cleanLine.StartsWith("Sto ", StringComparison.OrdinalIgnoreCase))
                        cleanLine = "Stekt " + cleanLine.Substring(4);

                    if (cleanLine.Length > 3 && cleanLine.Length < 60 && !cleanLine.Any(char.IsDigit))
                    {
                        _newFood.Name = System.Text.RegularExpressions.Regex.Replace(cleanLine, @"\s+", " ").Trim();
                        Snackbar.Add($"Funnet tittel: {_newFood.Name}", Severity.Success);
                        break;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OCR Error: {ex}");
        }
        finally
        {
            _isReadingText = false;
            StateHasChanged();
        }
    }

    private string AutoCorrectText(string input)
    {
        var words = input.Split(' ');
        var correctedWords = new List<string>();
        foreach (var word in words)
        {
            var cleanWord = word.Trim();
            if (string.IsNullOrWhiteSpace(cleanWord)) continue;
            if (_foodVocabulary.Contains(cleanWord, StringComparer.OrdinalIgnoreCase) || cleanWord.Length < 3)
            {
                correctedWords.Add(cleanWord);
                continue;
            }
            string bestMatch = cleanWord;
            int lowestDistance = int.MaxValue;
            foreach (var vocabWord in _foodVocabulary)
            {
                int distance = ComputeLevenshteinDistance(cleanWord.ToLower(), vocabWord.ToLower());
                int threshold = vocabWord.Length <= 4 ? 1 : 2;
                if (distance <= threshold && distance < lowestDistance)
                {
                    lowestDistance = distance;
                    bestMatch = vocabWord;
                }
            }
            correctedWords.Add(bestMatch);
        }
        return string.Join(" ", correctedWords);
    }

    private int ComputeLevenshteinDistance(string s, string t)
    {
        int n = s.Length;
        int m = t.Length;
        int[,] d = new int[n + 1, m + 1];
        if (n == 0) return m;
        if (m == 0) return n;
        for (int i = 0; i <= n; d[i, 0] = i++) { }
        for (int j = 0; j <= m; d[0, j] = j++) { }
        for (int i = 1; i <= n; i++)
        {
            for (int j = 1; j <= m; j++)
            {
                int cost = (t[j - 1] == s[i - 1]) ? 0 : 1;
                d[i, j] = Math.Min(Math.Min(d[i - 1, j] + 1, d[i, j - 1] + 1), d[i - 1, j - 1] + cost);
            }
        }
        return d[n, m];
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < _imageData.Count)
        {
            _imageData.RemoveAt(index);
            _imageNames.RemoveAt(index);
            _imagePreviewUrls.RemoveAt(index);
        }
    }

    private void ToggleRating(bool enabled) => _ratingEnabled = enabled;

    private async Task SubmitFood()
    {
        if (string.IsNullOrWhiteSpace(_newFood.Name))
        {
            _errorMessage = "Please enter a name for the meal.";
            return;
        }
        _isSubmitting = true;
        _errorMessage = null;
        try
        {
            var uploadedUrls = new List<string>();
            for (int i = 0; i < _imageData.Count; i++)
            {
                var url = await FoodService.UploadImageAsync(_imageData[i], _imageNames[i]);
                uploadedUrls.Add(url);
            }
            _newFood.ImageUrls = uploadedUrls;
            _newFood.DateAdded = DateTime.UtcNow;
            _newFood.AddedBy = _currentUserName;
            _newFood.IsHelloFresh = _isHelloFresh;
            if (_ratingEnabled)
            {
                _newFood.Ratings[_currentUserName] = _ratingValue;
            }
            await FoodService.AddFoodAsync(_newFood);
            Snackbar.Add("Meal saved successfully!", Severity.Success);
            Navigation.NavigateTo("");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving meal: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string GetMemberColor(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "hsl(0, 0%, 50%)";
        var hash = name.GetHashCode();
        var hue = Math.Abs(hash % 360);
        return $"hsl({hue}, 45%, 45%)";
    }

    private string GetRatingBackground(int rating) => rating switch
    {
        >= 8 => "rgba(45, 90, 69, 0.15)",
        >= 5 => "rgba(212, 160, 23, 0.15)",
        _ => "rgba(196, 69, 54, 0.15)"
    };

    private string GetRatingTextColor(int rating) => rating switch
    {
        >= 8 => "#2D5A45",
        >= 5 => "#A17D00",
        _ => "#C44536"
    };

    private static readonly List<string> _foodVocabulary = new()
    {
        "Stekt", "Kokt", "Bakt", "Ovnsbakt", "Grillet", "Pannestekt", "Pannestekte",
        "Kylling", "Filet", "Kyllingfilet", "Laks", "Torsk", "Sei", "Svin", "Okse", "Kjøttdeig",
        "Grønnsaker", "Ris", "Poteter", "Pasta", "Nudler", "Mos", "Rotgrønnsaker",
        "Tzatziki", "Saus", "Urter", "Krydret", "Asiatisk", "Meksikansk", "Italiensk", "Indisk",
        "Med", "Og", "Serveres", "Til", "I", "På"
    };
}