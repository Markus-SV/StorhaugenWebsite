@page "/archived"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.Services
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IHouseholdStateService HouseholdState // Inject this!
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<div class="d-flex align-center gap-3 mb-6">
    <h1 class="page-title" style="margin-bottom: 0; font-size: 1.5rem;">Arkiv</h1>
    @if (_archivedItems.Any())
    {
        <p class="page-subtitle" style="margin: 0;">@_archivedItems.Count arkiverte måltider</p>
    }
</div>

@if (!HouseholdState.HasHousehold)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.Home" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Ingen husstand valgt</h2>
        <p class="empty-state-text">Du må være medlem av en husstand for å se arkiverte måltider.</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="settings" StartIcon="@Icons.Material.Rounded.Settings">
            Gå til innstillinger
        </MudButton>
    </div>
}
else if (_isLoading)
{
    <div class="d-flex flex-column gap-2">
        @for (int i = 0; i < 3; i++)
        {
            <div class="skeleton-card">
                <div class="skeleton-content" style="display: flex; gap: 12px;">
                    <div style="width: 60px; height: 60px; border-radius: 12px; background: var(--mud-palette-divider-light);"></div>
                    <div style="flex: 1;">
                        <div class="skeleton-text title" style="margin-bottom: 8px;"></div>
                        <div class="skeleton-text subtitle"></div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (!_archivedItems.Any())
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.Inventory2" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Ingen arkiverte måltider</h2>
        <p class="empty-state-text">Arkiverte måltider vil vises her</p>
    </div>
}
else
{
    <div class="d-flex flex-column gap-2">
        @{
            var index = 0;
        }
        @foreach (var food in _archivedItems.OrderByDescending(f => f.ArchivedDate))
        {
            var currentFood = food;
            var delay = index++;
            <div class="food-list-item animate-in animate-delay-@Math.Min(delay, 4)" style="opacity: 0.85;">
                @if (currentFood.ImageUrls.Any())
                {
                    <img src="@currentFood.ImageUrls.First()"
                         alt="@currentFood.Name"
                         class="food-list-image"
                         style="filter: grayscale(40%);" />
                }
                else
                {
                    <div class="food-list-placeholder">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" />
                    </div>
                }
                <div class="food-list-content" @onclick="@(() => ViewFood(currentFood))">
                    <h3 class="food-list-title">@currentFood.Name</h3>
                    <p class="food-list-date">
                        Arkivert @(currentFood.ArchivedDate?.ToString("dd. MMM yyyy") ?? "")
                        @if (!string.IsNullOrEmpty(currentFood.ArchivedBy))
                        {
                            <span> av @currentFood.ArchivedBy</span>
                        }
                    </p>
                </div>
                <div class="d-flex gap-1 align-center">
                    <MudIconButton Icon="@Icons.Material.Rounded.Visibility"
                                   Size="Size.Small"
                                   OnClick="@(() => ViewFood(currentFood))" />
                    <MudIconButton Icon="@Icons.Material.Rounded.Restore"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="@(() => RestoreFood(currentFood))" />
                </div>
            </div>
        }
    </div>
}

@code {
    private List<FoodItem> _archivedItems = new();
    private bool _isLoading = false; // Default to false, let logic handle it

    protected override async Task OnInitializedAsync()
    {
        // 2. Only load if we have a household
        if (HouseholdState.HasHousehold)
        {
            await LoadArchivedItems();
        }
    }

    private async Task LoadArchivedItems()
    {
        _isLoading = true;
        try
        {
            var allItems = await FoodService.GetAllFoodsAsync(includeArchived: true);
            _archivedItems = allItems.Where(f => f.IsArchived).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading archived items: {ex.Message}");
            // Optionally show snackbar error here if it wasn't expected
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ViewFood(FoodItem food)
    {
        Navigation.NavigateTo($"food/{food.Id}");
    }

    private async Task RestoreFood(FoodItem food)
    {
        try
        {
            await FoodService.RestoreFoodAsync(food.Id);
            _archivedItems.Remove(food);
            Snackbar.Add($"'{food.Name}' gjenopprettet!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
    }
}