@page "/archived"
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@if (!AuthService.IsAuthorized)
{
    <div class="login-container">
        <div class="empty-state">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Lock" Size="Size.Large" />
            </div>
            <h2 class="empty-state-title">Please sign in</h2>
            <p class="empty-state-text">You need to be signed in to view archived meals</p>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login" Size="Size.Large">
                Go to Login
            </MudButton>
        </div>
    </div>
}
else
{
    <!-- Page Header -->
    <div class="detail-header">
        <button class="detail-back-btn" @onclick="@(() => Navigation.NavigateTo("/"))">
            <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
            Back
        </button>
    </div>

    <div class="page-header">
        <h1 class="page-title">Archive</h1>
        <p class="page-subtitle">@_archivedItems.Count archived meals</p>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex flex-column gap-2">
            @for (int i = 0; i < 3; i++)
            {
                <div class="skeleton-card">
                    <div class="skeleton-content" style="display: flex; gap: 12px;">
                        <div style="width: 60px; height: 60px; border-radius: 12px; background: var(--mud-palette-divider-light);"></div>
                        <div style="flex: 1;">
                            <div class="skeleton-text title" style="margin-bottom: 8px;"></div>
                            <div class="skeleton-text subtitle"></div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!_archivedItems.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Inventory2" Size="Size.Large" />
            </div>
            <h2 class="empty-state-title">No archived meals</h2>
            <p class="empty-state-text">Archived meals will appear here</p>
        </div>
    }
    else
    {
        <div class="d-flex flex-column gap-2">
            @{
                var index = 0;
            }
            @foreach (var food in _archivedItems.OrderByDescending(f => f.ArchivedDate))
            {
                var currentFood = food;
                var delay = index++;
                <div class="food-list-item animate-in animate-delay-@Math.Min(delay, 4)" style="opacity: 0.85;">
                    @if (currentFood.ImageUrls.Any())
                    {
                        <img src="@currentFood.ImageUrls.First()"
                             alt="@currentFood.Name"
                             class="food-list-image"
                             style="filter: grayscale(40%);" />
                    }
                    else
                    {
                        <div class="food-list-placeholder">
                            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" />
                        </div>
                    }
                    <div class="food-list-content" @onclick="@(() => ViewFood(currentFood))">
                        <h3 class="food-list-title">@currentFood.Name</h3>
                        <p class="food-list-date">
                            Archived @(currentFood.ArchivedDate?.ToString("MMM dd, yyyy") ?? "")
                            @if (!string.IsNullOrEmpty(currentFood.ArchivedBy))
                            {
                                <span> by @currentFood.ArchivedBy</span>
                            }
                        </p>
                    </div>
                    <div class="d-flex gap-1 align-center">
                        <MudIconButton Icon="@Icons.Material.Rounded.Visibility"
                                       Size="Size.Small"
                                       OnClick="@(() => ViewFood(currentFood))" />
                        <MudIconButton Icon="@Icons.Material.Rounded.Restore"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => RestoreFood(currentFood))" />
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private List<FoodItem> _archivedItems = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("/login");
                return;
            }
        }

        await LoadArchivedItems();
    }

    private async Task LoadArchivedItems()
    {
        _isLoading = true;
        var allItems = await FoodService.GetAllFoodsAsync(includeArchived: true);
        _archivedItems = allItems.Where(f => f.IsArchived).ToList();
        _isLoading = false;
    }

    private void ViewFood(FoodItem food)
    {
        Navigation.NavigateTo($"/food/{food.Id}");
    }

    private async Task RestoreFood(FoodItem food)
    {
        try
        {
            await FoodService.RestoreFoodAsync(food.Id);
            _archivedItems.Remove(food);
            Snackbar.Add($"'{food.Name}' restored!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}