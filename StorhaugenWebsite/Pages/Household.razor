@page "/households"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@inject IApiClient ApiClient
@inject IHouseholdStateService HouseholdState
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<div class="d-flex justify-space-between align-center mb-6">
    <div>
        <h1 class="page-title" style="margin-bottom: 0; font-size: 1.5rem;">Mine Grupper</h1>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Du er medlem av @HouseholdState.UserHouseholds.Count grupper
        </MudText>
    </div>
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Rounded.Add"
               OnClick="CreateHousehold">
        Ny Gruppe
    </MudButton>
</div>

@* --- PENDING INVITES SECTION --- *@
@if (_pendingInvites.Any())
{
    <div class="mb-6 animate-in">
        <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Warning">Invitasjoner</MudText>
        <div class="d-flex flex-column gap-2">
            @foreach (var invite in _pendingInvites)
            {
                <MudPaper Class="pa-4" Elevation="0" Style="background: rgba(var(--mud-palette-warning-rgb), 0.05); border: 1px solid rgba(var(--mud-palette-warning-rgb), 0.2); border-radius: 12px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">@invite.HouseholdName</MudText>
                            <MudText Typo="Typo.caption">Invitert av @invite.InvitedByName</MudText>
                        </div>
                        <div class="d-flex gap-2">
                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => AcceptInvite(invite))">Godta</MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" OnClick="@(() => RejectInvite(invite))">Avslå</MudButton>
                        </div>
                    </div>
                </MudPaper>
            }
        </div>
    </div>
}

@* --- GROUPS LIST --- *@
@if (!HouseholdState.UserHouseholds.Any())
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.GroupOff" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Ingen grupper ennå</h2>
        <p class="empty-state-text">Opprett en gruppe for å dele oppskrifter med familien eller kollektivet.</p>
    </div>
}
else
{
    <div class="d-flex flex-column gap-4">
        @foreach (var household in HouseholdState.UserHouseholds)
        {
            <MudPaper Class="pa-4 group-card" Elevation="0">
                <div class="d-flex align-start justify-space-between mb-3">
                    <div class="d-flex align-center gap-3">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium">
                            @(household.Name.FirstOrDefault().ToString().ToUpper())
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h6" Style="font-size: 1.1rem; font-weight: 600;">@household.Name</MudText>
                            <div class="d-flex align-center gap-2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @household.Members.Count medlemmer
                                </MudText>
                                @if (household.CreatedById == _currentUserId)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Tertiary" Variant="Variant.Text" Class="ml-2">Admin</MudChip>
                                }
                            </div>
                        </div>
                    </div>

                    @if (household.CreatedById == _currentUserId)
                    {
                        <MudMenu Icon="@Icons.Material.Rounded.Settings" Size="Size.Small" AnchorOrigin="Origin.BottomRight">
                            <MudMenuItem Icon="@Icons.Material.Rounded.Edit" OnClick="@(() => EditHouseholdName(household))">Endre navn</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Rounded.ContentCopy" OnClick="@(() => CopyShareId(household.UniqueShareId))">Kopier ID</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Rounded.Refresh" OnClick="@(() => RegenerateShareId(household.Id))">Ny ID</MudMenuItem>
                        </MudMenu>
                    }
                </div>

                <div class="d-flex gap-2 mt-4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Rounded.PersonAdd"
                               OnClick="@(() => InviteMember(household))"
                               FullWidth="true"
                               Style="border-radius: 8px;">
                        Inviter
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               Size="Size.Small"
                               OnClick="@(() => ViewMembers(household))"
                               FullWidth="true"
                               Style="border-radius: 8px;">
                        Medlemmer
                    </MudButton>
                </div>
            </MudPaper>
        }
    </div>
}

@* --- EDIT NAME DIALOG (Simple inline replacement) --- *@
<MudDialog @bind-IsVisible="_showEditDialog" Options="new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true }">
    <TitleContent>Endre navn</TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_editingName" Label="Gruppenavn" Variant="Variant.Outlined" AutoFocus="true" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showEditDialog = false)">Avbryt</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveHouseholdName">Lagre</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .group-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 16px;
        transition: transform 0.2s;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        opacity: 0.8;
    }

    .empty-state-icon {
        background: var(--mud-palette-background-grey);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: var(--mud-palette-text-secondary);
    }
</style>

@code {
    private Guid _currentUserId;
    private List<HouseholdInviteDto> _pendingInvites = new();

    // Edit State
    private bool _showEditDialog;
    private string _editingName = "";
    private Guid _editingHouseholdId;

    protected override async Task OnInitializedAsync()
    {
        // 1. Ensure Auth
        var user = await ApiClient.GetMyProfileAsync();
        if (user != null) _currentUserId = user.Id;

        // 2. Refresh State
        await HouseholdState.InitializeAsync(force: true);

        // 3. Load Invites
        await LoadInvites();
    }

    private async Task LoadInvites()
    {
        try
        {
            _pendingInvites = await ApiClient.GetPendingInvitesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }

    private async Task CreateHousehold()
    {
        var dialog = await DialogService.ShowAsync<StorhaugenWebsite.Components.HouseholdSelector>("Opprett gruppe", new DialogParameters(), new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HouseholdState.RefreshHouseholdsAsync(); // [cite: 3154]
            Snackbar.Add("Ny gruppe opprettet!", Severity.Success);
        }
    }

    private async Task InviteMember(HouseholdDto household)
    {
        var parameters = new DialogParameters
        {
            { "HouseholdId", household.Id },
            { "HouseholdName", household.Name }
        };
        await DialogService.ShowAsync<StorhaugenWebsite.Components.InviteMemberDialog>("Inviter", parameters);
    }

    private async Task ViewMembers(HouseholdDto household)
    {
        var parameters = new DialogParameters { { "Household", household } };
        await DialogService.ShowAsync<StorhaugenWebsite.Components.HouseholdMembersDialog>("Medlemmer", parameters);
    }

    // --- Actions ---

    private void EditHouseholdName(HouseholdDto household)
    {
        _editingHouseholdId = household.Id;
        _editingName = household.Name;
        _showEditDialog = true;
    }

    private async Task SaveHouseholdName()
    {
        if (string.IsNullOrWhiteSpace(_editingName)) return;

        try
        {
            await ApiClient.UpdateHouseholdNameAsync(_editingHouseholdId, new UpdateHouseholdDto { Name = _editingName });
            await HouseholdState.RefreshHouseholdsAsync();
            _showEditDialog = false;
            Snackbar.Add("Navn oppdatert", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Kunne ikke endre navn", Severity.Error);
        }
    }

    private async Task CopyShareId(string? shareId)
    {
        if (string.IsNullOrEmpty(shareId)) return;
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", shareId);
        Snackbar.Add("ID kopiert til utklippstavlen", Severity.Success);
    }

    private async Task RegenerateShareId(Guid householdId)
    {
        var confirm = await DialogService.ShowMessageBox("Ny ID?", "Den gamle ID-en vil slutte å virke.", yesText: "Lag ny", cancelText: "Avbryt");
        if (confirm == true)
        {
            await ApiClient.RegenerateHouseholdShareIdAsync(householdId);
            await HouseholdState.RefreshHouseholdsAsync();
            Snackbar.Add("Ny ID generert", Severity.Success);
        }
    }

    // --- Invites ---

    private async Task AcceptInvite(HouseholdInviteDto invite)
    {
        try
        {
            await ApiClient.AcceptInviteAsync(invite.Id); //
            await HouseholdState.RefreshHouseholdsAsync();
            _pendingInvites.Remove(invite);
            Snackbar.Add($"Du ble med i {invite.HouseholdName}!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Feil ved godkjenning", Severity.Error);
        }
    }

    private async Task RejectInvite(HouseholdInviteDto invite)
    {
        try
        {
            await ApiClient.RejectInviteAsync(invite.Id); //
            _pendingInvites.Remove(invite);
        }
        catch
        {
            Snackbar.Add("Feil ved avvisning", Severity.Error);
        }
    }
}