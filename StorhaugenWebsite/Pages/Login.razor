@page "/login"
@using StorhaugenWebsite.Services
@using MudBlazor
@inject IAuthService AuthService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraSmall" Class="d-flex flex-column align-center justify-center" Style="min-height: 80vh;">
    <MudPaper Elevation="4" Class="pa-8 rounded-xl text-center" Style="width: 100%;">
        <div class="mb-6">
            <MudIcon Icon="@Icons.Material.Filled.RestaurantMenu" Size="Size.Large" Color="Color.Primary" />
        </div>
        
        <MudText Typo="Typo.h4" Class="mb-2 font-weight-bold">Storhaugen Eats</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
            Rate and track family dinners together
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true">@_errorMessage</MudAlert>
        }

        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Size="Size.Large"
                   FullWidth="true"
                   StartIcon="@Icons.Custom.Brands.Google"
                   OnClick="LogIn"
                   Disabled="_isLoading"
                   Class="py-3">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Signing in...</span>
            }
            else
            {
                <span>Sign in with Google</span>
            }
        </MudButton>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-6">
            Only family members can access this app
        </MudText>

        <MudDivider Class="my-6" />

        <div class="d-flex justify-center gap-2">
            @foreach (var member in Models.AppConfig.AllowedUsers)
            {
                <MudAvatar Style="@($"background-color: {member.AvatarColor}")" Size="Size.Small">
                    @member.Name[0]
                </MudAvatar>
            }
        </div>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            Markus, Siv & Elias
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private bool _isLoading = false;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        if (AuthService.IsAuthorized)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task LogIn()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        var (success, error) = await AuthService.LoginAsync();
        
        if (success)
        {
            Navigation.NavigateTo("/");
        }
        else
        {
            _errorMessage = error;
        }

        _isLoading = false;
    }
}
