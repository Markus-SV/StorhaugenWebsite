@page "/food/{Id}"
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@if (!AuthService.IsAuthorized)
{
    <div class="login-container">
        <div class="empty-state">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Rounded.Lock" Size="Size.Large" />
            </div>
            <h2 class="empty-state-title">Please sign in</h2>
            <p class="empty-state-text">You need to be signed in to view meals</p>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="login" Size="Size.Large">
                Go to Login
            </MudButton>
        </div>
    </div>
}
else if (_isLoading)
{
    <div class="d-flex flex-column gap-3">
        <div class="skeleton-card">
            <div class="skeleton-image" style="aspect-ratio: 16/9;"></div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton-content">
                <div class="skeleton-text title"></div>
                <div class="skeleton-text subtitle"></div>
                <div class="skeleton-text" style="width: 80%;"></div>
            </div>
        </div>
        @for (int i = 0; i < 3; i++)
        {
            <div class="skeleton-card">
                <div class="skeleton-content">
                    <div class="skeleton-text" style="width: 50%;"></div>
                </div>
            </div>
        }
    </div>
}
else if (_food == null)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Meal not found</h2>
        <p class="empty-state-text">This meal doesn't exist or has been deleted</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">
            Back to Home
        </MudButton>
    </div>
}
else
{
    <!-- Back Button -->
    <div class="detail-header">
        <button class="detail-back-btn" @onclick="@(() => Navigation.NavigateTo("/"))">
            <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
            Back
        </button>
    </div>

    <!-- Image Carousel -->
    @if (_food.ImageUrls.Any())
    {
        <div class="detail-image-carousel">
            <MudCarousel TData="object"
                         Style="height: 240px; border-radius: 20px;"
                         ShowArrows="@(_food.ImageUrls.Count > 1)"
                         ShowBullets="@(_food.ImageUrls.Count > 1)"
                         EnableSwipeGesture="true"
                         AutoCycle="false">
                @foreach (var imageUrl in _food.ImageUrls)
                {
                    <MudCarouselItem>
                        <MudImage Src="@imageUrl"
                                  Alt="@_food.Name"
                                  ObjectFit="ObjectFit.Cover"
                                  Style="width: 100%; height: 240px; border-radius: 20px;" />
                    </MudCarouselItem>
                }
            </MudCarousel>
        </div>
    }
    else
    {
        <div class="food-card-placeholder" style="border-radius: 20px; margin-bottom: 20px; aspect-ratio: 16/9;">
            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" />
        </div>
    }

    <!-- Info Card -->
    <div class="detail-info-card">
        <div class="d-flex justify-space-between align-start gap-3">
            <div>
                <h1 class="detail-title">@_food.Name</h1>
                <p class="detail-meta">
                    Added by @_food.AddedBy • @_food.DateAdded.ToString("MMMM dd, yyyy")
                </p>
            </div>
            <span class="rating-badge @GetRatingClass(_food.AverageRating)" style="font-size: 1rem; padding: 8px 14px;">
                <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                @_food.AverageRating.ToString("0.0")
            </span>
        </div>

        @if (!string.IsNullOrWhiteSpace(_food.Description))
        {
            <p class="detail-description">@_food.Description</p>
        }

        @if (_food.IsArchived)
        {
            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3" Style="border-radius: 10px;">
                This meal is archived
            </MudAlert>
        }
    </div>

    <!-- Ratings Section -->
    <div class="form-section">
        <p class="form-section-title">Ratings</p>

        @foreach (var member in AppConfig.FamilyNames)
        {
            var currentMember = member;
            var hasRating = _food.Ratings.TryGetValue(currentMember, out var currentRating) && currentRating.HasValue;
            var ratingValue = hasRating ? currentRating!.Value : 0;
            var isCurrentUser = AuthService.CurrentUser?.Name == currentMember;

            <div class="rating-member-card">
                <div class="rating-member-header">
                    <div class="rating-member-info">
                        <div class="rating-member-avatar" style="@($"background: {GetMemberColor(currentMember)}")">
                            @currentMember[0]
                        </div>
                        <div>
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@currentMember</MudText>
                            @if (isCurrentUser)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Primary">(You)</MudText>
                            }
                        </div>
                    </div>
                    @if (hasRating)
                    {
                        <div class="rating-value-display" style="@($"background: {GetRatingBackground(ratingValue)}; color: {GetRatingTextColor(ratingValue)}")">
                            @ratingValue
                        </div>
                    }
                    else
                    {
                        <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small" Style="border-radius: 10px;">
                            Not rated
                        </MudChip>
                    }
                </div>

                @if (_editingRating == currentMember)
                {
                    <div class="rating-slider-container">
                        <MudSlider T="int"
                                   @bind-Value="_tempRating"
                                   Min="0" Max="10" Step="1"
                                   Color="Color.Primary"
                                   Style="flex: 1;" />
                        <div class="rating-value-display" style="@($"background: {GetRatingBackground(_tempRating)}; color: {GetRatingTextColor(_tempRating)}")">
                            @_tempRating
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   OnClick="@(() => SaveRating(currentMember))"
                                   Disabled="_isSaving"
                                   Style="border-radius: 10px;">
                            Save
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   OnClick="CancelEdit"
                                   Style="border-radius: 10px;">
                            Cancel
                        </MudButton>
                    </div>
                }
                else if (isCurrentUser || !hasRating)
                {
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               Size="Size.Small"
                               StartIcon="@(hasRating ? Icons.Material.Rounded.Edit : Icons.Material.Rounded.AddCircle)"
                               OnClick="@(() => StartEditRating(currentMember, ratingValue))"
                               Class="mt-2"
                               Style="border-radius: 10px;">
                        @(hasRating ? "Edit rating" : "Add rating")
                    </MudButton>
                }
            </div>
        }
    </div>

    <!-- Action Buttons -->
    <div class="mt-4">
        @if (!_food.IsArchived)
        {
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Rounded.Archive"
                       OnClick="ArchiveFood"
                       Style="border-radius: 14px; padding: 12px;">
                Archive This Meal
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Rounded.Restore"
                       OnClick="RestoreFood"
                       Style="border-radius: 14px; padding: 12px;">
                Restore This Meal
            </MudButton>
        }
    </div>
}

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private FoodItem? _food;
    private bool _isLoading = true;
    private string? _editingRating;
    private int _tempRating = 5;
    private bool _isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthorized)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsAuthorized)
            {
                Navigation.NavigateTo("/login");
                return;
            }
        }

        await LoadFood();
    }

    private async Task LoadFood()
    {
        _isLoading = true;
        _food = await FoodService.GetFoodByIdAsync(Id);
        _isLoading = false;
    }

    private void StartEditRating(string member, int currentValue)
    {
        _editingRating = member;
        _tempRating = currentValue > 0 ? currentValue : 5;
    }

    private void CancelEdit()
    {
        _editingRating = null;
    }

    private async Task SaveRating(string member)
    {
        if (_food == null) return;

        _isSaving = true;
        try
        {
            await FoodService.UpdateRatingAsync(_food.Id, member, _tempRating);
            _food.Ratings[member] = _tempRating;
            _editingRating = null;
            Snackbar.Add("Rating saved!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ArchiveFood()
    {
        if (_food == null) return;

        var result = await DialogService.ShowMessageBox(
            "Archive Meal",
            "Are you sure you want to archive this meal? It can be restored later.",
            yesText: "Archive",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await FoodService.ArchiveFoodAsync(_food.Id, AuthService.CurrentUser?.Name ?? "Unknown");
                Snackbar.Add("Meal archived", Severity.Info);
                Navigation.NavigateTo("/");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RestoreFood()
    {
        if (_food == null) return;

        try
        {
            await FoodService.RestoreFoodAsync(_food.Id);
            _food.IsArchived = false;
            Snackbar.Add("Meal restored!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private string GetMemberColor(string name)
    {
        return name switch
        {
            "Markus" => "#E07A2E",
            "Siv" => "#2D5A45",
            "Elias" => "#4A7C9B",
            _ => "#6B5D4D"
        };
    }

    private string GetRatingClass(double rating)
    {
        return rating switch
        {
            >= 8 => "rating-high",
            >= 5 => "rating-medium",
            _ => "rating-low"
        };
    }

    private string GetRatingBackground(int rating)
    {
        return rating switch
        {
            >= 8 => "rgba(45, 90, 69, 0.15)",
            >= 5 => "rgba(212, 160, 23, 0.15)",
            _ => "rgba(196, 69, 54, 0.15)"
        };
    }

    private string GetRatingTextColor(int rating)
    {
        return rating switch
        {
            >= 8 => "#2D5A45",
            >= 5 => "#A17D00",
            _ => "#C44536"
        };
    }
}