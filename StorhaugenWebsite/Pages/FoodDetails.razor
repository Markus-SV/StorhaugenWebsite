@page "/food/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Components
@inject IUserRecipeService RecipeService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="@(() => Navigation.NavigateTo("/"))">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_recipe == null)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Fant ikke oppskriften</h2>
        <p class="empty-state-text">
            Denne oppskriften er enten slettet, eller du har mistet tilgangen til den.
        </p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">
            Tilbake til start
        </MudButton>
    </div>
}
else
{
    @* --- IMAGE CAROUSEL --- *@
    @if (_recipe.ImageUrls.Any())
    {
        <div class="detail-image-carousel">
            <MudCarousel Class="mud-width-full"
                         Style="height: 240px; border-radius: 20px;"
                         ShowArrows="@(_recipe.ImageUrls.Count > 1)"
                         ShowBullets="@(_recipe.ImageUrls.Count > 1)"
                         EnableSwipeGesture="true"
                         AutoCycle="false"
                         TData="object">
                @foreach (var imageUrl in _recipe.ImageUrls)
                {
                    <MudCarouselItem Transition="Transition.Slide" Color="@Color.Transparent">
                        <div class="d-flex" style="height:100%">
                            <MudImage Src="@imageUrl" Alt="@_recipe.Name" ObjectFit="ObjectFit.Cover" Style="width: 100%; height: 100%; border-radius: 20px;" />
                        </div>
                    </MudCarouselItem>
                }
            </MudCarousel>
        </div>
    }
    else
    {
        <div class="food-card-placeholder" style="border-radius: 20px; margin-bottom: 20px; aspect-ratio: 16/9; display:flex; align-items:center; justify-content:center; background-color: var(--mud-palette-background-grey);">
            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" Color="Color.Default" />
        </div>
    }

    @* --- INFO CARD --- *@
    <div class="detail-info-card">
        <div class="d-flex justify-space-between align-start gap-3">
            <div>
                <h1 class="detail-title">@_recipe.Name</h1>
                <div class="d-flex align-center gap-2 mt-1">
                    @if (IsOwner)
                    {
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">Min oppskrift</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Icon="@Icons.Material.Rounded.Person">
                            Eies av: @_recipe.UserDisplayName
                        </MudChip>
                    }
                    <MudText Typo="Typo.caption" Color="Color.Secondary">• @_recipe.CreatedAt.ToString("dd. MMM")</MudText>
                </div>
            </div>

            @if (_recipe.AverageRating > 0)
            {
                <span class="rating-badge @GetRatingClass(_recipe.AverageRating)" style="font-size: 1rem; padding: 8px 14px;">
                    <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                    @_recipe.AverageRating.ToString("0.0")
                </span>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(_recipe.Description))
        {
            <p class="detail-description mt-4">@_recipe.Description</p>
        }

        @* Link Status *@
        @if (_recipe.IsLinkedToGlobal)
        {
            <div class="recipe-source-info mt-3">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Rounded.Link" Color="Color.Info" Size="Size.Small" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Dette er en <b>Global Oppskrift</b> (@(_recipe.GlobalRecipeName)).
                        @if (!IsOwner)
                        {
                            <span>Du ser @_recipe.UserDisplayName sin versjon.</span>
                        }
                    </MudText>
                </div>
            </div>
        }
    </div>

    @* --- ACTIONS SECTION --- *@
    <div class="form-section">
        <p class="form-section-title">Handlinger</p>

        @if (IsOwner)
        {
            <div class="d-flex flex-column gap-3">

                @* --- NEW: PUBLISH LOGIC --- *@
                @if (!_recipe.IsPublished)
                {
                    @* Not Published: Show Publish Button *@
                    <div class="visibility-card">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Rounded.Public" Color="Color.Primary" />
                                <div>
                                    <MudText Typo="Typo.subtitle2">Publisering</MudText>
                                    <MudText Typo="Typo.caption">Del oppskriften med hele fellesskapet</MudText>
                                </div>
                            </div>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="PublishRecipe" Disabled="_isProcessing">
                                Publiser
                            </MudButton>
                        </div>
                    </div>
                }
                else
                {
                    @* Published: Show Status and Unpublish Option *@
                    <div class="visibility-card" style="border: 1px solid var(--mud-palette-success); background: rgba(var(--mud-palette-success-rgb), 0.05);">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Success" />
                                <div>
                                    <MudText Typo="Typo.subtitle2">Publisert</MudText>
                                    <MudText Typo="Typo.caption">Tilgjengelig for alle</MudText>
                                </div>
                            </div>
                            <MudMenu Icon="@Icons.Material.Rounded.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight">
                                <MudMenuItem Icon="@Icons.Material.Rounded.Delete" IconColor="Color.Error" OnClick="DeletePublishedRecipe">Slett publisert versjon</MudMenuItem>
                            </MudMenu>
                        </div>
                    </div>
                }

                @* Visibility Settings *@
                <div class="visibility-card">
                    <div class="d-flex align-center justify-space-between">
                        <div class="d-flex align-center gap-3">
                            <MudIcon Icon="@GetVisibilityIcon(_recipe.Visibility)" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.subtitle2">Synlighet</MudText>
                                <MudText Typo="Typo.caption">@GetVisibilityText(_recipe.Visibility)</MudText>
                            </div>
                        </div>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ToggleVisibility">
                            Endre
                        </MudButton>
                    </div>
                </div>

                @* Edit / Archive Buttons *@
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Rounded.Edit" OnClick="EditRecipe">
                        Rediger
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true" StartIcon="@Icons.Material.Rounded.Archive" OnClick="ArchiveRecipe">
                        Arkiver
                    </MudButton>
                </div>
            </div>
        }
        else
        {
            @* Visitor View *@
            <div class="alert-box pa-3 mb-3" style="background-color: rgba(var(--mud-palette-warning-rgb), 0.1); border-radius: 12px;">
                <div class="d-flex gap-3">
                    <MudIcon Icon="@Icons.Material.Rounded.Info" Color="Color.Warning" />
                    <div>
                        <MudText Typo="Typo.subtitle2">Du er i lesemodus</MudText>
                        <MudText Typo="Typo.caption">
                            Dette er @_recipe.UserDisplayName sin oppskrift.
                        </MudText>
                    </div>
                </div>
            </div>

            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Large" StartIcon="@Icons.Material.Rounded.SaveAlt" OnClick="SaveCopyToMyCollection" Disabled="_isProcessing">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Lagrer...</span>
         }
        else
        {
                    <span>Lagre min egen kopi</span>
                }
            </MudButton>
        }
    </div>

    @* --- NOTES & RATING --- *@
    @if (IsOwner)
    {
        <div class="form-section">
            <div class="d-flex justify-space-between align-center mb-2">
                <p class="form-section-title mb-0">Personlige Notater</p>
                <MudIconButton Icon="@Icons.Material.Rounded.Save" Size="Size.Small" Color="Color.Primary" OnClick="SaveNotes" Disabled="_isSavingNotes" />
            </div>
            <MudTextField @bind-Value="_notes" Variant="Variant.Outlined" Lines="3" Placeholder="Notater er kun synlige for deg..." Class="mb-2" />
        </div>
    }

    <div class="form-section">
        <p class="form-section-title">Vurdering</p>
        <div class="d-flex align-center gap-4">
            <MudRating SelectedValue="@(_myRating)" SelectedValueChanged="OnRatingChanged" MaxValue="10" />
            <span style="font-weight:bold; font-size: 1.2em;">@(_myRating > 0 ? _myRating.ToString() : "-")</span>
        </div>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            Din vurdering er personlig og lagres på din bruker.
        </MudText>
    </div>
}

<style>
    .detail-info-card {
        background: var(--mud-palette-surface);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--mud-palette-divider);
    }

    .detail-title {
        font-family: 'Fraunces', serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .visibility-card {
        background: var(--mud-palette-background-grey);
        border-radius: 12px;
        padding: 12px;
    }
</style>

@code {
    [Parameter] public Guid Id { get; set; }

    private UserRecipeDto? _recipe;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private bool _isSavingNotes = false;
    private string _notes = "";
    private int _myRating = 0;
    private Guid _currentUserId;

    private bool IsOwner => _recipe?.UserId == _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = await ApiClient.GetMyProfileAsync();
            if (user != null) _currentUserId = user.Id;
        }
        catch { }
        await LoadRecipe();
    }

    private async Task LoadRecipe()
    {
        _isLoading = true;
        try
        {
            _recipe = await RecipeService.GetRecipeAsync(Id);
            if (_recipe != null)
            {
                _notes = _recipe.PersonalNotes ?? "";
                _myRating = _recipe.MyRating ?? 0;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Kunne ikke laste oppskrift", Severity.Error);
            Console.WriteLine(ex);
        }
        finally { _isLoading = false; }
    }

    // --- NEW: PUBLISH LOGIC ---
    private async Task PublishRecipe()
    {
        if (_recipe == null) return;

        // Use the existing component PublishRecipeDialog
        var parameters = new DialogParameters<PublishRecipeDialog> { { x => x.Recipe, _recipe } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<PublishRecipeDialog>("Publiser", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadRecipe(); // Reload to update UI (IsPublished will be true)
        }
    }

    private async Task DeletePublishedRecipe()
    {
        if (_recipe == null || !_recipe.GlobalRecipeId.HasValue) return;

        var confirm = await DialogService.ShowMessageBox(
            "Slett publisert versjon?",
            "Dette fjerner oppskriften fra fellesskapet. Din lokale kopi beholdes, men koblingen brytes.",
            yesText: "Slett", cancelText: "Avbryt");

        if (confirm == true)
        {
            _isProcessing = true;
            try
            {
                // 1. Detach locally first to break link
                await RecipeService.DetachRecipeAsync(_recipe.Id);

                // 2. Delete the global version using new ApiClient method
                await ApiClient.DeleteGlobalRecipeAsync(_recipe.GlobalRecipeId.Value);

                Snackbar.Add("Publisert versjon slettet.", Severity.Success);
                await LoadRecipe();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
                await LoadRecipe();
            }
            finally { _isProcessing = false; }
        }
    }
    // --------------------------

    private async Task SaveCopyToMyCollection()
    {
        if (_recipe == null) return;
        _isProcessing = true;
        try
        {
            var copyDto = new CreateUserRecipeDto
            {
                Name = $"{_recipe.Name} (Kopi)",
                Description = _recipe.Description,
                Ingredients = _recipe.Ingredients,
                ImageUrls = _recipe.ImageUrls,
                GlobalRecipeId = _recipe.GlobalRecipeId,
                Visibility = "private"
            };
            var newRecipe = await RecipeService.CreateRecipeAsync(copyDto); // [cite: 1201]
            Snackbar.Add("Kopiert!", Severity.Success);
            Navigation.NavigateTo($"food/{newRecipe.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
        finally { _isProcessing = false; }
    }

    private async Task SaveNotes()
    {
        if (_recipe == null) return;
        _isSavingNotes = true;
        try
        {
            await RecipeService.UpdateRecipeAsync(_recipe.Id, new UpdateUserRecipeDto { PersonalNotes = _notes });
            Snackbar.Add("Notater lagret", Severity.Success);
        }
        catch { Snackbar.Add("Kunne ikke lagre notater", Severity.Error); }
        _isSavingNotes = false;
    }

    private async Task OnRatingChanged(int rating)
    {
        if (_recipe == null) return;
        _myRating = rating;
        try
        {
            await RecipeService.RateRecipeAsync(_recipe.Id, rating);
            Snackbar.Add("Vurdering lagret", Severity.Success);
        }
        catch { Snackbar.Add("Kunne ikke lagre vurdering", Severity.Error); }
    }

    private async Task ToggleVisibility()
    {
        if (_recipe == null) return;
        var newVisibility = _recipe.Visibility == "private" ? "household" : "private";
        try
        {
            await RecipeService.UpdateRecipeAsync(_recipe.Id, new UpdateUserRecipeDto { Visibility = newVisibility });
            _recipe.Visibility = newVisibility;
            Snackbar.Add($"Endret til {GetVisibilityText(newVisibility)}", Severity.Info);
        }
        catch { Snackbar.Add("Feil ved endring", Severity.Error); }
    }

    private async Task ArchiveRecipe()
    {
        if (_recipe == null) return;
        var confirm = await DialogService.ShowMessageBox("Arkiver", "Er du sikker?", yesText: "Arkiver", cancelText: "Avbryt");
        if (confirm == true)
        {
            await RecipeService.ArchiveRecipeAsync(_recipe.Id);
            Navigation.NavigateTo("");
        }
    }

    private void EditRecipe() => Snackbar.Add("Redigering kommer snart", Severity.Info);

    private string GetRatingClass(double r) => r >= 8 ? "rating-high" : r >= 5 ? "rating-medium" : "rating-low";
    private string GetVisibilityText(string v) => v switch { "private" => "Privat (Kun deg)", "household" => "Husstand", "public" => "Offentlig", _ => v };
    private string GetVisibilityIcon(string v) => v switch { "household" => Icons.Material.Rounded.Home, "public" => Icons.Material.Rounded.Public, _ => Icons.Material.Rounded.Lock };
}