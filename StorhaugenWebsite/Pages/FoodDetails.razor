@page "/food/{Id}"
@using Microsoft.AspNetCore.Authorization
@inject IAuthService AuthService
@inject IFoodService FoodService
@inject IHouseholdStateService HouseholdState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<!-- Back Button -->
<div class="detail-header">
    <button class="detail-back-btn" @onclick="@(() => Navigation.NavigateTo(""))">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="d-flex flex-column gap-3">
        <div class="skeleton-card">
            <div class="skeleton-image" style="aspect-ratio: 16/9;"></div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton-content">
                <div class="skeleton-text title"></div>
                <div class="skeleton-text subtitle"></div>
                <div class="skeleton-text" style="width: 80%;"></div>
            </div>
        </div>
        @for (int i = 0; i < 3; i++)
        {
            <div class="skeleton-card">
                <div class="skeleton-content">
                    <div class="skeleton-text" style="width: 50%;"></div>
                </div>
            </div>
        }
    </div>
}
else if (_food == null)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Måltid ikke funnet</h2>
        <p class="empty-state-text">Dette måltidet finnes ikke eller har blitt slettet</p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">
            Tilbake til hjemskjerm
        </MudButton>
    </div>
}
else
{
    <!-- Image Carousel -->
    @if (_food.ImageUrls.Any())
    {
        <div class="detail-image-carousel">
            <MudCarousel TData="object"
                         Style="height: 240px; border-radius: 20px;"
                         ShowArrows="@(_food.ImageUrls.Count > 1)"
                         ShowBullets="@(_food.ImageUrls.Count > 1)"
                         EnableSwipeGesture="true"
                         AutoCycle="false">
                @foreach (var imageUrl in _food.ImageUrls)
                {
                    <MudCarouselItem>
                        <MudImage Src="@imageUrl"
                                  Alt="@_food.Name"
                                  ObjectFit="ObjectFit.Cover"
                                  Style="width: 100%; height: 240px; border-radius: 20px;" />
                    </MudCarouselItem>
                }
            </MudCarousel>
        </div>
    }
    else
    {
        <div class="food-card-placeholder" style="border-radius: 20px; margin-bottom: 20px; aspect-ratio: 16/9;">
            <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" />
        </div>
    }

    <!-- Info Card -->
    <div class="detail-info-card">
        <div class="d-flex justify-space-between align-start gap-3">
            <div>
                <h1 class="detail-title">@_food.Name</h1>
                <p class="detail-meta">
                    Lagt til av @_food.AddedBy • @_food.DateAdded.ToString("dd. MMMM yyyy")
                </p>
            </div>
            <span class="rating-badge @GetRatingClass(_food.AverageRating)" style="font-size: 1rem; padding: 8px 14px;">
                <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                @_food.AverageRating.ToString("0.0")
            </span>
        </div>

        @if (!string.IsNullOrWhiteSpace(_food.Description))
        {
            <p class="detail-description">@_food.Description</p>
        }

        <!-- Personal Notes Section -->
        <div class="personal-notes-section">
            @if (_editingNotes)
            {
                <div class="personal-notes-edit">
                    <MudTextField @bind-Value="_tempNotes"
                                  Label="Personlige notater"
                                  Variant="Variant.Outlined"
                                  Lines="3"
                                  Placeholder="Legg til dine notater, endringer eller tips..."
                                  Style="border-radius: 10px; margin-bottom: 12px;" />
                    <div class="d-flex gap-2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   OnClick="SaveNotes"
                                   Disabled="_isSavingNotes"
                                   Style="border-radius: 10px;">
                            @if (_isSavingNotes)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                            }
                            Lagre
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   OnClick="CancelEditNotes"
                                   Style="border-radius: 10px;">
                            Avbryt
                        </MudButton>
                    </div>
                </div>
            }
            else
            {
                @if (!string.IsNullOrWhiteSpace(_food.PersonalNotes))
                {
                    <div class="personal-notes">
                        <div class="d-flex justify-space-between align-center mb-2">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Rounded.StickyNote2" Size="Size.Small" />
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">Personlige notater</MudText>
                            </div>
                            <MudIconButton Icon="@Icons.Material.Rounded.Edit"
                                           Size="Size.Small"
                                           OnClick="StartEditNotes" />
                        </div>
                        <MudText Typo="Typo.body2">@_food.PersonalNotes</MudText>
                    </div>
                }
                else
                {
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Rounded.AddCircle"
                               OnClick="StartEditNotes"
                               Size="Size.Small"
                               Style="margin-top: 8px;">
                        Legg til notater
                    </MudButton>
                }
            }
        </div>

        @if (_food.IsLinkedToGlobal || _food.IsForked)
        {
            <div class="recipe-source-info">
                @if (_food.IsLinkedToGlobal)
                {
                    <MudChip Size="Size.Small"
                             Color="Color.Info"
                             T="string"
                             Icon="@Icons.Material.Rounded.Link"
                             Style="height: 24px;">
                        Lenket til @(_food.GlobalRecipeName ?? "Global oppskrift")
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        Denne oppskriften er lenket. Oppdateringer i hovedoppskriften vil vises her.
                    </MudText>
                }
                else if (_food.IsForked)
                {
                    <MudChip Size="Size.Small"
                             Color="Color.Success"
                             T="string"
                             Icon="@Icons.Material.Rounded.ContentCopy"
                             Style="height: 24px;">
                        Kopiert fra @(_food.GlobalRecipeName ?? "Global oppskrift")
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        Dette er en kopi du kan redigere fritt.
                    </MudText>
                }
            </div>
        }

        @if (_food.IsArchived)
        {
            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3" Style="border-radius: 10px;">
                Dette måltidet er arkivert
            </MudAlert>
        }
    </div>

    <!-- Ratings Section -->
    <div class="form-section">
        <p class="form-section-title">Vurderinger</p>

        @{
            var currentUserHasRating = _food.Ratings.TryGetValue(CurrentUserDisplayName, out var currentUserRating) && currentUserRating.HasValue;
        }

        @* Show current user's rating card first *@
        <div class="rating-member-card">
            <div class="rating-member-header">
                <div class="rating-member-info">
                    <div class="rating-member-avatar" style="@($"background: {GetMemberColor(CurrentUserDisplayName)}")">
                        @(CurrentUserDisplayName.Length > 0 ? CurrentUserDisplayName[0] : '?')
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@CurrentUserDisplayName</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Primary">(Deg)</MudText>
                    </div>
                </div>
                @if (currentUserHasRating)
                {
                    <div class="rating-value-display" style="@($"background: {GetRatingBackground(currentUserRating!.Value)}; color: {GetRatingTextColor(currentUserRating!.Value)}")">
                        @currentUserRating
                    </div>
                }
                else
                {
                    <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small" Style="border-radius: 10px;">
                        Ikke vurdert
                    </MudChip>
                }
            </div>

            @if (_editingRating == CurrentUserDisplayName)
            {
                <div class="rating-slider-container">
                    <MudSlider T="int"
                               @bind-Value="_tempRating"
                               Min="0" Max="10" Step="1"
                               Color="Color.Primary"
                               Style="flex: 1;" />
                    <div class="rating-value-display" style="@($"background: {GetRatingBackground(_tempRating)}; color: {GetRatingTextColor(_tempRating)}")">
                        @_tempRating
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               OnClick="@(() => SaveRating(CurrentUserDisplayName))"
                               Disabled="_isSaving"
                               Style="border-radius: 10px;">
                        Lagre
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Small"
                               OnClick="CancelEdit"
                               Style="border-radius: 10px;">
                        Avbryt
                    </MudButton>
                </div>
            }
            else
            {
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@(currentUserHasRating ? Icons.Material.Rounded.Edit : Icons.Material.Rounded.AddCircle)"
                           OnClick="@(() => StartEditRating(CurrentUserDisplayName, currentUserHasRating ? currentUserRating!.Value : 5))"
                           Class="mt-2"
                           Style="border-radius: 10px;">
                    @(currentUserHasRating ? "Rediger vurdering" : "Legg til vurdering")
                </MudButton>
            }
        </div>

        @* Show other members' ratings (read-only) *@
        @foreach (var rating in _food.Ratings.Where(r => r.Value.HasValue && r.Key != CurrentUserDisplayName))
        {
            var memberName = rating.Key;
            var ratingValue = rating.Value!.Value;

            <div class="rating-member-card">
                <div class="rating-member-header">
                    <div class="rating-member-info">
                        <div class="rating-member-avatar" style="@($"background: {GetMemberColor(memberName)}")">
                            @memberName[0]
                        </div>
                        <div>
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@memberName</MudText>
                        </div>
                    </div>
                    <div class="rating-value-display" style="@($"background: {GetRatingBackground(ratingValue)}; color: {GetRatingTextColor(ratingValue)}")">
                        @ratingValue
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Visibility Section -->
    <div class="form-section">
        <p class="form-section-title">Synlighet</p>

        <div class="visibility-card">
            <div class="d-flex align-center gap-3">
                <MudIcon Icon="@(_food.IsPublic? Icons.Material.Rounded.Public : Icons.Material.Rounded.Lock)"
                         Size="Size.Medium"
                         Color="@(_food.IsPublic ? Color.Primary : Color.Default)" />
                <div style="flex: 1;">
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                        @(_food.IsPublic ? "Offentlig" : "Privat")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @(_food.IsPublic
                                            ? "Alle kan finne dette måltidet under 'Utforsk' og legge det til i sin liste"
                                            : "Kun din husstand kan se dette måltidet")
                        </MudText>
                    </div>
                    <MudSwitch T="bool"
                               Value="_food.IsPublic"
                               ValueChanged="@((bool v) => ToggleVisibility(v))"
                               Color="Color.Primary"
                               Disabled="_isTogglingVisibility" />
                </div>
                @if (_food.IsPublic && !string.IsNullOrEmpty(_food.HouseholdName))
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                        Delt av @_food.HouseholdName
                    </MudText>
                }
            </div>
        </div>

    <!-- Action Buttons -->
    <div class="mt-4">
        @if (_food.IsLinkedToGlobal)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Rounded.ContentCopy"
                       OnClick="ForkRecipe"
                       Disabled="_isForking"
                       Style="border-radius: 14px; padding: 12px; margin-bottom: 12px;">
                @if (_isForking)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Kopierer oppskrift...</span>
                }
                else
                {
                    <span>Kopier til redigerbar versjon</span>
                }
            </MudButton>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3" Style="text-align: center; display: block;">
                Lag en redigerbar kopi du kan endre uavhengig av originalen
            </MudText>
        }

        @if (!_food.IsArchived)
        {
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Rounded.Archive"
                       OnClick="ArchiveFood"
                       Style="border-radius: 14px; padding: 12px;">
                Arkiver måltid
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Rounded.Restore"
                       OnClick="RestoreFood"
                       Style="border-radius: 14px; padding: 12px;">
                Gjenopprett måltid
            </MudButton>
        }
    </div>
}

<style>
    .personal-notes-section {
        margin-top: 16px;
    }

    .personal-notes {
        padding: 16px;
        background: rgba(var(--mud-palette-info-rgb), 0.08);
        border-left: 4px solid var(--mud-palette-info);
        border-radius: 10px;
    }

    .personal-notes-edit {
        padding: 16px;
        background: var(--mud-palette-background-grey);
        border-radius: 10px;
    }

    .recipe-source-info {
        margin-top: 12px;
        padding: 12px;
        background: var(--mud-palette-background-grey);
        border-radius: 10px;
    }
</style>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private FoodItem? _food;
    private bool _isLoading = true;
    private string? _editingRating;
    private int _tempRating = 5;
    private bool _isSaving = false;
    private bool _isForking = false;
    private bool _editingNotes = false;
    private string _tempNotes = "";
    private bool _isSavingNotes = false;
    private bool _isTogglingVisibility = false;

    // Get current user's display name from household members (matches what backend uses for ratings)
    private string CurrentUserDisplayName => HouseholdState.CurrentHousehold?.Members
        .FirstOrDefault(m => m.Email.Equals(AuthService.CurrentUserEmail, StringComparison.OrdinalIgnoreCase))?.DisplayName
        ?? AuthService.CurrentUserName ?? "";

    protected override async Task OnInitializedAsync()
    {
        // Wait for household state to be initialized
        await HouseholdState.InitializeAsync();

        if (!HouseholdState.HasHousehold)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadFood();
    }

    private async Task LoadFood()
    {
        _isLoading = true;
        _food = await FoodService.GetFoodByIdAsync(Id);
        _isLoading = false;
    }

    private void StartEditRating(string member, int currentValue)
    {
        _editingRating = member;
        _tempRating = currentValue > 0 ? currentValue : 5;
    }

    private void CancelEdit()
    {
        _editingRating = null;
    }

    private async Task SaveRating(string member)
    {
        if (_food == null) return;

        _isSaving = true;
        try
        {
            await FoodService.UpdateRatingAsync(_food.Id, member, _tempRating);
            _food.Ratings[member] = _tempRating;
            _editingRating = null;
            Snackbar.Add("Vurdering lagret!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ArchiveFood()
    {
        if (_food == null) return;

        var result = await DialogService.ShowMessageBox(
            "Arkiver måltid",
            "Er du sikker på at du vil arkivere dette måltidet? Det kan gjenopprettes senere.",
            yesText: "Arkiver",
            cancelText: "Avbryt");

        if (result == true)
        {
            try
            {
                await FoodService.ArchiveFoodAsync(_food.Id, AuthService.CurrentUserName ?? "Unknown");
                Snackbar.Add("Måltid arkivert", Severity.Info);
                Navigation.NavigateTo("");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RestoreFood()
    {
        if (_food == null) return;

        try
        {
            await FoodService.RestoreFoodAsync(_food.Id);
            _food.IsArchived = false;
            Snackbar.Add("Måltid gjenopprettet!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ForkRecipe()
    {
        if (_food == null) return;

        var result = await DialogService.ShowMessageBox(
             "Kopier oppskrift",
             "Dette vil lage en redigerbar kopi av oppskriften. Kopien vil ikke lenger oppdateres når hovedoppskriften endres. Fortsett?",
             yesText: "Kopier",
             cancelText: "Avbryt");

        if (result == true)
        {
            _isForking = true;
            try
            {
                await FoodService.ForkRecipeAsync(_food.Id);

                // Update local state
                _food.IsForked = true;

                Snackbar.Add("Oppskrift kopiert! Du kan nå redigere denne kopien.", Severity.Success);

                // Reload to get updated data from server
                await LoadFood();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
            finally
            {
                _isForking = false;
            }
        }
    }

    private void StartEditNotes()
    {
        _tempNotes = _food?.PersonalNotes ?? "";
        _editingNotes = true;
    }

    private void CancelEditNotes()
    {
        _editingNotes = false;
        _tempNotes = "";
    }

    private async Task SaveNotes()
    {
        if (_food == null) return;

        _isSavingNotes = true;
        try
        {
            _food.PersonalNotes = _tempNotes;
            await FoodService.UpdateFoodAsync(_food);
            _editingNotes = false;
            Snackbar.Add("Personlige notater lagret!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingNotes = false;
        }
    }

    private async Task ToggleVisibility(bool isPublic)
    {
        if (_food == null) return;

        _isTogglingVisibility = true;
        try
        {
            await FoodService.SetPublicStatusAsync(_food.Id, isPublic);
            _food.IsPublic = isPublic;
            Snackbar.Add(isPublic ? "Måltidet er nå offentlig!" : "Måltidet er nå privat", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isTogglingVisibility = false;
        }
    }

    private string GetMemberColor(string name)
    {
        var hash = name.GetHashCode();
        var hue = Math.Abs(hash % 360);
        return $"hsl({hue}, 45%, 45%)";
    }

    private string GetRatingClass(double rating)
    {
        return rating switch
        {
            >= 8 => "rating-high",
            >= 5 => "rating-medium",
            _ => "rating-low"
        };
    }

    private string GetRatingBackground(int rating)
    {
        return rating switch
        {
            >= 8 => "rgba(45, 90, 69, 0.15)",
            >= 5 => "rgba(212, 160, 23, 0.15)",
            _ => "rgba(196, 69, 54, 0.15)"
        };
    }

    private string GetRatingTextColor(int rating)
    {
        return rating switch
        {
            >= 8 => "#2D5A45",
            >= 5 => "#A17D00",
            _ => "#C44536"
        };
    }
}