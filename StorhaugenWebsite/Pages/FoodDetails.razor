@page "/food/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Components
@using StorhaugenWebsite.Shared.Extensions
@using System.Text.Json
@inject IUserRecipeService RecipeService
@inject IAuthService AuthService
@inject IUserColorService UserColorService
@inject IUserFriendshipService FriendshipService
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ICollectionStateService CollectionState
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_recipe == null)
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" />
        </div>
        <h2 class="empty-state-title">Fant ikke oppskriften</h2>
        <p class="empty-state-text">
            Denne oppskriften er enten slettet, eller du har mistet tilgangen til den.
        </p>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="">
            Tilbake til start
        </MudButton>
    </div>
}
else
{
    @* --- IMAGE CAROUSEL --- *@
    @if (_recipe.ImageUrls.Any())
    {
        <div class="detail-image-carousel">
            <MudCarousel Class="mud-width-full"
                         Style="height: 240px; border-radius: 20px;"
                         ShowArrows="@(_recipe.ImageUrls.Count > 1)"
                         ShowBullets="@(_recipe.ImageUrls.Count > 1)"
                         EnableSwipeGesture="true"
                         AutoCycle="false"
                         TData="object">
                @foreach (var imageUrl in _recipe.ImageUrls)
                {
                    <MudCarouselItem Transition="Transition.Slide" Color="@Color.Transparent">
                        <div class="d-flex" style="height:100%">
                            <MudImage Src="@imageUrl" Alt="@_recipe.Name" ObjectFit="ObjectFit.Cover" Style="width: 100%; height: 100%; border-radius: 20px;" />
                        </div>
                    </MudCarouselItem>
                }
            </MudCarousel>
        </div>
    }
    

    @* --- INFO CARD --- *@
    <div class="detail-info-card">
        <div class="d-flex justify-space-between align-start gap-3">
            <div>
                <h1 class="detail-title">@_recipe.Name</h1>
                <div class="d-flex align-center gap-2 mt-1 flex-wrap">
                    @if (_recipe.IsHellofresh)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Rounded.LocalDining">HelloFresh</MudChip>
                    }
                    else if (IsOwner)
                    {
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">Min oppskrift</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Icon="@Icons.Material.Rounded.Person">
                            @_recipe.UserDisplayName
                        </MudChip>
                    }
                    <MudText Typo="Typo.caption" Color="Color.Secondary">• @_recipe.CreatedAt.ToString("dd. MMM")</MudText>
                </div>
            </div>

            @if (_recipe.AverageRating > 0)
            {
                <div class="d-flex flex-column align-end">
                    <span class="rating-badge @GetRatingClass(_recipe.AverageRating)" style="font-size: 1rem; padding: 8px 14px; color:@_recipe.AverageRating.ToRatingColorHex();">
                        <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" />
                        @_recipe.AverageRating.ToString("0.0")
                    </span>
                    @if (_recipe.RatingCount > 0)
                    {
                        <span class="rating-count-badge">
                            <MudIcon Icon="@Icons.Material.Rounded.People" Size="Size.Small" Style="font-size: 12px;" />
                            @_recipe.RatingCount
                        </span>
                    }
                </div>
            }
        </div>

        @* Quick Info (PrepTime, CookTime, Difficulty, Servings, Cuisine) *@
        @if (_recipe.PrepTimeMinutes.HasValue || _recipe.CookTimeMinutes.HasValue || !string.IsNullOrEmpty(_recipe.Difficulty) || _recipe.Servings.HasValue || !string.IsNullOrEmpty(_recipe.Cuisine))
        {
            <div class="quick-info-row mt-3">
                @if (_recipe.PrepTimeMinutes.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.AccessTime" Size="Size.Small" Color="Color.Primary" />
                        <span>@_recipe.PrepTimeMinutes min tilberedning</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Difficulty))
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@GetDifficultyIcon(_recipe.Difficulty)" Size="Size.Small" Color="Color.Secondary" />
                        <span>@GetDifficultyLabel(_recipe.Difficulty)</span>
                    </div>
                }
                @if (_recipe.Servings.HasValue)
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Group" Size="Size.Small" Color="Color.Tertiary" />
                        <span>@_recipe.Servings porsjoner</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_recipe.Cuisine))
                {
                    <div class="quick-info-item">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Small" Color="Color.Info" />
                        <span>@_recipe.Cuisine</span>
                    </div>
                }
            </div>
        }

        @* HelloFresh Week Info *@
        @if (_recipe.IsHellofresh && !string.IsNullOrEmpty(_recipe.HellofreshWeek))
        {
            var weekNumber = int.Parse(_recipe.HellofreshWeek.Split("-W")[1]);

            <div class="d-flex align-center gap-2 mt-2">
                <MudIcon Icon="@Icons.Material.Rounded.CalendarMonth" Size="Size.Small" Color="Color.Success" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">HelloFresh uke @weekNumber</MudText>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(_recipe.Description))
        {
            <p class="detail-description mt-4">@_recipe.Description</p>
        }

        @* Recipe Tags *@
        @if (_recipe.RecipeTags.Any())
        {
            <div class="d-flex flex-wrap gap-2 mt-3">
                @foreach (var tag in _recipe.RecipeTags)
                {
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">@tag</MudChip>
                }
            </div>
        }

        @* Link Status *@
        @if (_recipe.IsLinkedToGlobal && !_recipe.IsHellofresh)
        {
            <div class="recipe-source-info mt-3">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Rounded.Link" Color="Color.Info" Size="Size.Small" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Koblet til: <b>@(_recipe.GlobalRecipeName)</b>
                    </MudText>
                </div>
            </div>
        }
    </div>

    @* --- NUTRITION + INGREDIENTS (normal sections) --- *@
    @if (HasNutritionData)
    {
        <div class="form-section">
            <div class="section-title-row">
                <MudIcon Icon="@Icons.Material.Rounded.LocalFireDepartment" Size="Size.Small" Color="Color.Primary" />
                <p class="form-section-title" style="margin:0;">Næringsinformasjon</p>
            </div>

            <div class="nutrition-grid mt-2">
                @foreach (var item in ParseNutrition())
                {
                    <div class="nutrition-item">
                        <span class="nutrition-value">@item.Amount</span>
                        <span class="nutrition-label">@item.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    @if (HasIngredients)
    {
        <div class="form-section">
            <div class="section-title-row">
                <MudIcon Icon="@Icons.Material.Rounded.ShoppingCart" Size="Size.Small" Color="Color.Primary" />
                <p class="form-section-title" style="margin:0;">
                    Ingredienser (@ParseIngredients().Count)
                </p>
            </div>

            <div class="ingredients-list mt-2">
                @foreach (var ingredient in ParseIngredients())
                {
                    <div class="ingredient-item">
                        @if (!string.IsNullOrEmpty(ingredient.Image))
                        {
                            <img src="@GetIngredientImageUrl(ingredient.Image)"
                                 alt="@ingredient.Name"
                                 class="ingredient-image" />
                        }
                        else
                        {
                            <div class="ingredient-placeholder">
                                <MudIcon Icon="@Icons.Material.Rounded.Egg" Size="Size.Small" />
                            </div>
                        }

                        <div class="ingredient-info">
                            <span class="ingredient-name">@ingredient.Name</span>
                            @if (!string.IsNullOrEmpty(ingredient.Amount) || !string.IsNullOrEmpty(ingredient.Unit))
                            {
                                <span class="ingredient-amount">@ingredient.Amount @ingredient.Unit</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }


    @* --- ACTIONS SECTION --- *@
    <div class="form-section">
        <p class="form-section-title">Handlinger</p>

        @if (IsOwner)
        {
            <div class="d-flex flex-column gap-3">

                @* --- NEW: PUBLISH LOGIC --- *@
                @if (!_recipe.IsPublished)
                {
                    @* Not Published: Show Publish Button *@
                    <div class="visibility-card">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Rounded.Public" Color="Color.Info" />
                                <div>
                                    <MudText Typo="Typo.subtitle2">Publisering</MudText>
                                    <MudText Typo="Typo.caption">Del oppskriften med hele fellesskapet</MudText>
                                </div>
                            </div>
                            <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" OnClick="PublishRecipe" Disabled="_isProcessing">
                                Publiser
                            </MudButton>
                        </div>
                    </div>
                }
                else
                {
                    @* Published: Show Status and Unpublish Option *@
                    <div class="visibility-card" style="border: 1px solid var(--mud-palette-success); background: rgba(var(--mud-palette-success-rgb), 0.05);">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Success" />
                                <div>
                                    <MudText Typo="Typo.subtitle2">Publisert</MudText>
                                    <MudText Typo="Typo.caption">Tilgjengelig for alle</MudText>
                                </div>
                            </div>
                            <MudMenu Icon="@Icons.Material.Rounded.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight">
                                <MudMenuItem Icon="@Icons.Material.Rounded.Delete" IconColor="Color.Error" OnClick="DeletePublishedRecipe">Slett publisert versjon</MudMenuItem>
                            </MudMenu>
                        </div>
                    </div>
                }

                @* Collection Management *@
                <div class="visibility-card">
                    <div class="d-flex align-center justify-space-between mb-2">
                        <div class="d-flex align-center gap-3">
                            <MudIcon Icon="@Icons.Material.Rounded.FolderShared" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.subtitle2">Samlinger</MudText>
                                <MudText Typo="Typo.caption">Organiser oppskriften i samlinger</MudText>
                            </div>
                        </div>
                    </div>

                    @if (_recipeCollections.Any())
                    {
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            @foreach (var collection in _recipeCollections)
                            {
                                <MudChip T="string"
                                         Color="Color.Primary"
                                         Size="Size.Small"
                                         OnClose="@(() => RemoveFromCollection(collection.Id))"
                                         Icon="@Icons.Material.Rounded.Folder">
                                    @collection.Name
                                </MudChip>
                            }
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            Ikke i noen samling
                        </MudText>
                    }

                    @if (CollectionState.UserCollections.Any(c => !_recipeCollections.Any(rc => rc.Id == c.Id)))
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   StartIcon="@Icons.Material.Rounded.Add"
                                   OnClick="OpenAddToCollectionMenu">
                            Legg til i samling
                        </MudButton>
                    }
                </div>

                @* Edit / Archive Buttons *@
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Rounded.Edit" OnClick="EditRecipe">
                        Rediger
                    </MudButton>
                    @if (_recipe.IsArchived)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="true" FullWidth="true" StartIcon="@Icons.Material.Rounded.Inventory2">
                            Allerede arkivert
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true" StartIcon="@Icons.Material.Rounded.Archive" OnClick="ArchiveRecipe">
                            Arkiver
                        </MudButton>
                    }
                </div>
            </div>
        }
        else
        {
            @* Visitor View *@
            <div class="alert-box pa-3 mb-3" style="background-color: rgba(var(--mud-palette-warning-rgb), 0.1); border-radius: 12px;">
                <div class="d-flex gap-3">
                    <MudIcon Icon="@Icons.Material.Rounded.Info" Color="Color.Warning" />
                    <div>
                        <MudText Typo="Typo.subtitle2">Du er i lesemodus</MudText>
                        <MudText Typo="Typo.caption">
                            Dette er @_recipe.UserDisplayName sin oppskrift.
                        </MudText>
                    </div>
                </div>
            </div>

            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Large" StartIcon="@Icons.Material.Rounded.SaveAlt" OnClick="SaveCopyToMyCollection" Disabled="_isProcessing">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Lagrer...</span>
         }
        else
        {
                    <span>Lagre min egen kopi</span>
                }
            </MudButton>
        }
    </div>

    @* --- NOTES & RATING --- *@
    @if (IsOwner)
    {
        <div class="form-section">
            <div class="d-flex justify-space-between align-center mb-2">
                <p class="form-section-title mb-0">Personlige Notater</p>
                <MudIconButton Icon="@Icons.Material.Rounded.Save" Size="Size.Small" Color="Color.Primary" OnClick="SaveNotes" Disabled="_isSavingNotes" />
            </div>
            <MudTextField @bind-Value="_notes" Variant="Variant.Outlined" Lines="3" Placeholder="Notater er kun synlige for deg..." Class="mb-2" />
        </div>
    }

    <div class="form-section">
        <p class="form-section-title">Vurdering</p>

        @* My Rating - Only show if user can rate *@
        @if (CanRate)
        {
            var myRatingColor = ((double)_myRating).ToRatingColorHex();
            
            <div class="d-flex align-center gap-3 mb-3">
                <MudSlider T="decimal" Value="_myRating" ValueChanged="OnRatingChanged" Min="0" Max="10" Step="0.1M" Color="Color.Primary" Style="flex: 1;" Class="rating-slider" />
                <span class="rating-badge-colored" style="--rating-color: @myRatingColor;">
                    @(_myRating > 0 ? _myRating.ToString("0.0") : "-")
                </span>
            </div>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mb-3">
                Du må lagre oppskriften for å kunne vurdere den.
            </MudAlert>
        }

        @* Collection Members' Ratings (only from friends and collection members) *@
        @{
            var otherRatings = (_recipe?.MemberRatings ?? new Dictionary<string, decimal?>())
                .Where(r => r.Value.HasValue
                    && !string.Equals(r.Key, AuthService.CurrentUserName, StringComparison.OrdinalIgnoreCase)
                    && _allowedRaterNames.Contains(r.Key)) // Only show ratings from friends/collection members
                .ToList();
        }

        @if (otherRatings.Any())
        {
            <MudDivider Class="my-3" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Andre i samlingen</MudText>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var rating in otherRatings)
                {
                    var name = rating.Key;
                    var score = rating.Value!.Value;
                    var initial = string.IsNullOrWhiteSpace(name) ? "?" : name[..1].ToUpperInvariant();

                    <div class="rating-pill" style="background-color:@score.ToRatingBgRgba(0.18);">
                        <div class="rating-circle"
                             style="background-color:@UserColorService.GetUserColor(name); color:white;">
                            @initial
                        </div>

                        <MudTooltip Text="@name" Placement="Placement.Top">
                            <span class="rating-name">@name</span>
                        </MudTooltip>

                        <span class="rating-score" style="color:@score.ToRatingColorHex()">
                            @score.ToString("0.0")
                        </span>

                    </div>
                }

            </div>
        }

        @* Public Rating Count (if published) *@
        @if (_recipe?.IsPublished == true && _recipe.RatingCount > 0)
        {
            <MudDivider Class="my-3" />
            <div class="d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Rounded.Public" Size="Size.Small" Color="Color.Info" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Offentlig vurdering: <b>@_recipe.AverageRating.ToString("0.0")</b> (@_recipe.RatingCount @(_recipe.RatingCount == 1 ? "vurdering" : "vurderinger"))
                </MudText>
            </div>
        }
    </div>
}

<style>

    .rating-badge-colored {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 3px;
        font-size: 1rem;
        padding: 8px 14px;
        min-width: 50px;
        text-align: center;
        border-radius: 12px;
        font-weight: 600;
        color: var(--rating-color);
        background: color-mix(in srgb, var(--rating-color) 15%, transparent);
    }

    /* Fix MudSlider touch issues on mobile */
    .rating-slider {
        touch-action: none;
    }

    .rating-slider .mud-slider-track {
        cursor: pointer;
    }

    .rating-slider .mud-slider-filled {
        pointer-events: none;
    }

</style>

@implements IDisposable

@code {
    [Parameter] public Guid Id { get; set; }

    private UserRecipeDto? _recipe;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private bool _isSavingNotes = false;
    private string _notes = "";
    private decimal _myRating = 0;
    private Guid _currentUserId;
    private List<CollectionDto> _recipeCollections = new();
    private HashSet<string> _allowedRaterNames = new(); // Friends + collection members

    // Debounce for rating slider
    private CancellationTokenSource? _ratingDebounceTimer;
    private const int RatingDebounceMs = 500;

    private bool IsOwner => _recipe?.UserId == _currentUserId;

    // User can rate if they own the recipe OR if the recipe is in one of their collections
    private bool CanRate => IsOwner || _recipeCollections.Any(c => CollectionState.UserCollections.Any(uc => uc.Id == c.Id));

    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = await ApiClient.GetMyProfileAsync();
            if (user != null) _currentUserId = user.Id;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user profile: {ex.Message}");
        }
        await CollectionState.InitializeAsync();
        await LoadAllowedRaters();
        await LoadRecipe();
        await LoadRecipeCollections();
    }

    /// <summary>
    /// Loads the list of allowed raters (friends + collection members).
    /// Ratings from users not in this list will be hidden.
    /// </summary>
    private async Task LoadAllowedRaters()
    {
        _allowedRaterNames.Clear();

        try
        {
            // 1. Add all friends
            var friendships = await FriendshipService.GetFriendshipsAsync();
            foreach (var friend in friendships.Friends)
            {
                if (!string.IsNullOrEmpty(friend.FriendDisplayName))
                {
                    _allowedRaterNames.Add(friend.FriendDisplayName);
                }
            }

            // 2. Add all collection members from user's collections
            foreach (var collection in CollectionState.UserCollections)
            {
                try
                {
                    var members = await ApiClient.GetCollectionMembersAsync(collection.Id);
                    foreach (var member in members)
                    {
                        if (!string.IsNullOrEmpty(member.DisplayName))
                        {
                            _allowedRaterNames.Add(member.DisplayName);
                        }
                    }
                }
                catch { /* Continue to next collection */ }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading allowed raters: {ex.Message}");
        }
    }

    private async Task LoadRecipe()
    {
        _isLoading = true;
        try
        {
            _recipe = await RecipeService.GetRecipeAsync(Id);
            if (_recipe != null)
            {
                _notes = _recipe.PersonalNotes ?? "";
                _myRating = _recipe.MyRating ?? 0m;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Kunne ikke laste oppskrift", Severity.Error);
            Console.WriteLine(ex);
        }
        finally { _isLoading = false; }
    }

    // --- NEW: PUBLISH LOGIC ---
    private async Task PublishRecipe()
    {
        if (_recipe == null) return;

        // Use the existing component PublishRecipeDialog
        var parameters = new DialogParameters<PublishRecipeDialog> { { x => x.Recipe, _recipe } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<PublishRecipeDialog>("Publiser", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadRecipe(); // Reload to update UI (IsPublished will be true)
        }
    }

    private async Task DeletePublishedRecipe()
    {
        if (_recipe == null || !_recipe.GlobalRecipeId.HasValue) return;

        var confirm = await DialogService.ShowMessageBox(
            "Slett publisert versjon?",
            "Dette fjerner oppskriften fra fellesskapet. Din lokale kopi beholdes, men koblingen brytes.",
            yesText: "Slett", cancelText: "Avbryt");

        if (confirm == true)
        {
            _isProcessing = true;
            try
            {
                // 1. Detach locally first to break link
                await RecipeService.DetachRecipeAsync(_recipe.Id);

                // 2. Delete the global version using new ApiClient method
                await ApiClient.DeleteGlobalRecipeAsync(_recipe.GlobalRecipeId.Value);

                Snackbar.Add("Publisert versjon slettet.", Severity.Success);
                await LoadRecipe();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
                await LoadRecipe();
            }
            finally { _isProcessing = false; }
        }
    }
    // --------------------------

    private async Task SaveCopyToMyCollection()
    {
        if (_recipe == null) return;
        _isProcessing = true;
        try
        {
            var copyDto = new CreateUserRecipeDto
            {
                Name = $"{_recipe.Name} (Kopi)",
                Description = _recipe.Description,
                Ingredients = _recipe.Ingredients,
                ImageUrls = _recipe.ImageUrls,
                GlobalRecipeId = _recipe.GlobalRecipeId,
                Visibility = "private"
            };
            var newRecipe = await RecipeService.CreateRecipeAsync(copyDto); // [cite: 1201]
            Snackbar.Add("Kopiert!", Severity.Success);
            Navigation.NavigateTo($"food/{newRecipe.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
        finally { _isProcessing = false; }
    }

    private async Task SaveNotes()
    {
        if (_recipe == null) return;
        _isSavingNotes = true;
        try
        {
            await RecipeService.UpdateRecipeAsync(_recipe.Id, new UpdateUserRecipeDto { PersonalNotes = _notes });
            Snackbar.Add("Notater lagret", Severity.Success);
        }
        catch { Snackbar.Add("Kunne ikke lagre notater", Severity.Error); }
        _isSavingNotes = false;
    }

    private async Task OnRatingChanged(decimal rating)
    {
        if (_recipe == null) return;
        _myRating = rating;

        // Cancel any pending save
        _ratingDebounceTimer?.Cancel();
        _ratingDebounceTimer = new CancellationTokenSource();

        try
        {
            // Wait for debounce period (user stops dragging)
            await Task.Delay(RatingDebounceMs, _ratingDebounceTimer.Token);

            // Save the rating
            await RecipeService.RateRecipeAsync(_recipe.Id, rating);
            Snackbar.Add("Vurdering lagret", Severity.Success);
        }
        catch (TaskCanceledException)
        {
            // Debounce cancelled - user still dragging, do nothing
        }
        catch
        {
            Snackbar.Add("Kunne ikke lagre vurdering", Severity.Error);
        }
    }

    public void Dispose()
    {
        _ratingDebounceTimer?.Cancel();
        _ratingDebounceTimer?.Dispose();
    }

    // --- Collection Management ---
    private async Task LoadRecipeCollections()
    {
        if (_recipe == null) return;

        _recipeCollections = new List<CollectionDto>();
        foreach (var collection in CollectionState.UserCollections)
        {
            try
            {
                var result = await ApiClient.GetCollectionRecipesAsync(collection.Id, new GetCollectionRecipesQuery { PageSize = 200 });
                if (result.Recipes.Any(r => r.Id == _recipe.Id))
                {
                    _recipeCollections.Add(collection);
                }
            }
            catch { /* Continue to next collection */ }
        }
        StateHasChanged();
    }

    private async Task RemoveFromCollection(Guid collectionId)
    {
        if (_recipe == null) return;
        try
        {
            await CollectionState.RemoveRecipeFromCollectionAsync(collectionId, _recipe.Id);
            _recipeCollections.RemoveAll(c => c.Id == collectionId);
            Snackbar.Add("Fjernet fra samling", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddToCollectionMenu()
    {
        if (_recipe == null) return;

        var availableCollections = CollectionState.UserCollections
            .Where(c => !_recipeCollections.Any(rc => rc.Id == c.Id))
            .ToList();

        if (!availableCollections.Any())
        {
            Snackbar.Add("Ingen tilgjengelige samlinger", Severity.Info);
            return;
        }

        var parameters = new DialogParameters<AddToCollectionDialog>
        {
            { x => x.AvailableCollections, availableCollections },
            { x => x.RecipeId, _recipe.Id }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };

        var dialog = await DialogService.ShowAsync<AddToCollectionDialog>("Legg til i samling", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is CollectionDto selectedCollection)
        {
            _recipeCollections.Add(selectedCollection);
            StateHasChanged();
        }
    }

    private async Task ArchiveRecipe()
    {
        if (_recipe == null || _recipe.IsArchived) return;
        var confirm = await DialogService.ShowMessageBox("Arkiver", "Er du sikker?", yesText: "Arkiver", cancelText: "Avbryt");
        if (confirm == true)
        {
            await RecipeService.ArchiveRecipeAsync(_recipe.Id);
            Navigation.NavigateTo("");
        }
    }

    private async Task EditRecipe()
    {
        if (_recipe == null) return;

        var parameters = new DialogParameters<EditRecipeDialog> { { x => x.Recipe, _recipe } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Rediger", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // Reload the recipe to get updated data
            await LoadRecipe();
        }
    }

    private string GetRatingClass(double r) => r >= 8 ? "rating-high" : r >= 5 ? "rating-medium" : "rating-low";
    private string GetVisibilityText(string v) => v switch { "private" => "Privat (Kun deg)", "household" => "Privat", "public" => "Offentlig", _ => v };
    private string GetVisibilityIcon(string v) => v switch { "public" => Icons.Material.Rounded.Public, _ => Icons.Material.Rounded.Lock };

    // Difficulty helpers
    private string GetDifficultyIcon(string? difficulty)
    {
        return difficulty?.ToLower() switch
        {
            "easy" or "lett" => Icons.Material.Rounded.SentimentSatisfied,
            "medium" or "middels" => Icons.Material.Rounded.Psychology,
            "hard" or "vanskelig" => Icons.Material.Rounded.LocalFireDepartment,
            _ => Icons.Material.Rounded.HelpOutline
        };
    }

    private string GetDifficultyLabel(string? difficulty)
    {
        return difficulty?.ToLower() switch
        {
            "easy" => "Lett",
            "medium" => "Middels",
            "hard" => "Vanskelig",
            _ => difficulty ?? ""
        };
    }

    // Nutrition and Ingredients parsing
    private record NutritionInfo(string Name, string Amount);
    private record IngredientInfo(string Name, string? Amount, string? Unit, string? Image);

    private bool HasNutritionData => _recipe?.NutritionData != null;
    private bool HasIngredients =>
    _recipe?.Ingredients is JsonElement je &&
    je.ValueKind == JsonValueKind.Array &&
    je.GetArrayLength() > 0;


    private List<NutritionInfo> ParseNutrition()
    {
        var items = new List<NutritionInfo>();
        if (_recipe?.NutritionData == null) return items;

        try
        {
            if (_recipe.NutritionData is JsonElement jsonElement && jsonElement.ValueKind == JsonValueKind.Object)
            {
                foreach (var prop in jsonElement.EnumerateObject())
                {
                    var amount = prop.Value.ToString();
                    var name = GetNutritionDisplayName(prop.Name);
                    items.Add(new NutritionInfo(name, amount));
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing nutrition data: {ex.Message}");
        }
        return items;
    }

    private string GetNutritionDisplayName(string key)
    {
        return key.ToLower() switch
        {
            "kalorier" => "kcal",
            "energi (kj)" => "kJ",
            "fett" => "Fett",
            "mettet fett" => "M. fett",
            "karbohydrater" => "Karb.",
            "sukker" => "Sukker",
            "protein" => "Protein",
            "natrium" => "Natrium",
            _ => key.Length > 8 ? key.Substring(0, 6) + ".." : key
        };
    }

    private List<IngredientInfo> ParseIngredients()
    {
        var items = new List<IngredientInfo>();
        if (_recipe?.Ingredients == null) return items;

        try
        {
            if (_recipe.Ingredients is JsonElement jsonElement && jsonElement.ValueKind == JsonValueKind.Array)
            {
                foreach (var item in jsonElement.EnumerateArray())
                {
                    var name = item.TryGetProperty("name", out var n) ? n.GetString() : "";
                    var amount = item.TryGetProperty("amount", out var a) ? a.ToString() : null;
                    var unit = item.TryGetProperty("unit", out var u) ? u.GetString() : null;
                    var image = item.TryGetProperty("image", out var i) ? i.GetString() : null;

                    if (!string.IsNullOrEmpty(name))
                    {
                        items.Add(new IngredientInfo(name!, amount, unit, image));
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing ingredients: {ex.Message}");
        }
        return items;
    }

    private string GetIngredientImageUrl(string? imagePath)
    {
        if (string.IsNullOrEmpty(imagePath)) return "";
        if (imagePath.StartsWith("http")) return imagePath;
        return $"https://d3hvwccx09j84u.cloudfront.net/0,0{imagePath}";
    }
}
