@page "/collections/shared/{ShareCode}"
@using Microsoft.AspNetCore.Authorization
@using System.Web
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_collection == null)
{
    <div class="empty-state pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" Color="Color.Default" />
        <MudText Typo="Typo.h6" Class="mt-3">Fant ikke samlingen</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Samlingen finnes ikke, eller du har ikke tilgang til den.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="friends">
            Tilbake til venner
        </MudButton>
    </div>
}
else
{
    <div class="collection-header mb-4">
        <div class="d-flex align-center gap-3 mb-2">
            <div class="collection-icon-large">
                <MudIcon Icon="@GetVisibilityIcon(_collection.Visibility)" Size="Size.Large" />
            </div>

            <div class="flex-grow-1">
                <h1 class="page-title" style="margin: 0;">@_collection.Name</h1>

                @if (!string.IsNullOrEmpty(_collection.Description))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_collection.Description</MudText>
                }

                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    <MudIcon Icon="@Icons.Material.Rounded.Person" Size="Size.Small" Style="font-size: 14px; vertical-align: middle;" />
                    Delt av @_collection.OwnerDisplayName
                </MudText>
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-3">
            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Rounded.Restaurant">
                @_collection.RecipeCount oppskrifter
            </MudChip>
            <MudChip T="string" Size="Size.Small" Color="@GetVisibilityColor(_collection.Visibility)" Icon="@GetVisibilityIcon(_collection.Visibility)">
                @GetVisibilityText(_collection.Visibility)
            </MudChip>
        </div>
    </div>

    <CollectionRecipesList CollectionId="_collection.Id" Title="Oppskrifter" PageSize="30" />
}

<style>
    .collection-header {
        background: var(--mud-palette-surface);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid var(--mud-palette-lines-default);
    }

    .collection-icon-large {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: var(--mud-palette-info);
        color: var(--mud-palette-info-text);
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

@code {
    [Parameter] public string ShareCode { get; set; } = "";

    private CollectionDto? _collection;
    private bool _isLoading = true;
    private string _returnUrl = "friends";

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);

        _returnUrl = query["returnUrl"] ?? "friends";

        await LoadCollection();
    }

    private async Task LoadCollection()
    {
        _isLoading = true;
        try
        {
            _collection = await ApiClient.GetCollectionByShareCodeAsync(ShareCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading collection: {ex.Message}");
            Snackbar.Add("Kunne ikke laste samlingen", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo(_returnUrl);

    private string GetVisibilityIcon(string visibility) => visibility switch
    {
        "public" => Icons.Material.Rounded.Public,
        "friends" => Icons.Material.Rounded.People,
        _ => Icons.Material.Rounded.Lock
    };

    private string GetVisibilityText(string visibility) => visibility switch
    {
        "public" => "Offentlig",
        "friends" => "Venner",
        _ => "Privat"
    };

    private Color GetVisibilityColor(string visibility) => visibility switch
    {
        "public" => Color.Success,
        "friends" => Color.Info,
        _ => Color.Default
    };
}
