@page "/cookbook"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Components
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.Extensions
@using StorhaugenWebsite.Models
@inject IUserRecipeService RecipeService
@inject ICollectionStateService CollectionState
@inject IUserFriendshipService FriendshipService
@inject IAuthService AuthService
@inject IUserColorService UserColorService
@inject IDeviceStateService DeviceState
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@attribute [Authorize]
@implements IDisposable

<div class="cookbook-header d-flex flex-column gap-3 mb-4">

    @* Collection Selection *@
    @if (CollectionState.UserCollections.Any() || _hasUncategorizedRecipes)
    {
        <div class="group-filter-section">
            <div class="horizontal-scroll-container">

                @* Personal pseudo-collection - only show if user has uncategorized recipes *@
                @if (_hasUncategorizedRecipes)
                {
                    <div class="group-chip @(_personalActive ? "active" : "")" @onclick="TogglePersonal">
                        @if (_personalActive)
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                        }
                        <span>Personlig</span>
                    </div>
                }

                @foreach (var collection in CollectionState.UserCollections)
                {
                    var isActive = CollectionState.IsCollectionActive(collection.Id);
                    <div class="group-chip @(isActive ? "active" : "")" @onclick="@(() => ToggleCollection(collection.Id))">
                        @if (isActive)
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                        }
                        <span>@collection.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    @* Search & Sort *@
    <div class="d-flex gap-2">
        <MudTextField @bind-Value="_searchQuery"
                      Placeholder="Søk..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Rounded.Search"
                      Immediate="true"
                      DebounceInterval="300"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Class="flex-grow-1 search-field"
                      Margin="Margin.Dense" />

        <MudSelect T="string"
                   @bind-Value="_sortBy"
                   AnchorOrigin="Origin.BottomRight"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Class="sort-select"
                   Style="width: 170px;"
                   AdornmentIcon="@Icons.Material.Rounded.Sort">
            <MudSelectItem Value="@("date")">Nyeste</MudSelectItem>
            <MudSelectItem Value="@("rating")">Høyest snitt</MudSelectItem>
            <MudSelectItem Value="@("personal_rating")">Min vurdering</MudSelectItem>
            <MudSelectItem Value="@("name")">Navn (A-Å)</MudSelectItem>
            @if (_sortableMembers.Any())
            {
                <MudDivider Class="my-1" />
                @foreach (var member in _sortableMembers)
                {
                    <MudSelectItem Value="@($"user_rating_{member.DisplayName}")">
                        <div class="d-flex align-center gap-2">
                            <div class="user-sort-avatar" style="background-color: @UserColorService.GetUserColor(member.DisplayName);">
                                @(string.IsNullOrEmpty(member.DisplayName) ? "?" : member.DisplayName[..1].ToUpper())
                            </div>
                            <span>@member.DisplayName</span>
                        </div>
                    </MudSelectItem>
                }
            }
        </MudSelect>
    </div>

    @* Tags *@
    @if (_tags.Any())
    {
        <div class="tag-filter-section mt-1">
            <div class="horizontal-scroll-container">
                @foreach (var tag in _tags)
                {
                    <MudChip T="string"
                             Variant="@(_activeTagIds.Contains(tag.Id) ? Variant.Filled : Variant.Outlined)"
                             Color="Color.Tertiary"
                             OnClick="@(() => ToggleTagFilter(tag.Id))"
                             Size="Size.Small"
                             Style="@(tag.Color != null ? $"--mud-palette-tertiary: {tag.Color};" : "")">
                        @tag.Name
                    </MudChip>
                }
            </div>
        </div>
    }
</div>

@* XFade wrapper (same behavior as Home/ActivityFeed: first-load-only crossfade) *@
<XFade IsLoading="@_isLoading" FirstLoadOnly="true" FadeMs="220">
    <Skeleton>
        <RecipeSkeleton Amount="6" Height="107.11px" />
    </Skeleton>

    <ChildContent>
        @if (!_recipes.Any())
        {
            <div class="empty-state pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Rounded.MenuBook" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Class="mt-3">Ingen oppskrifter funnet</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="add">Legg til ny oppskrift</MudButton>
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-3">
                @foreach (var recipe in _sortedRecipes)
                {
                    var imgUrl = recipe.ImageUrls?.FirstOrDefault(u => !string.IsNullOrWhiteSpace(u));

                    <div class="food-card" @key="recipe.Id" @onclick="() => OpenRecipe(recipe.Id)">
                        @* Image Section (Right Side) *@
                        @if (!string.IsNullOrEmpty(imgUrl))
                        {
                            <img src="@imgUrl" class="food-card-image" loading="lazy" />
                        }
                        else
                        {
                            <div class="food-card-placeholder">
                            </div>
                        }

                        @* Content Section (Left Side) *@
                        <div class="food-card-content">

                            @* Top Row *@
                            <div class="d-flex justify-space-between align-start">
                                <div style="min-width: 0; padding-right: 8px;">
                                    <div class="d-flex align-center gap-1 mb-1">
                                        @if (recipe.IsHellofresh)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.LocalDining" Size="Size.Small" Color="Color.Success" Title="HelloFresh" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        @if (recipe.IsPublished)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.Cloud" Size="Size.Small" Color="Color.Info" Title="Publisert" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        @if (recipe.IsLinkedToGlobal && !recipe.IsHellofresh)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.Link" Size="Size.Small" Color="Color.Secondary" Title="Koblet" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        <h3 class="food-card-title text-truncate">@recipe.Name</h3>
                                    </div>

                                    <div style="display:flex; gap:4px">

                                        @if (recipe.PrepTimeMinutes.HasValue || !string.IsNullOrEmpty(recipe.Difficulty))
                                        {
                                            <div class="d-flex align-center flex-wrap gap-1">
                                                @if (!string.IsNullOrEmpty(recipe.Difficulty))
                                                {
                                                    <span class="meta-chip @GetDifficultyClass(recipe.Difficulty)">
                                                        <MudIcon Icon="@GetDifficultyIcon(recipe.Difficulty)" Size="Size.Small" />
                                                        @GetDifficultyLabel(recipe.Difficulty)
                                                    </span>
                                                }
                                                @if (recipe.PrepTimeMinutes.HasValue)
                                                {
                                                    <span class="meta-chip">
                                                        <MudIcon Icon="@Icons.Material.Rounded.AccessTime" Size="Size.Small" />
                                                        @recipe.PrepTimeMinutes min
                                                    </span>
                                                }
                                            </div>
                                        }

                                        <div class="d-flex align-center gap-1">
                                            <MudIcon Icon="@Icons.Material.Rounded.Person" Size="Size.Small" Color="Color.Default" />
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate" Style="font-size:0.7rem;">
                                                @(recipe.UserDisplayName == AuthService.CurrentUserName ? "Meg" : recipe.UserDisplayName)
                                            </MudText>
                                        </div>
                                    </div>
                                </div>

                                @* Right: Average Badge *@
                                @if (recipe.AverageRating > 0)
                                {
                                    <div class="d-flex flex-column align-end" style="flex-shrink:0;">
                                        <span class="rating-badge" style="color:@recipe.AverageRating.ToRatingColorHex();">
                                            <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" Style="font-size:14px; margin-right:2px;" />
                                            @recipe.AverageRating.ToString("0.0")
                                        </span>

                                        @if (recipe.RatingCount > 0)
                                        {
                                            <span class="rating-count-badge">
                                                <MudIcon Icon="@Icons.Material.Rounded.People" Size="Size.Small" Style="font-size:10px;" />
                                                @recipe.RatingCount
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            @* Ratings Section *@
                            <div class="ratings-wrap mt-2">
                                @* Track whether we rendered any pill *@
                                @{
                                    var renderedAny = false;
                                }

                                @* Me (from MyRating) *@
                                @if (recipe.MyRating is decimal myScore)
                                {
                                    renderedAny = true;
                                    var me = AuthService.CurrentUserName ?? "Meg";

                                    <div class="rating-pill" style="background-color:@myScore.ToRatingBgRgba(0.14);">
                                        <div class="rating-circle"
                                             style="background-color:@UserColorService.GetUserColor(me); color:white;">
                                            @(string.IsNullOrWhiteSpace(me) ? "?" : me[..1].ToUpper())
                                        </div>
                                        <span class="rating-score" style="color:@myScore.ToRatingColorHex()">
                                            @myScore.ToString("0.0")
                                        </span>
                                    </div>
                                }

                                @* Others (from MemberRatings) *@
                                @foreach (var r in (recipe.MemberRatings ?? new Dictionary<string, decimal?>())
                                                        .Where(x => x.Value.HasValue)
                                                        .Where(x => _allowedRaterNames.Contains(x.Key)))
                                {
                                    renderedAny = true;
                                    var name = r.Key;
                                    var score = r.Value!.Value;

                                    <div class="rating-pill" style="background-color:@score.ToRatingBgRgba(0.14);">
                                        <div class="rating-circle"
                                             style="background-color:@UserColorService.GetUserColor(name); color:white;">
                                            @(string.IsNullOrWhiteSpace(name) ? "?" : name[..1].ToUpper())
                                        </div>
                                        <span class="rating-score" style="color:@score.ToRatingColorHex()">
                                            @score.ToString("0.0")
                                        </span>
                                    </div>
                                }

                                @* Placeholder (keeps card height consistent) *@
                                @if (!renderedAny)
                                {
                                    <div class="rating-pill rating-pill-placeholder">
                                        <div class="rating-circle rating-circle-placeholder">?</div>
                                        <span class="rating-score rating-score-placeholder">—</span>
                                    </div>
                                }

                            </div>


                        </div>
                    </div>
                }
            </div>
        }
    </ChildContent>
</XFade>

<style>
    .ratings-fade {
        position: relative;
        min-width: 0;
    }

    .ratings-scroll {
        overflow-x: auto;
        overflow-y: hidden;
        display: flex;
        flex-wrap: nowrap;
        min-width: 0;
        --fade: 18px;
        -webkit-mask-image: linear-gradient(to right, #000 0, #000 calc(100% - var(--fade)), transparent 100%);
        mask-image: linear-gradient(to right, #000 0, #000 calc(100% - var(--fade)), transparent 100%);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
    }

        .ratings-scroll::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* make sure each pill keeps its size */
        .ratings-scroll .rating-pill {
            flex: 0 0 auto;
        }

    .rating-pill-placeholder {
        background-color: rgba(255, 255, 255, 0.06);
    }

    .rating-circle-placeholder {
        background-color: rgba(255, 255, 255, 0.10);
        color: rgba(255, 255, 255, 0.45);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        /* don't set width/height here if your .rating-circle already does */
    }

    .rating-score-placeholder {
        color: rgba(255, 255, 255, 0.45);
    }

    .user-sort-avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
    }

</style>

@code {
    private const int PersonalPageSize = 100;
    private const int CollectionPageSize = 100;
    private const int CollectionScanPageSize = 200;

    private List<UserRecipeDto> _recipes = new();
    private IEnumerable<UserRecipeDto> _sortedRecipes => GetSortedRecipes();

    private bool _isLoading = true;

    private int _loadVersion;

    private string _searchQuery = "";
    private string _sortBy = "date";
    private List<TagDto> _tags = new();
    private readonly List<Guid> _activeTagIds = new();
    private bool _personalActive = false;
    private readonly HashSet<string> _allowedRaterNames = new();

    // For user-based sorting
    private List<CollectionMemberDto> _sortableMembers = new();
    private bool _hasUncategorizedRecipes = false;

    protected override async Task OnInitializedAsync()
    {
        CollectionState.OnActiveFiltersChanged += OnFiltersChanged;

        await CollectionState.InitializeAsync();
        await DeviceState.InitializeAsync();

        // Restore saved filter state from device settings
        _personalActive = DeviceState.Settings.CookbookPersonalFilterActive;
        foreach (var collectionId in DeviceState.Settings.CookbookCollectionFilters)
        {
            // Only activate if user still has access to this collection
            if (CollectionState.UserCollections.Any(c => c.Id == collectionId))
            {
                CollectionState.SetCollectionFilter(collectionId, true);
            }
        }

        await LoadAllowedRaters();
        await LoadTags();
        await UpdateSortableMembers();
        await CheckForUncategorizedRecipes();

        await LoadRecipes();
    }

    private async Task TogglePersonal()
    {
        _personalActive = !_personalActive;
        await SaveFiltersToDevice();
        await LoadRecipes();
    }

    private void ToggleCollection(Guid collectionId)
    {
        CollectionState.ToggleCollectionFilter(collectionId);
        _ = SaveFiltersToDevice();
    }

    private async Task SaveFiltersToDevice()
    {
        var activeCollections = CollectionState.ActiveCollectionFilters.ToList();
        await DeviceState.SetCookbookFiltersAsync(activeCollections, _personalActive);
    }

    private void OnFiltersChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await UpdateSortableMembers();
            // Reset to default sort if current sort is by a user not in the new filter
            if (_sortBy.StartsWith("user_rating_") && !_sortableMembers.Any(m => _sortBy == $"user_rating_{m.DisplayName}"))
            {
                _sortBy = "date";
            }
            await LoadRecipes();
        });
    }

    private Task OnSearchChanged(string value) => LoadRecipes();

    private void OpenRecipe(Guid id) => Navigation.NavigateTo($"food/{id}");

    private string GetScoreColor(double score)
    {
        if (score >= 8) return "#4CAF50";
        if (score >= 6) return "#FFC107";
        return "#F44336";
    }

    private async Task LoadTags()
    {
        try
        {
            _tags = await ApiClient.GetMyTagsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
        }
    }

    private async Task ToggleTagFilter(Guid tagId)
    {
        if (_activeTagIds.Contains(tagId)) _activeTagIds.Remove(tagId);
        else _activeTagIds.Add(tagId);

        await LoadRecipes();
    }

    private async Task LoadAllowedRaters()
    {
        _allowedRaterNames.Clear();

        try
        {
            var friendships = await FriendshipService.GetFriendshipsAsync();
            foreach (var friend in friendships.Friends)
            {
                if (!string.IsNullOrEmpty(friend.FriendDisplayName))
                    _allowedRaterNames.Add(friend.FriendDisplayName);
            }

            foreach (var collection in CollectionState.UserCollections)
            {
                try
                {
                    var members = await ApiClient.GetCollectionMembersAsync(collection.Id);
                    foreach (var member in members)
                    {
                        if (!string.IsNullOrEmpty(member.DisplayName))
                            _allowedRaterNames.Add(member.DisplayName);
                    }
                }
                catch { /* ignore per collection */ }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading allowed raters: {ex.Message}");
        }
    }

    private async Task UpdateSortableMembers()
    {
        var uniqueMembers = new Dictionary<Guid, CollectionMemberDto>();

        // Get members from active collection filters
        var collectionsToCheck = CollectionState.ActiveCollectionFilters.Any()
            ? CollectionState.ActiveCollectionFilters
            : CollectionState.UserCollections.Select(c => c.Id).ToList();

        // Only include members if we have active collection filters or personal is active
        if (!CollectionState.ActiveCollectionFilters.Any() && !_personalActive)
        {
            _sortableMembers = new List<CollectionMemberDto>();
            return;
        }

        foreach (var collectionId in collectionsToCheck)
        {
            // Only include if collection is in the active filters (or if no filters are active)
            if (CollectionState.ActiveCollectionFilters.Any() && !CollectionState.ActiveCollectionFilters.Contains(collectionId))
                continue;

            try
            {
                var members = await ApiClient.GetCollectionMembersAsync(collectionId);
                foreach (var member in members)
                {
                    if (!uniqueMembers.ContainsKey(member.UserId))
                        uniqueMembers[member.UserId] = member;
                }
            }
            catch { /* ignore per collection */ }
        }

        // Add current user if personal is active
        if (_personalActive && CollectionState.CurrentProfile != null)
        {
            var currentUserId = CollectionState.CurrentProfile.Id;
            if (!uniqueMembers.ContainsKey(currentUserId))
            {
                uniqueMembers[currentUserId] = new CollectionMemberDto
                {
                    UserId = currentUserId,
                    DisplayName = AuthService.CurrentUserName ?? "Meg"
                };
            }
        }

        _sortableMembers = uniqueMembers.Values.OrderBy(m => m.DisplayName).ToList();
    }

    private async Task CheckForUncategorizedRecipes()
    {
        try
        {
            // Get all recipe IDs that are in collections
            var idsInCollections = await GetAllRecipeIdsInCollectionsAsync();

            // Get user's personal recipes
            var personalResult = await RecipeService.GetMyRecipesAsync(new GetUserRecipesQuery { PageSize = 1 });

            if (personalResult.TotalCount == 0)
            {
                _hasUncategorizedRecipes = false;
                return;
            }

            // Check if any personal recipe is not in a collection
            var allPersonal = await RecipeService.GetMyRecipesAsync(new GetUserRecipesQuery { PageSize = 200 });
            _hasUncategorizedRecipes = allPersonal.Recipes.Any(r => !idsInCollections.Contains(r.Id));
        }
        catch
        {
            _hasUncategorizedRecipes = true; // Default to showing the filter
        }
    }

    private IEnumerable<UserRecipeDto> GetSortedRecipes()
    {
        // Handle user-specific rating sorting
        if (_sortBy.StartsWith("user_rating_"))
        {
            var userName = _sortBy.Substring("user_rating_".Length);
            return _recipes.OrderByDescending(r =>
                r.MemberRatings.TryGetValue(userName, out var rating) ? rating ?? 0 : 0);
        }

        return _sortBy switch
        {
            "name" => _recipes.OrderBy(r => r.Name),
            "rating" => _recipes.OrderByDescending(r => r.AverageRating),
            "personal_rating" => _recipes.OrderByDescending(r => r.MyRating ?? 0),
            _ => _recipes.OrderByDescending(r => r.CreatedAt)
        };
    }

    private async Task LoadRecipes()
    {
        var requestVersion = ++_loadVersion;

        SetLoading(true);

        try
        {
            var hasSelectedCollections = HasSelectedCollections();
            var shouldLoadPersonal = ShouldLoadPersonal(hasSelectedCollections);
            var showOnlyUncategorized = ShowOnlyUncategorized(hasSelectedCollections);

            var combined = await LoadCombinedRecipesAsync(
                hasSelectedCollections,
                shouldLoadPersonal,
                showOnlyUncategorized);

            var deduped = Deduplicate(combined);

            if (_activeTagIds.Any())
                deduped = FilterByTags(deduped);

            if (requestVersion != _loadVersion) return;

            _recipes = deduped.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            if (requestVersion == _loadVersion)
                SetLoading(false);
        }
    }

    private void SetLoading(bool isLoading)
    {
        _isLoading = isLoading;
        _ = InvokeAsync(StateHasChanged);
    }

    private bool HasSelectedCollections() =>
        CollectionState.HasCollections && CollectionState.ActiveCollectionFilters.Any();

    private bool ShouldLoadPersonal(bool hasSelectedCollections) =>
        !hasSelectedCollections || _personalActive;

    private bool ShowOnlyUncategorized(bool hasSelectedCollections) =>
        _personalActive && !hasSelectedCollections;

    private async Task<List<UserRecipeDto>> LoadCombinedRecipesAsync(
        bool hasSelectedCollections,
        bool shouldLoadPersonal,
        bool showOnlyUncategorized)
    {
        var combined = new List<UserRecipeDto>();

        // IMPORTANT:
        // If you want the richer "personal" DTO to win over the "collection" DTO,
        // load personal first, then collections. (See note below.)
        if (shouldLoadPersonal)
            combined.AddRange(await LoadPersonalRecipesAsync(showOnlyUncategorized));

        if (hasSelectedCollections)
            combined.AddRange(await LoadSelectedCollectionRecipesAsync());

        return combined;
    }

    private IEnumerable<UserRecipeDto> Deduplicate(List<UserRecipeDto> recipes) =>
        recipes.DistinctBy(r => r.Id);

    private IEnumerable<UserRecipeDto> FilterByTags(IEnumerable<UserRecipeDto> recipes) =>
        recipes.Where(r => r.Tags.Any(t => _activeTagIds.Contains(t.Id)));


    private async Task<List<UserRecipeDto>> LoadSelectedCollectionRecipesAsync()
    {
        var list = new List<UserRecipeDto>();

        foreach (var collectionId in CollectionState.ActiveCollectionFilters)
        {
            try
            {
                var query = new GetCollectionRecipesQuery { Search = _searchQuery, PageSize = CollectionPageSize };
                var res = await ApiClient.GetCollectionRecipesAsync(collectionId, query);
                list.AddRange(res.Recipes);
            }
            catch { /* ignore per collection */ }
        }

        return list;
    }

    private async Task<List<UserRecipeDto>> LoadPersonalRecipesAsync(bool showOnlyUncategorized)
    {
        var userQuery = new GetUserRecipesQuery
        {
            Search = _searchQuery,
            PageSize = PersonalPageSize,
            TagIds = _activeTagIds.Any() ? _activeTagIds : null
        };

        var personalResult = await RecipeService.GetMyRecipesAsync(userQuery);

        if (!showOnlyUncategorized)
            return personalResult.Recipes.ToList();

        var inAnyCollection = await GetAllRecipeIdsInCollectionsAsync();
        return personalResult.Recipes.Where(r => !inAnyCollection.Contains(r.Id)).ToList();
    }

    private async Task<HashSet<Guid>> GetAllRecipeIdsInCollectionsAsync()
    {
        var ids = new HashSet<Guid>();

        foreach (var collection in CollectionState.UserCollections)
        {
            try
            {
                var res = await ApiClient.GetCollectionRecipesAsync(
                    collection.Id,
                    new GetCollectionRecipesQuery { PageSize = CollectionScanPageSize });

                foreach (var r in res.Recipes)
                    ids.Add(r.Id);
            }
            catch { /* ignore */ }
        }

        return ids;
    }

    private string GetDifficultyIcon(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" or "lett" => Icons.Material.Rounded.SentimentSatisfied,
        "medium" or "middels" => Icons.Material.Rounded.Psychology,
        "hard" or "vanskelig" => Icons.Material.Rounded.LocalFireDepartment,
        _ => Icons.Material.Rounded.HelpOutline
    };

    private string GetDifficultyLabel(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" => "Lett",
        "medium" => "Middels",
        "hard" => "Vanskelig",
        _ => difficulty ?? ""
    };

    private string GetDifficultyClass(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" or "lett" => "difficulty-easy",
        "medium" or "middels" => "difficulty-medium",
        "hard" or "vanskelig" => "difficulty-hard",
        _ => ""
    };

    public void Dispose()
    {
        CollectionState.OnActiveFiltersChanged -= OnFiltersChanged;
    }
}
