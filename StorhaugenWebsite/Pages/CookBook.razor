@page "/cookbook"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Models
@inject IUserRecipeService RecipeService
@inject ICollectionStateService CollectionState
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@attribute [Authorize]
@implements IDisposable

<div class="cookbook-header d-flex flex-column gap-3 mb-4">

    @* Collection Selection *@
    @if (CollectionState.UserCollections.Any())
    {
        <div class="group-filter-section">
            <div class="horizontal-scroll-container">

                @* Personal pseudo-collection *@
                <div class="group-chip @(_personalActive ? "active" : "")"
                     @onclick="TogglePersonal">
                    @if (_personalActive)
                    {
                        <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                    }
                    <span>Personlig</span>
                </div>

                @foreach (var collection in CollectionState.UserCollections)
                {
                    var isActive = CollectionState.IsCollectionActive(collection.Id);
                    <div class="group-chip @(isActive ? "active" : "")" @onclick="@(() => ToggleCollection(collection.Id))">
                        @if (isActive)
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                        }
                        <span>@collection.Name</span>
                    </div>
                }
            </div>
        </div>
    }


    @* Search & Sort *@
    <div class="d-flex gap-2">
        <MudTextField @bind-Value="_searchQuery"
                      Placeholder="Søk..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Rounded.Search"
                      Immediate="true"
                      DebounceInterval="300"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Class="flex-grow-1 search-field"
                      Margin="Margin.Dense" />

        <MudSelect T="string"
                   @bind-Value="_sortBy"
                   AnchorOrigin="Origin.BottomRight"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Class="sort-select"
                   Style="width: 140px;"
                   AdornmentIcon="@Icons.Material.Rounded.Sort">
            <MudSelectItem Value="@("date")">Nyeste</MudSelectItem>
            <MudSelectItem Value="@("rating")">Høyest snitt</MudSelectItem>
            <MudSelectItem Value="@("personal_rating")">Min vurdering</MudSelectItem>
            <MudSelectItem Value="@("name")">Navn (A-Å)</MudSelectItem>
        </MudSelect>
    </div>

    @* Tags *@
    @if (_tags.Any())
    {
        <div class="tag-filter-section mt-1">
            <div class="horizontal-scroll-container">
                @foreach (var tag in _tags)
                {
                    <MudChip T="string"
                             Variant="@(_activeTagIds.Contains(tag.Id) ? Variant.Filled : Variant.Outlined)"
                             Color="Color.Tertiary"
                             OnClick="@(() => ToggleTagFilter(tag.Id))"
                             Size="Size.Small"
                             Style="@(tag.Color != null ? $"--mud-palette-tertiary: {tag.Color};" : "")">
                        @tag.Name
                    </MudChip>
                }
            </div>
        </div>
    }
</div>

@if (_isLoading)
{
    <div class="d-flex flex-column gap-3">
        @for (int i = 0; i < 4; i++)
        {
            <div class="skeleton-card">
                <div class="skeleton-content d-flex align-center">
                    <div style="width:100%">
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="14px" Width="60%" Class="mb-2 rounded" />
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="10px" Width="40%" Class="rounded" />
                    </div>
                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="40px" Height="40px" Class="ml-3" />
                </div>
            </div>
        }
    </div>
}
else if (!_recipes.Any())
{
    <div class="empty-state pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Rounded.MenuBook" Size="Size.Large" Color="Color.Default" />
        <MudText Typo="Typo.h6" Class="mt-3">Ingen oppskrifter funnet</MudText>
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="add">Legg til ny oppskrift</MudButton>
    </div>
}
else
{
    <div class="d-flex flex-column gap-3">
        @foreach (var recipe in _sortedRecipes)
        {
            <div class="food-card animate-in" @onclick="() => OpenRecipe(recipe.Id)">

                @* Image Section (Right Side) *@
                @if (recipe.ImageUrls.Any())
                {
                    <img src="@recipe.ImageUrls.First()" class="food-card-image" />
                }
                else
                {
                    <div class="food-card-placeholder">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" Style="opacity:0.3;" />
                    </div>
                }

                @* Content Section (Left Side) *@
                <div class="food-card-content">

                    @* Top Row: Title, Owner & Average Badge *@
                    <div class="d-flex justify-space-between align-start">
                        @* Left: Title & Owner *@
                        <div style="min-width: 0; padding-right: 8px;">
                            <h3 class="food-card-title text-truncate">@recipe.Name</h3>
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Rounded.Person" Size="Size.Small" Style="font-size: 12px; opacity: 0.6;" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate" Style="font-size: 0.75rem;">
                                    @(recipe.UserDisplayName == AuthService.CurrentUserName ? "Meg" : recipe.UserDisplayName)
                                </MudText>
                            </div>
                        </div>

                        @* Right: Average Badge *@
                        @if (recipe.AverageRating > 0)
                        {
                            <span class="rating-badge" style="color: @GetScoreColor(recipe.AverageRating); flex-shrink: 0;">
                                <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" Style="font-size: 14px; margin-right:2px;" />
                                @recipe.AverageRating.ToString("0.0")
                            </span>
                        }
                    </div>

                    @* Ratings Section (Bottom) *@
                    <div class="d-flex align-center flex-wrap mt-3 gap-2">

                        @* 1. My Rating (Primary Color) *@
                        @if (recipe.MyRating.HasValue)
                        {
                            <div class="rating-pill mine">
                                <div class="rating-circle" style="background-color: var(--mud-palette-primary); color: var(--mud-palette-primary-text);">
                                    D
                                </div>
                                <span class="rating-score">@recipe.MyRating</span>
                            </div>
                        }

                        @* 2. Other Member Ratings *@
                        @{
                            var otherRatings = (recipe.MemberRatings ?? new Dictionary<string, int?>())
                                .Where(r => r.Value.HasValue && !string.Equals(r.Key, AuthService.CurrentUserName, StringComparison.OrdinalIgnoreCase))
                                .DistinctBy(r => r.Key)
                                .Take(4);
                        }

                        @foreach (var rating in otherRatings)
                        {
                            var initial = !string.IsNullOrEmpty(rating.Key) ? rating.Key.Substring(0, 1).ToUpper() : "?";
                            var color = GetUserColor(rating.Key);

                            <div class="rating-pill">
                                <div class="rating-circle" style="background-color: @color; color: white;">
                                    @initial
                                </div>
                                <span class="rating-score">@rating.Value</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<UserRecipeDto> _recipes = new();
    private IEnumerable<UserRecipeDto> _sortedRecipes => GetSortedRecipes();
    private bool _isLoading = true;
    private string _searchQuery = "";
    private string _sortBy = "date";
    private List<TagDto> _tags = new();
    private List<Guid> _activeTagIds = new();
    private bool _personalActive = false;

    private async Task TogglePersonal()
    {
        _personalActive = !_personalActive;
        await LoadRecipes();
    }


    // Generates a stable color based on the username string
    private string GetUserColor(string username)
    {
        if (string.IsNullOrEmpty(username)) return "#9E9E9E";
        int hash = Math.Abs(username.GetHashCode());
        string[] palette = {
            "#2E7D32", "#00695C", "#0277BD", "#1565C0", "#283593",
            "#4527A0", "#6A1B9A", "#AD1457", "#C62828", "#D84315"
        };
        return palette[hash % palette.Length];
    }

    // Returns Green/Yellow/Red for the average score star
    private string GetScoreColor(double score)
    {
        if (score >= 8) return "#4CAF50"; // Green
        if (score >= 6) return "#FFC107"; // Yellow
        return "#F44336"; // Red
    }

    protected override async Task OnInitializedAsync()
    {
        CollectionState.OnActiveFiltersChanged += OnFiltersChanged;
        await CollectionState.InitializeAsync();
        await LoadTags();
        await LoadRecipes();
    }

    private IEnumerable<UserRecipeDto> GetSortedRecipes()
    {
        return _sortBy switch
        {
            "name" => _recipes.OrderBy(r => r.Name),
            "rating" => _recipes.OrderByDescending(r => r.AverageRating),
            "personal_rating" => _recipes.OrderByDescending(r => r.MyRating ?? 0),
            _ => _recipes.OrderByDescending(r => r.CreatedAt)
        };
    }

    private async Task LoadTags()
    {
        try
        {
            _tags = await ApiClient.GetMyTagsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
        }
    }

    private async Task ToggleTagFilter(Guid tagId)
    {
        if (_activeTagIds.Contains(tagId)) _activeTagIds.Remove(tagId);
        else _activeTagIds.Add(tagId);
        await LoadRecipes();
    }

    private async void OnFiltersChanged() { await InvokeAsync(async () => { await LoadRecipes(); StateHasChanged(); }); }
    private void ToggleCollection(Guid collectionId) { CollectionState.ToggleCollectionFilter(collectionId); }

    private async Task LoadRecipes()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var combined = new List<UserRecipeDto>();
            var hasSelectedCollections = CollectionState.HasCollections && CollectionState.ActiveCollectionFilters.Any();

            // Show personal recipes when:
            // 1. Personal chip is active, OR
            // 2. No collection filters are selected (default behavior)
            var shouldLoadPersonal = _personalActive || !hasSelectedCollections;

            // 1) Load selected collection recipes
            if (hasSelectedCollections)
            {
                foreach (var collectionId in CollectionState.ActiveCollectionFilters)
                {
                    try
                    {
                        var query = new GetCollectionRecipesQuery { Search = _searchQuery, PageSize = 50 };
                        var collectionResult = await ApiClient.GetCollectionRecipesAsync(collectionId, query);
                        combined.AddRange(collectionResult.Recipes);
                    }
                    catch { /* Continue to next collection */ }
                }
            }

            // 2) Load personal (user's own) recipes
            if (shouldLoadPersonal)
            {
                var userQuery = new GetUserRecipesQuery
                {
                    Search = _searchQuery,
                    PageSize = 50,
                    TagIds = _activeTagIds.Any() ? _activeTagIds : null
                };

                var personalResult = await RecipeService.GetMyRecipesAsync(userQuery);
                combined.AddRange(personalResult.Recipes);
            }

            // 3) Deduplicate by Id (prefer first occurrence)
            var deduped = combined.DistinctBy(r => r.Id);

            // 4) Apply client-side tag filtering for collection recipes
            // (personal recipes are already filtered server-side via TagIds)
            if (_activeTagIds.Any())
            {
                deduped = deduped.Where(r =>
                    r.Tags.Any(t => _activeTagIds.Contains(t.Id)));
            }

            _recipes = deduped.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }


    private async Task OnSearchChanged(string value) { await LoadRecipes(); }
    private void OpenRecipe(Guid id) { Navigation.NavigateTo($"food/{id}"); }

    public void Dispose() { CollectionState.OnActiveFiltersChanged -= OnFiltersChanged; }
}
