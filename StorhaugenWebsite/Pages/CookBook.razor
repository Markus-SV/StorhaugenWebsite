@page "/cookbook"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Models
@inject IUserRecipeService RecipeService
@inject IHouseholdStateService HouseholdState
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IDeviceStateService DeviceState
@inject IApiClient ApiClient
@attribute [Authorize]
@implements IDisposable

<div class="cookbook-header d-flex flex-column gap-3 mb-4">
    <div class="d-flex justify-space-between align-center">
        <MudText Typo="Typo.h4" Style="font-family: 'Fraunces', serif;">Kokebok</MudText>

        @* View Toggle *@
        <div class="view-toggle">
            <button class="view-toggle-btn @(_viewMode == "card" ? "active" : "")" @onclick="@(() => SetViewMode("card"))">
                <MudIcon Icon="@Icons.Material.Rounded.GridView" Size="Size.Small" />
            </button>
            <button class="view-toggle-btn @(_viewMode == "list" ? "active" : "")" @onclick="@(() => SetViewMode("list"))">
                <MudIcon Icon="@Icons.Material.Rounded.ViewList" Size="Size.Small" />
            </button>
        </div>
    </div>

    @* Group Filter (Multi-select) - Only show if user has multiple groups *@
    @if (HouseholdState.UserHouseholds.Count > 1)
    {
        <div class="group-filter-section">
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">Vis fra grupper:</MudText>
            <div class="d-flex gap-2 overflow-x-auto py-1">
                @foreach (var group in HouseholdState.UserHouseholds)
                {
                    <MudChip T="string"
                             Variant="@(HouseholdState.IsGroupActive(group.Id) ? Variant.Filled : Variant.Outlined)"
                             Color="Color.Secondary"
                             OnClick="@(() => ToggleGroup(group.Id))"
                             Icon="@(HouseholdState.IsGroupActive(group.Id) ? Icons.Material.Rounded.CheckCircle : Icons.Material.Rounded.RadioButtonUnchecked)">
                        @group.Name
                    </MudChip>
                }
            </div>
        </div>
    }

    @* Search Bar *@
    <MudTextField @bind-Value="_searchQuery"
                  Placeholder="SÃ¸k i oppskrifter..."
                  Variant="Variant.Outlined"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Rounded.Search"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Class="search-field"
                  Margin="Margin.Dense" />

    @* Recipe Filters *@
    <div class="d-flex gap-2 overflow-x-auto py-1">
        <MudChip T="string" Variant="@(_filterMode == "all" ? Variant.Filled : Variant.Outlined)"
                 Color="Color.Primary" OnClick="@(() => SetFilter("all"))">Alle</MudChip>
        <MudChip T="string" Variant="@(_filterMode == "mine" ? Variant.Filled : Variant.Outlined)"
                 Color="Color.Primary" OnClick="@(() => SetFilter("mine"))">Mine</MudChip>
        <MudChip T="string" Variant="@(_filterMode == "favorites" ? Variant.Filled : Variant.Outlined)"
                 Color="Color.Primary" OnClick="@(() => SetFilter("favorites"))" Icon="@Icons.Material.Rounded.Star">Favoritter</MudChip>
    </div>
</div>

@if (_isLoading)
{
    <div class="d-flex flex-column gap-3">
        @for (int i = 0; i < 4; i++)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="rounded-lg" />
        }
    </div>
}
else if (!_recipes.Any())
{
    <div class="empty-state pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Rounded.MenuBook" Size="Size.Large" Color="Color.Default" />
        <MudText Typo="Typo.h6" Class="mt-3">Ingen oppskrifter funnet</MudText>
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="add">Legg til ny oppskrift</MudButton>
    </div>
}
else
{
    <div class="@(_viewMode == "card" ? "d-flex flex-column gap-4" : "d-flex flex-column gap-2")">
        @foreach (var recipe in _recipes)
        {
            <div class="@(_viewMode == "card" ? "food-card" : "food-list-item") animate-in"
                 @onclick="() => OpenRecipe(recipe.UserRecipeId)">

                @* Image Section *@
                @if (recipe.ImageUrls.Any())
                {
                    <img src="@recipe.ImageUrls.First()" class="@(_viewMode == "card" ? "food-card-image" : "food-list-image")" />
                }
                else
                {
                    <div class="@(_viewMode == "card" ? "food-card-placeholder" : "food-list-placeholder")">
                        <MudIcon Icon="@Icons.Material.Rounded.Restaurant" />
                    </div>
                }

                @* Content Section *@
                <div class="@(_viewMode == "card" ? "food-card-content" : "food-list-content")">
                    <div class="d-flex justify-space-between align-start">
                        <div>
                            <h3 class="@(_viewMode == "card" ? "food-card-title" : "food-list-title")">@recipe.Name</h3>

                            @* Owner / Added By Info *@
                            <div class="d-flex align-center gap-1 mt-1">
                                <MudIcon Icon="@Icons.Material.Rounded.Person" Size="Size.Small" Style="font-size: 12px; opacity: 0.7;" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(recipe.OwnerDisplayName == AuthService.CurrentUserName ? "Deg" : recipe.OwnerDisplayName)
                                </MudText>
                            </div>
                        </div>

                        @* Rating Badge *@
                        @if (recipe.HouseholdAverageRating > 0)
                        {
                            <span class="rating-badge @GetRatingClass(recipe.HouseholdAverageRating)">
                                <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" Style="font-size: 12px;" />
                                @recipe.HouseholdAverageRating.ToString("0.0")
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    // We use AggregatedRecipeDto to support the merged view
    private List<AggregatedRecipeDto> _recipes = new();
    private bool _isLoading = true;

    // State
    private string _searchQuery = "";
    private string _filterMode = "all"; // all, mine, favorites
    private string _viewMode = "card";
    private Guid? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to group filter changes
        HouseholdState.OnActiveGroupsChanged += OnGroupsChanged;

        await HouseholdState.InitializeAsync();

        // Load view preference
        _viewMode = DeviceState.Settings.ViewMode ?? "card";

        await LoadRecipes();
    }

    private async void OnGroupsChanged()
    {
        await InvokeAsync(async () =>
        {
            await LoadRecipes();
            StateHasChanged();
        });
    }

    private async Task ToggleGroup(Guid groupId)
    {
        HouseholdState.ToggleGroupFilter(groupId);
        // LoadRecipes will be called via OnGroupsChanged event
    }

    private async Task LoadRecipes()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // If user has groups with active filters, fetch from multiple groups
            if (HouseholdState.HasHousehold && HouseholdState.ActiveGroupFilters.Any())
            {
                var query = new GetCombinedRecipesQuery
                {
                    Search = _searchQuery,
                    PageSize = 50,
                    SortDescending = true
                };

                // Apply Filters
                if (_filterMode == "mine")
                {
                    var user = await ApiClient.GetMyProfileAsync();
                    if (user != null) query.FilterByMembers = new List<Guid> { user.Id };
                }
                else if (_filterMode == "favorites")
                {
                    query.MinRating = 8.0; // Show high rated items
                }

                // Use multi-group aggregation
                var result = await RecipeService.GetGroupsCombinedRecipesAsync(
                    HouseholdState.ActiveGroupFilters,
                    query);
                _recipes = result.Recipes;
            }
            else
            {
                // Fallback for users without groups: Get personal recipes only
                var query = new GetUserRecipesQuery { PageSize = 50 };
                var result = await RecipeService.GetMyRecipesAsync(query);

                // Map UserRecipeDto to AggregatedRecipeDto for consistent UI
                _recipes = result.Recipes.Select(r => new AggregatedRecipeDto
                {
                    UserRecipeId = r.Id,
                    Name = r.Name,
                    ImageUrls = r.ImageUrls,
                    HouseholdAverageRating = r.AverageRating,
                    OwnerDisplayName = "Deg"
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading recipes: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SetFilter(string mode)
    {
        _filterMode = mode;
        await LoadRecipes();
    }

    private async Task SetViewMode(string mode)
    {
        _viewMode = mode;
        await DeviceState.SetViewModeAsync(mode);
    }

    private async Task OnSearchChanged(string value)
    {
        await LoadRecipes();
    }

    private void OpenRecipe(Guid id)
    {
        Navigation.NavigateTo($"food/{id}");
    }

    private string GetRatingClass(double rating)
    {
        return rating switch
        {
            >= 8 => "rating-high",
            >= 5 => "rating-medium",
            _ => "rating-low"
        };
    }

    public void Dispose()
    {
        HouseholdState.OnActiveGroupsChanged -= OnGroupsChanged;
    }
}