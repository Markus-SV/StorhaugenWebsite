@page "/cookbook"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Components
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.Shared.Extensions
@using StorhaugenWebsite.Models
@inject IUserRecipeService RecipeService
@inject ICollectionStateService CollectionState
@inject IUserFriendshipService FriendshipService
@inject IAuthService AuthService
@inject IUserColorService UserColorService
@inject IDeviceStateService DeviceState
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@attribute [Authorize]
@implements IDisposable

<div class="cookbook-header d-flex flex-column gap-3 mb-4">

    @* Collection Selection *@
    @if (CollectionState.UserCollections.Any())
    {
        <div class="group-filter-section">
            <div class="horizontal-scroll-container">

                @* Personal pseudo-collection *@
                <div class="group-chip @(_personalActive ? "active" : "")" @onclick="TogglePersonal">
                    @if (_personalActive)
                    {
                        <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                    }
                    <span>Personlig</span>
                </div>

                @foreach (var collection in CollectionState.UserCollections)
                {
                    var isActive = CollectionState.IsCollectionActive(collection.Id);
                    <div class="group-chip @(isActive ? "active" : "")" @onclick="@(() => ToggleCollection(collection.Id))">
                        @if (isActive)
                        {
                            <MudIcon Icon="@Icons.Material.Rounded.Check" Size="Size.Small" Class="mr-1" />
                        }
                        <span>@collection.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    @* Search & Sort *@
    <div class="d-flex gap-2">
        <MudTextField @bind-Value="_searchQuery"
                      Placeholder="Søk..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Rounded.Search"
                      Immediate="true"
                      DebounceInterval="300"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Class="flex-grow-1 search-field"
                      Margin="Margin.Dense" />

        <MudSelect T="string"
                   @bind-Value="_sortBy"
                   AnchorOrigin="Origin.BottomRight"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Class="sort-select"
                   Style="width: 140px;"
                   AdornmentIcon="@Icons.Material.Rounded.Sort">
            <MudSelectItem Value="@("date")">Nyeste</MudSelectItem>
            <MudSelectItem Value="@("rating")">Høyest snitt</MudSelectItem>
            <MudSelectItem Value="@("personal_rating")">Min vurdering</MudSelectItem>
            <MudSelectItem Value="@("name")">Navn (A-Å)</MudSelectItem>
        </MudSelect>
    </div>

    @* Tags *@
    @if (_tags.Any())
    {
        <div class="tag-filter-section mt-1">
            <div class="horizontal-scroll-container">
                @foreach (var tag in _tags)
                {
                    <MudChip T="string"
                             Variant="@(_activeTagIds.Contains(tag.Id) ? Variant.Filled : Variant.Outlined)"
                             Color="Color.Tertiary"
                             OnClick="@(() => ToggleTagFilter(tag.Id))"
                             Size="Size.Small"
                             Style="@(tag.Color != null ? $"--mud-palette-tertiary: {tag.Color};" : "")">
                        @tag.Name
                    </MudChip>
                }
            </div>
        </div>
    }
</div>

@* XFade wrapper (same behavior as Home/ActivityFeed: first-load-only crossfade) *@
<XFade IsLoading="@_isLoading" FirstLoadOnly="true" FadeMs="220">
    <Skeleton>
        <RecipeSkeleton Amount="6" Height="109.11px" />
    </Skeleton>

    <ChildContent>
        @if (!_recipes.Any())
        {
            <div class="empty-state pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Rounded.MenuBook" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Class="mt-3">Ingen oppskrifter funnet</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="add">Legg til ny oppskrift</MudButton>
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-3">
                @foreach (var recipe in _sortedRecipes)
                {
                    <div class="food-card" @key="recipe.Id" @onclick="() => OpenRecipe(recipe.Id)">

                        @* Image Section (Right Side) *@
                        @if (recipe.ImageUrls.Any())
                        {
                            <img src="@recipe.ImageUrls.First()" class="food-card-image" />
                        }
                        else
                        {
                            <div class="food-card-placeholder">
                                <MudIcon Icon="@Icons.Material.Rounded.Restaurant" Size="Size.Large" Style="opacity:0.3;" />
                            </div>
                        }

                        @* Content Section (Left Side) *@
                        <div class="food-card-content">

                            @* Top Row *@
                            <div class="d-flex justify-space-between align-start">
                                <div style="min-width: 0; padding-right: 8px;">
                                    <div class="d-flex align-center gap-1 mb-1">
                                        @if (recipe.IsHellofresh)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.LocalDining" Size="Size.Small" Color="Color.Success" Title="HelloFresh" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        @if (recipe.IsPublished)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.Cloud" Size="Size.Small" Color="Color.Info" Title="Publisert" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        @if (recipe.IsLinkedToGlobal && !recipe.IsHellofresh)
                                        {
                                            <MudIcon Icon="@Icons.Material.Rounded.Link" Size="Size.Small" Color="Color.Secondary" Title="Koblet" Style="flex-shrink: 0; font-size: 14px;" />
                                        }
                                        <h3 class="food-card-title text-truncate">@recipe.Name</h3>
                                    </div>

                                    <div style="display:flex; gap:4px">

                                        @if (recipe.PrepTimeMinutes.HasValue || !string.IsNullOrEmpty(recipe.Difficulty))
                                        {
                                            <div class="d-flex align-center flex-wrap gap-1">
                                                @if (!string.IsNullOrEmpty(recipe.Difficulty))
                                                {
                                                    <span class="meta-chip @GetDifficultyClass(recipe.Difficulty)">
                                                        <MudIcon Icon="@GetDifficultyIcon(recipe.Difficulty)" Size="Size.Small" />
                                                        @GetDifficultyLabel(recipe.Difficulty)
                                                    </span>
                                                }
                                                @if (recipe.PrepTimeMinutes.HasValue)
                                                {
                                                    <span class="meta-chip">
                                                        <MudIcon Icon="@Icons.Material.Rounded.AccessTime" Size="Size.Small" />
                                                        @recipe.PrepTimeMinutes min
                                                    </span>
                                                }
                                            </div>
                                        }

                                        <div class="d-flex align-center gap-1">
                                            <MudIcon Icon="@Icons.Material.Rounded.Person" Size="Size.Small" Color="Color.Default" />
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate" Style="font-size:0.7rem;">
                                                @(recipe.UserDisplayName == AuthService.CurrentUserName ? "Meg" : recipe.UserDisplayName)
                                            </MudText>
                                        </div>
                                    </div>
                                </div>

                                @* Right: Average Badge *@
                                @if (recipe.AverageRating > 0)
                                {
                                    <div class="d-flex flex-column align-end" style="flex-shrink:0;">
                                        <span class="rating-badge" style="color:@recipe.AverageRating.ToRatingColorHex();">
                                            <MudIcon Icon="@Icons.Material.Rounded.Star" Size="Size.Small" Style="font-size:14px; margin-right:2px;" />
                                            @recipe.AverageRating.ToString("0.0")
                                        </span>

                                        @if (recipe.RatingCount > 0)
                                        {
                                            <span class="rating-count-badge">
                                                <MudIcon Icon="@Icons.Material.Rounded.People" Size="Size.Small" Style="font-size:10px;" />
                                                @recipe.RatingCount
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            @* Ratings Section *@
                            <div class="d-flex align-center flex-wrap mt-2 gap-2">
                                @if (recipe.MyRating.HasValue)
                                {
                                    <div class="rating-pill mine">
                                        <div class="rating-circle" style="background-color:var(--mud-palette-primary); color:var(--mud-palette-primary-text);">
                                            D
                                        </div>
                                        <span class="rating-score">@recipe.MyRating?.ToString("0.0")</span>
                                    </div>
                                }

                                @{
                                    var otherRatings = (recipe.MemberRatings ?? new Dictionary<string, decimal?>())
                                    .Where(r => r.Value.HasValue
                                    && !string.Equals(r.Key, AuthService.CurrentUserName, StringComparison.OrdinalIgnoreCase)
                                    && _allowedRaterNames.Contains(r.Key))
                                    .DistinctBy(r => r.Key)
                                    .Take(4);
                                }

                                @foreach (var rating in otherRatings)
                                {
                                    var initial = !string.IsNullOrEmpty(rating.Key) ? rating.Key.Substring(0, 1).ToUpper() : "?";
                                    <div class="rating-pill">
                                        <div class="rating-circle" style="background-color:@UserColorService.GetUserColor(rating.Key); color:white;">
                                            @initial
                                        </div>
                                        <span class="rating-score">@rating.Value?.ToString("0.0")</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </ChildContent>
</XFade>

@code {
    private const int PersonalPageSize = 100;
    private const int CollectionPageSize = 100;
    private const int CollectionScanPageSize = 200;

    private List<UserRecipeDto> _recipes = new();
    private IEnumerable<UserRecipeDto> _sortedRecipes => GetSortedRecipes();

    private bool _isLoading = true;

    private int _loadVersion;

    private string _searchQuery = "";
    private string _sortBy = "date";
    private List<TagDto> _tags = new();
    private readonly List<Guid> _activeTagIds = new();
    private bool _personalActive = false;
    private readonly HashSet<string> _allowedRaterNames = new();

    protected override async Task OnInitializedAsync()
    {
        CollectionState.OnActiveFiltersChanged += OnFiltersChanged;

        await CollectionState.InitializeAsync();
        await DeviceState.InitializeAsync();

        // Restore saved filter state from device settings
        _personalActive = DeviceState.Settings.CookbookPersonalFilterActive;
        foreach (var collectionId in DeviceState.Settings.CookbookCollectionFilters)
        {
            // Only activate if user still has access to this collection
            if (CollectionState.UserCollections.Any(c => c.Id == collectionId))
            {
                CollectionState.SetCollectionFilter(collectionId, true);
            }
        }

        await LoadAllowedRaters();
        await LoadTags();

        await LoadRecipes();
    }

    private async Task TogglePersonal()
    {
        _personalActive = !_personalActive;
        await SaveFiltersToDevice();
        await LoadRecipes();
    }

    private void ToggleCollection(Guid collectionId)
    {
        CollectionState.ToggleCollectionFilter(collectionId);
        _ = SaveFiltersToDevice();
    }

    private async Task SaveFiltersToDevice()
    {
        var activeCollections = CollectionState.ActiveCollectionFilters.ToList();
        await DeviceState.SetCookbookFiltersAsync(activeCollections, _personalActive);
    }

    private void OnFiltersChanged()
    {
        _ = InvokeAsync(async () => await LoadRecipes());
    }

    private Task OnSearchChanged(string value) => LoadRecipes();

    private void OpenRecipe(Guid id) => Navigation.NavigateTo($"food/{id}");

    private string GetScoreColor(double score)
    {
        if (score >= 8) return "#4CAF50";
        if (score >= 6) return "#FFC107";
        return "#F44336";
    }

    private async Task LoadTags()
    {
        try
        {
            _tags = await ApiClient.GetMyTagsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
        }
    }

    private async Task ToggleTagFilter(Guid tagId)
    {
        if (_activeTagIds.Contains(tagId)) _activeTagIds.Remove(tagId);
        else _activeTagIds.Add(tagId);

        await LoadRecipes();
    }

    private async Task LoadAllowedRaters()
    {
        _allowedRaterNames.Clear();

        try
        {
            var friendships = await FriendshipService.GetFriendshipsAsync();
            foreach (var friend in friendships.Friends)
            {
                if (!string.IsNullOrEmpty(friend.FriendDisplayName))
                    _allowedRaterNames.Add(friend.FriendDisplayName);
            }

            foreach (var collection in CollectionState.UserCollections)
            {
                try
                {
                    var members = await ApiClient.GetCollectionMembersAsync(collection.Id);
                    foreach (var member in members)
                    {
                        if (!string.IsNullOrEmpty(member.DisplayName))
                            _allowedRaterNames.Add(member.DisplayName);
                    }
                }
                catch { /* ignore per collection */ }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading allowed raters: {ex.Message}");
        }
    }

    private IEnumerable<UserRecipeDto> GetSortedRecipes() => _sortBy switch
    {
        "name" => _recipes.OrderBy(r => r.Name),
        "rating" => _recipes.OrderByDescending(r => r.AverageRating),
        "personal_rating" => _recipes.OrderByDescending(r => r.MyRating ?? 0),
        _ => _recipes.OrderByDescending(r => r.CreatedAt)
    };

    private async Task LoadRecipes()
    {
        var v = ++_loadVersion;

        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var combined = new List<UserRecipeDto>();

            var hasSelectedCollections =
                CollectionState.HasCollections && CollectionState.ActiveCollectionFilters.Any();

            var showOnlyUncategorized = _personalActive && !hasSelectedCollections;
            var shouldLoadPersonal = !hasSelectedCollections || _personalActive;

            if (hasSelectedCollections)
            {
                combined.AddRange(await LoadSelectedCollectionRecipesAsync());
            }

            if (shouldLoadPersonal)
            {
                combined.AddRange(await LoadPersonalRecipesAsync(showOnlyUncategorized));
            }

            var deduped = combined.DistinctBy(r => r.Id);

            if (_activeTagIds.Any())
                deduped = deduped.Where(r => r.Tags.Any(t => _activeTagIds.Contains(t.Id)));

            if (v != _loadVersion) return;

            _recipes = deduped.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            if (v == _loadVersion)
            {
                _isLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task<List<UserRecipeDto>> LoadSelectedCollectionRecipesAsync()
    {
        var list = new List<UserRecipeDto>();

        foreach (var collectionId in CollectionState.ActiveCollectionFilters)
        {
            try
            {
                var query = new GetCollectionRecipesQuery { Search = _searchQuery, PageSize = CollectionPageSize };
                var res = await ApiClient.GetCollectionRecipesAsync(collectionId, query);
                list.AddRange(res.Recipes);
            }
            catch { /* ignore per collection */ }
        }

        return list;
    }

    private async Task<List<UserRecipeDto>> LoadPersonalRecipesAsync(bool showOnlyUncategorized)
    {
        var userQuery = new GetUserRecipesQuery
        {
            Search = _searchQuery,
            PageSize = PersonalPageSize,
            TagIds = _activeTagIds.Any() ? _activeTagIds : null
        };

        var personalResult = await RecipeService.GetMyRecipesAsync(userQuery);

        if (!showOnlyUncategorized)
            return personalResult.Recipes.ToList();

        var inAnyCollection = await GetAllRecipeIdsInCollectionsAsync();
        return personalResult.Recipes.Where(r => !inAnyCollection.Contains(r.Id)).ToList();
    }

    private async Task<HashSet<Guid>> GetAllRecipeIdsInCollectionsAsync()
    {
        var ids = new HashSet<Guid>();

        foreach (var collection in CollectionState.UserCollections)
        {
            try
            {
                var res = await ApiClient.GetCollectionRecipesAsync(
                    collection.Id,
                    new GetCollectionRecipesQuery { PageSize = CollectionScanPageSize });

                foreach (var r in res.Recipes)
                    ids.Add(r.Id);
            }
            catch { /* ignore */ }
        }

        return ids;
    }

    private string GetDifficultyIcon(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" or "lett" => Icons.Material.Rounded.SentimentSatisfied,
        "medium" or "middels" => Icons.Material.Rounded.Psychology,
        "hard" or "vanskelig" => Icons.Material.Rounded.LocalFireDepartment,
        _ => Icons.Material.Rounded.HelpOutline
    };

    private string GetDifficultyLabel(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" => "Lett",
        "medium" => "Middels",
        "hard" => "Vanskelig",
        _ => difficulty ?? ""
    };

    private string GetDifficultyClass(string? difficulty) => difficulty?.ToLower() switch
    {
        "easy" or "lett" => "difficulty-easy",
        "medium" or "middels" => "difficulty-medium",
        "hard" or "vanskelig" => "difficulty-hard",
        _ => ""
    };

    public void Dispose()
    {
        CollectionState.OnActiveFiltersChanged -= OnFiltersChanged;
    }
}
