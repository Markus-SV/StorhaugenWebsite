@page "/collections/{CollectionId:guid}/recipes"
@using Microsoft.AspNetCore.Authorization
@using StorhaugenWebsite.ApiClient
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Components
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<div class="detail-header">
    <button class="detail-back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" />
        Tilbake
    </button>
</div>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_collection == null)
{
    <div class="empty-state pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" Color="Color.Default" />
        <MudText Typo="Typo.h6" Class="mt-3">Fant ikke samlingen</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Samlingen finnes ikke, eller du har ikke tilgang til den.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoBack">
            Tilbake
        </MudButton>
    </div>
}
else
{
    <CollectionRecipesList CollectionId="_collection.Id" Title="@(_collection.Name + " Oppskrifter")" PageSize="50" Members="_collection.Members" />
}

@code {
    [Parameter] public Guid CollectionId { get; set; }

    private CollectionDto? _collection;
    private bool _isLoading = true;
    private string _returnUrl = "collections";

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _returnUrl = query["returnUrl"] ?? $"collections/{CollectionId}";

        await LoadCollection();
    }

    private async Task LoadCollection()
    {
        _isLoading = true;
        try
        {
            _collection = await ApiClient.GetCollectionAsync(CollectionId);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Kunne ikke laste samlingen", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo(_returnUrl);

    private string GetVisibilityIcon(string visibility) => visibility switch
    {
        "public" => Icons.Material.Rounded.Public,
        "friends" => Icons.Material.Rounded.People,
        _ => Icons.Material.Rounded.Lock
    };

    private string GetVisibilityText(string visibility) => visibility switch
    {
        "public" => "Offentlig",
        "friends" => "Venner",
        _ => "Privat"
    };

    private Color GetVisibilityColor(string visibility) => visibility switch
    {
        "public" => Color.Success,
        "friends" => Color.Info,
        _ => Color.Default
    };
}
