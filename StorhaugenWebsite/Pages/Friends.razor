@page "/friends"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using StorhaugenWebsite.Components
@using StorhaugenWebsite.Shared.DTOs
@using StorhaugenWebsite.Services
@using StorhaugenWebsite.ApiClient
@using Microsoft.AspNetCore.Components.Web
@inject IUserFriendshipService FriendshipService
@inject ICollectionStateService CollectionState
@inject IUserColorService UserColorService
@inject IApiClient ApiClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<div class="friends-container">
    @* --- HEADER --- *@
    <div class="d-flex justify-space-between align-center mb-4">
        <h1 class="page-title" style="margin-bottom: 0;">Venner</h1>
        @if (_friends.Any())
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary">@_friends.Count venner</MudText>
        }
    </div>

    @* --- SEARCH BAR --- *@
    <MudTextField @bind-Value="_searchQuery"
                  Placeholder="Søk etter navn eller ID..."
                  Variant="Variant.Outlined"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Rounded.Search"
                  OnKeyUp="OnSearchKeyUp"
                  Immediate="true"
                  DebounceInterval="500"
                  OnDebounceIntervalElapsed="PerformSearch"
                  Class="search-field mb-4"
                  Clearable="true"
                  OnClearButtonClick="@(() => _searchQuery = string.Empty)" />

    <XFade IsLoading="@_isLoading" FirstLoadOnly="true" FadeMs="220">
        <Skeleton>
            <RecipeSkeleton Amount="6" LineAmount="0" Height="69.91px" />
        </Skeleton>

        <ChildContent>
            @* --- SEARCH RESULTS MODE --- *@
            @if (!string.IsNullOrWhiteSpace(_searchQuery))
            {
                <MudText Typo="Typo.subtitle2" Class="mb-2 ml-1" Color="Color.Secondary">Resultater</MudText>

                @if (_searchResults.Any())
                {
                    <div class="d-flex flex-column gap-3">
                        @for (var i = 0; i < _searchResults.Count; i++)
                        {
                            var user = _searchResults[i];

                            <MudPaper Class="pa-3 friend-card friend-card-anim"
                                      Style="@($"--i:{i};")"
                                      Elevation="0"
                                      Outlined="true"
                                      @key="user.Id">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Size="Size.Medium" Style="@($"background-color: {UserColorService.GetUserColor(user.DisplayName)}; color: white;")">
                                        @(user.DisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>
                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">@user.DisplayName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @user.ShareId</MudText>
                                    </div>

                                    @if (user.FriendshipStatus == "friends")
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Rounded.Check">Venn</MudChip>
                                    }
                                    else if (user.FriendshipStatus == "pending_sent")
                                    {
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Text">Venter</MudChip>
                                    }
                                    else if (user.FriendshipStatus == "pending_received")
                                    {
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">Har sendt deg</MudChip>
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Rounded.PersonAdd"
                                                       Color="Color.Primary"
                                                       Variant="Variant.Filled"
                                                       Size="Size.Small"
                                                       OnClick="@(() => SendFriendRequest(user))" />
                                    }
                                </div>
                            </MudPaper>
                        }
                    </div>
                }
                else if (!_isSearching)
                {
                    <div class="empty-state">
                        <MudIcon Icon="@Icons.Material.Rounded.SearchOff" Size="Size.Large" Color="Color.Default" />
                        <MudText Typo="Typo.body1" Class="mt-2">Ingen brukere funnet</MudText>
                    </div>
                }
            }
            else
            {
                @* --- STANDARD LIST MODE --- *@

                @* 1. INCOMING REQUESTS *@
                @if (_pendingReceived.Any())
                {
                    <div class="section-header">
                        <MudIcon Icon="@Icons.Material.Rounded.MarkEmailUnread" Size="Size.Small" Color="Color.Primary" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Forespørsler</MudText>
                    </div>

                    <div class="d-flex flex-column gap-3 mb-6">
                        @for (var i = 0; i < _pendingReceived.Count; i++)
                        {
                            var request = _pendingReceived[i];

                            <MudPaper Class="pa-3 friend-card request-card friend-card-anim"
                                      Style="@($"--i:{i};")"
                                      Elevation="0"
                                      @key="request.Id">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Size="Size.Medium" Style="@($"background-color: {UserColorService.GetUserColor(request.FriendDisplayName)}; color: white;")">
                                        @(request.FriendDisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>
                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@request.FriendDisplayName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Vil bli venn med deg</MudText>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" FullWidth="true"
                                               OnClick="@(() => AcceptRequest(request))">Godta</MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" FullWidth="true"
                                               OnClick="@(() => RejectRequest(request))">Avslå</MudButton>
                                </div>
                            </MudPaper>
                        }
                    </div>
                }

                @* 2. FRIENDS LIST *@
                @if (_friends.Any())
                {
                    <div class="d-flex flex-column gap-3">
                        @for (var i = 0; i < _friends.Count; i++)
                        {
                            var friend = _friends[i];

                            <MudPaper Class="pa-3 friend-card friend-card-anim"
                                      Style="@($"--i:{i};")"
                                      Elevation="0"
                                      @onclick="@(() => OpenFriendProfile(friend))"
                                      @key="friend.FriendUserId">
                                <div class="d-flex align-center gap-3">
                                    <MudAvatar Size="Size.Medium" Variant="Variant.Filled"
                                               Style="@($"background-color: {UserColorService.GetUserColor(friend.FriendDisplayName)}; color: white;")">
                                        @(friend.FriendDisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                    </MudAvatar>
                                    <div class="flex-grow-1">
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">@friend.FriendDisplayName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @friend.RecipeCount oppskrifter
                                        </MudText>
                                    </div>
                                    <MudIcon Icon="@Icons.Material.Rounded.ChevronRight" Color="Color.Default" />
                                </div>
                            </MudPaper>
                        }
                    </div>
                }
                else if (!_pendingReceived.Any() && !_pendingSent.Any())
                {
                    <div class="empty-state mt-8">
                        <MudIcon Icon="@Icons.Material.Rounded.PersonSearch" Size="Size.Large" Color="Color.Default" />
                        <MudText Typo="Typo.h6" Class="mt-2">Ingen venner ennå</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="max-width: 250px;">
                            Søk etter brukernavn eller ID i feltet over for å legge til venner.
                        </MudText>
                    </div>
                }

                @* 3. OUTGOING REQUESTS (Collapsed) *@
                @if (_pendingSent.Any())
                {
                    <MudExpansionPanel Text="@($"Sendte forespørsler ({_pendingSent.Count})")"
                                       Class="mt-6 shadow-none bg-transparent"
                                       DisableGutters="true">
                        <div class="d-flex flex-column gap-3 mt-2">
                            @for (var i = 0; i < _pendingSent.Count; i++)
                            {
                                var request = _pendingSent[i];

                                <MudPaper Class="pa-3 friend-card friend-card-anim"
                                          Style="@($"--i:{i}; opacity: 0.8;")"
                                          Elevation="0"
                                          Outlined="true"
                                          @key="request.Id">
                                    <div class="d-flex align-center gap-3">
                                        <MudAvatar Size="Size.Small"
                                                   Style="@($"background-color: {UserColorService.GetUserColor(request.FriendDisplayName)}; color: white;")">
                                            @(request.FriendDisplayName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                        </MudAvatar>
                                        <div class="flex-grow-1">
                                            <MudText Typo="Typo.body2">@request.FriendDisplayName</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Venter...</MudText>
                                        </div>
                                        <MudIconButton Icon="@Icons.Material.Rounded.Close" Size="Size.Small" OnClick="@(() => CancelRequest(request))" />
                                    </div>
                                </MudPaper>
                            }
                        </div>
                    </MudExpansionPanel>
                }
            }
        </ChildContent>
    </XFade>
</div>

@code {
    private List<UserFriendshipDto> _friends = new();
    private List<UserFriendshipDto> _pendingReceived = new();
    private List<UserFriendshipDto> _pendingSent = new();
    private List<UserSearchResultDto> _searchResults = new();

    private string _searchQuery = "";
    private bool _isLoading = true;
    private bool _isSearching = false;

    protected override async Task OnInitializedAsync()
    {
        await CollectionState.InitializeAsync();
        await LoadFriendships();
    }

    private async Task LoadFriendships()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var friendships = await FriendshipService.GetFriendshipsAsync();
            _friends = friendships.Friends ?? new();
            _pendingReceived = friendships.PendingReceived ?? new();
            _pendingSent = friendships.PendingSent ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke laste venner: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            _searchResults.Clear();
            StateHasChanged();
            return;
        }

        _isSearching = true;
        StateHasChanged();

        try
        {
            _searchResults = await FriendshipService.SearchUsersAsync(_searchQuery);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Søk feilet: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter") await PerformSearch();
    }

    private async Task SendFriendRequest(UserSearchResultDto user)
    {
        try
        {
            await FriendshipService.SendFriendRequestAsync(user.Id);
            user.FriendshipStatus = "pending_sent";
            Snackbar.Add($"Forespørsel sendt til {user.DisplayName}", Severity.Success);
            _ = LoadFriendships();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunne ikke sende forespørsel: {ex.Message}", Severity.Error);
        }
    }

    private async Task AcceptRequest(UserFriendshipDto request)
    {
        try
        {
            await FriendshipService.AcceptFriendRequestAsync(request.Id);
            Snackbar.Add($"Du er nå venn med {request.FriendDisplayName}!", Severity.Success);
            await LoadFriendships();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectRequest(UserFriendshipDto request)
    {
        try
        {
            await FriendshipService.RejectFriendRequestAsync(request.Id);
            _pendingReceived.Remove(request);
            StateHasChanged();
        }
        catch
        {
            Snackbar.Add("Kunne ikke avslå", Severity.Error);
        }
    }

    private async Task CancelRequest(UserFriendshipDto request)
    {
        try
        {
            await FriendshipService.RemoveFriendAsync(request.Id);
            _pendingSent.Remove(request);
            StateHasChanged();
            Snackbar.Add("Forespørsel kansellert", Severity.Info);
        }
        catch
        {
            Snackbar.Add("Kunne ikke kansellere", Severity.Error);
        }
    }

    private void OpenFriendProfile(UserFriendshipDto friend)
    {
        Navigation.NavigateTo($"friends/{friend.FriendUserId}");
    }
}
